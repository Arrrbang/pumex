<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>SOS 요금 조회</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../common/header/header.css">
  <link rel="stylesheet" href="../sos.css">

</head>
<body>
<div id="header-placeholder"></div>
  


    <!-- 달력 -->
  <div class="sos-layout">
      <div class="calendar">
        <div class="cal-header">
          <button type="button" id="btnPrevMonth">◀</button>
          <h2 id="calTitle"></h2>
          <button type="button" id="btnNextMonth">▶</button>
        </div>
        <div class="cal-grid" id="calGrid">
          <!-- JS가 요일 헤더 + 날짜 채움 -->
        </div>
        <div class="notice-section">
          <div class="nt-table">
            <div class="nt-head">
              <div class="nt-col-bound">BOUND</div>
              <div class="nt-col-title">공지사항</div>
            </div>
            <div id="noticeListBody">
              <div style="padding:1rem; text-align:center; color:#999;">로딩 중...</div>
            </div>
          </div>
        </div>
      </div>

    <div class="vertical-divider"></div>

    <div class="sos-wrap">
      <h1 class="sos-title">INBOUND SOS 계산</h1>
      <div class="sos-divider"></div>
      <!-- 컨트롤 -->
      <div class="controls">
        <div class="field">
          <label for="dateInput">작업일</label>
          <input id="dateInput" type="date" />
        </div>

        <div class="field">
          <label for="typeSelect">타입</label>
          <select id="typeSelect">
            <option value="CONSOLE">CONSOLE</option>
            <option value="20DRY">20DRY</option>
            <option value="40HC">40HC</option>
          </select>
        </div>

        <div class="field">
          <label for="cbmComboInput">CBM</label>
          <div class="combo" id="cbmCombo">
            <input type="text" id="cbmComboInput" placeholder="CBM 입력 또는 선택" autocomplete="off">
          </div>
        </div>
      </div>

      <div class="deduct-section" id="deductSection">
        <div class="deduct-row">
          <button type="button" class="deduct-add-btn" id="btnAddDeduct">+</button>
          <input
            type="text"
            class="deduct-input"
            placeholder="도급비 입력"
          />
        </div>
      </div>

      <button class="btn" id="btnFetch">조회</button>

      <div class="result" id="resultBox" hidden>
        <div id="resultDesc"></div>
        <div id="resultRemarks" style="color:#e11d48; margin-top:0.4rem; font-weight:600; font-size:0.95rem; display:none;"></div>
        <div id="resultOriginal"></div>
        <div class="value" id="resultValue"></div>
        <div id="resultExtra"></div>
      </div>
    </div>
  </div>

<div id="noticeModal" class="sos-modal-overlay">
  <div class="sos-modal-window">
    <div class="sos-modal-header">
      <div class="sos-modal-title-area">
        <h3 id="popupTitle">제목</h3>
        <div class="sos-modal-meta">
          <span id="popupBound" class="badge-bound">BOUND</span>
          <span id="popupPeriod">기간: - </span>
        </div>
      </div>
      <button id="btnCloseModal" class="sos-modal-close">&times;</button>
    </div>
    <div id="popupBody" class="sos-modal-body">
      </div>
  </div>
</div>

<script src="https://arrrbang.github.io/pumex/common/js/loading.js"></script>
<script src="../../common/js/login.js"></script>

  <script>
    // ───────────────────────── 공휴일 + 달력 렌더 ─────────────────────────
    const API_BASE = "https://notion-api-hub.vercel.app";
    const calGrid   = document.getElementById('calGrid');
    const calTitle  = document.getElementById('calTitle');
    const dateInput = document.getElementById('dateInput');
    const statusEl  = document.getElementById('dateStatus');

    const today     = new Date();
    let currentYear = today.getFullYear();
    let currentMonth= today.getMonth(); // 0=Jan
    let selectedDateStr = null;         // "YYYY-MM-DD"
    const holidaySets = {};             // { [year]: Set<'YYYY-MM-DD'> }

    const KR_HOLIDAY_API = 'https://date.nager.at/api/v3/PublicHolidays';

    async function loadHolidaySet(year){
      if (holidaySets[year]) return holidaySets[year];
      const res = await fetch(`${KR_HOLIDAY_API}/${year}/KR`);
      if (!res.ok) {
        holidaySets[year] = new Set();
        return holidaySets[year];
      }
      const data = await res.json();
      const set = new Set(data.map(h => h.date));
      holidaySets[year] = set;
      return set;
    }

    function formatDate(y,m,d){
      const mm = String(m+1).padStart(2,'0');
      const dd = String(d).padStart(2,'0');
      return `${y}-${mm}-${dd}`;
    }

    function isWeekendKST(y, monthIndex, d) {
      // y: 연도, monthIndex: 0~11, d: 일
      const dt = new Date(y, monthIndex, d); // 로컬 타임존 기준
      const day = dt.getDay();               // 0=일, 6=토 (로컬 기준)
      return day === 0 || day === 6;
    }

    async function renderCalendar(){
      const year = currentYear;
      const month= currentMonth;

      const holidaySet = await loadHolidaySet(year);

      calGrid.innerHTML = '';

      // 요일 헤더
      const dayNames = ['일','월','화','수','목','금','토'];
      dayNames.forEach((name,idx)=>{
        const div = document.createElement('div');
        div.textContent = name;
        div.className = 'cal-day-name' + (idx===0 || idx===6 ? ' weekend':'');
        calGrid.appendChild(div);
      });

      // 해당 월 1일 요일
      const firstDate = new Date(year, month, 1);
      const firstDay  = firstDate.getDay();   // 0~6
      const daysInMonth = new Date(year, month+1, 0).getDate();

      // 이전 달 공백
      for(let i=0;i<firstDay;i++){
        const cell = document.createElement('div');
        cell.className = 'cal-cell empty';
        calGrid.appendChild(cell);
      }

      for(let d=1; d<=daysInMonth; d++){
        const cell = document.createElement('div');
        const dateStr = formatDate(year, month, d);
        cell.textContent = d;
        cell.className = 'cal-cell';

        const weekend = isWeekendKST(year, month, d);
        const holiday = holidaySet.has(dateStr);

        if (weekend) cell.classList.add('weekend');
        if (holiday) cell.classList.add('holiday');
        if (selectedDateStr === dateStr) cell.classList.add('selected');

        cell.dataset.date = dateStr;
        cell.addEventListener('click', ()=>{
          selectedDateStr = dateStr;
          dateInput.value = dateStr;
          updateStatus();
          renderCalendar(); // 다시 렌더해서 선택 표시
        });

        calGrid.appendChild(cell);
      }

      calTitle.textContent = `${year}년 ${month+1}월`;
    }

      function updateStatus(){      
        const [y,m,d] = selectedDateStr.split('-').map(Number);
        const weekend = isWeekendKST(y, m-1, d);
      
        const year = String(y);
        const set  = holidaySets[year];              // Nager.Date로 받아온 공휴일 세트
        const isHoliday = set ? set.has(selectedDateStr) : false;
      
        const isOffDay = weekend || isHoliday;       // ⭐ 토/일 + 법정 공휴일 = 전부 주말 취급
      
      }


    document.getElementById('btnPrevMonth').addEventListener('click', ()=>{
      currentMonth--;
      if (currentMonth < 0){ currentMonth = 11; currentYear--; }
      renderCalendar();
    });
    document.getElementById('btnNextMonth').addEventListener('click', ()=>{
      currentMonth++;
      if (currentMonth > 11){ currentMonth = 0; currentYear++; }
      renderCalendar();
    });

    dateInput.addEventListener('change', ()=>{
      selectedDateStr = dateInput.value || null;
      if (selectedDateStr) {
        const dt = new Date(selectedDateStr + "T00:00:00");
        currentYear  = dt.getFullYear();
        currentMonth = dt.getMonth();
      }
      updateStatus();
      renderCalendar();
    });

    // 초기 날짜
    selectedDateStr = formatDate(today.getFullYear(), today.getMonth(), today.getDate());
    dateInput.value = selectedDateStr;
    updateStatus();
    renderCalendar();

    // ───────────────────────── CBM 콤보박스 로직 ─────────────────────────
    const cbmInput = document.getElementById('cbmComboInput');
    cbmInput.addEventListener('input', () => {
      cbmInput.value = cbmInput.value.replace(/[^0-9.]/g, '');
    });
    // CBM 1~80 리스트 생성
    const cbmArray = [];
    for (let i = 1; i <= 80; i++) cbmArray.push(i);

    // 입력 시 자동 필터링
    cbmInput.addEventListener('input', () => {
      const text = cbmInput.value.trim();
      renderCbmList(text);

      // 숫자 정확히 입력 시 자동 선택
      const num = Number(text);
      if (num >= 1 && num <= 80) {
        cbmInput.value = num;
      }
    });


    // ───────────────────────── 차감 입력 컨테이너 로직 ─────────────────────────
    const deductSection = document.getElementById('deductSection');
    const btnAddDeduct  = document.getElementById('btnAddDeduct');

    // 숫자 입력을 천단위 콤마로 포맷하는 함수
    function formatNumberWithCommas(value){
      const onlyDigits = value.replace(/[^\d]/g, '');  // 숫자만 남기기
      if (!onlyDigits) return '';
      const num = Number(onlyDigits);
      if (Number.isNaN(num)) return '';
      return num.toLocaleString('ko-KR');
    }

    // input 요소에 포맷 이벤트 바인딩
    function attachFormatHandler(input){
      input.addEventListener('input', () => {
        const cursorToEnd = document.activeElement === input;
        const formatted = formatNumberWithCommas(input.value);
        input.value = formatted;
        if (cursorToEnd) {
          // 커서는 맨 끝으로 가지만, 이 정도는 UX상 크게 문제 안 됨
          input.selectionStart = input.selectionEnd = input.value.length;
        }
      });
    }

    // 새 차감 줄 생성 ( - 버튼 포함 )
    function createDeductRow(){
      const row = document.createElement('div');
      row.className = 'deduct-row';

      const minusBtn = document.createElement('button');
      minusBtn.type = 'button';
      minusBtn.className = 'deduct-remove-btn';
      minusBtn.textContent = '−';   // 조금 예쁜 마이너스

      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'deduct-input';
      input.placeholder = '도급비 입력';

      attachFormatHandler(input);

      minusBtn.addEventListener('click', () => {
        deductSection.removeChild(row);
      });

      row.appendChild(minusBtn);
      row.appendChild(input);

      deductSection.appendChild(row);
    }

    // 첫 줄 input에도 포맷 핸들러 연결
    const firstDeductInput = deductSection.querySelector('.deduct-input');
    if (firstDeductInput) attachFormatHandler(firstDeductInput);

    // + 버튼 눌렀을 때 새 줄 추가
    btnAddDeduct.addEventListener('click', () => {
      createDeductRow();
    });


    // ───────────────────────── 조회 버튼: /api/sos-rate 호출 ─────────────────────────
    const typeSelect = document.getElementById('typeSelect');
    const btnFetch   = document.getElementById('btnFetch');
    const resultBox  = document.getElementById('resultBox');
    const resultDesc = document.getElementById('resultDesc');
    const resultRemarks = document.getElementById('resultRemarks');
    const resultOriginal = document.getElementById('resultOriginal');
    const resultVal  = document.getElementById('resultValue');
    const resultExtra= document.getElementById('resultExtra');

    btnFetch.addEventListener('click', async ()=>{
      if (!selectedDateStr){
        alert('날짜를 먼저 선택해 주세요.');
        return;
      }
      const type = typeSelect.value;
      const cbm  = cbmInput.value;

      btnFetch.disabled = true;
      btnFetch.textContent = '조회중...';
    
      try{
        const params = new URLSearchParams({ date:selectedDateStr, type, cbm });
        // INBOUND 주소 확인
        const res = await fetch(`${API_BASE}/api/sos-rate/inbound?${params.toString()}`);
        const data = await res.json();

        if (!res.ok || !data.ok){
          alert(data.error || '조회 실패');
          resultBox.hidden = true;
        } else {
          resultBox.hidden = false;

          resultDesc.textContent =
            `${data.input.date} / ${data.input.weekdayType} / ${type} / ${cbm} CBM`;

          // ▼▼▼ [추가] 특이사항 표시 로직 ▼▼▼
          if (data.match.remarks) {
            resultRemarks.textContent = `※ ${data.match.remarks}`;
            resultRemarks.style.display = 'block';
          } else {
            resultRemarks.textContent = '';
            resultRemarks.style.display = 'none';
          }
          // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

          const v = data.match.value;

          if (v == null){
            resultVal.textContent = '값 없음';
            resultOriginal.textContent = '';
          } else {
            let deductionTotal = 0;
            document.querySelectorAll('.deduct-input').forEach(input => {
              const cleaned = input.value.replace(/,/g, '').trim();
              if (cleaned){
                const n = Number(cleaned);
                if (!Number.isNaN(n)) deductionTotal += n;
              }
            });

            const finalValue = v - deductionTotal;

            const originalStr  = v.toLocaleString('ko-KR');
            const deductionStr = deductionTotal.toLocaleString('ko-KR');
            const finalStr     = finalValue.toLocaleString('ko-KR');

            resultOriginal.textContent =
              `(원본) ${originalStr} - (도급비) ${deductionStr} =`;

            resultVal.textContent = `${finalStr} 원`;
          }
          resultExtra.textContent = data.match.extra ? `메모: ${data.match.extra}` : '';
        }
      }catch(e){
        console.error(e);
        alert('조회 중 오류가 발생했습니다.');
      }finally{
        btnFetch.disabled = false;
        btnFetch.textContent = '조회';
      }
    });

// ───────────────────────── 공지사항 (Notion) 로직 ─────────────────────────
    const noticeListBody = document.getElementById('noticeListBody');
    const noticeModal    = document.getElementById('noticeModal');
    const btnCloseModal  = document.getElementById('btnCloseModal');
    
    // 팝업 요소들
    const popupTitle  = document.getElementById('popupTitle');
    const popupBound  = document.getElementById('popupBound');
    const popupPeriod = document.getElementById('popupPeriod');
    const popupBody   = document.getElementById('popupBody');

    // 1. 공지사항 데이터 가져오기
    async function fetchNotices() {
      try {
        const res = await fetch(`${API_BASE}/api/sos/notice`); // 백엔드 라우트
        const json = await res.json();
        
        if (!json.ok) {
          noticeListBody.innerHTML = '<div style="padding:0.5rem; text-align:center;">불러오기 실패</div>';
          return;
        }

        renderNoticeList(json.data);
      } catch (e) {
        console.error(e);
        noticeListBody.innerHTML = '<div style="padding:0.5rem; text-align:center;">오류 발생</div>';
      }
    }

  // 2. 리스트 렌더링 (수정됨)
      function renderNoticeList(notices) {
        noticeListBody.innerHTML = ''; // 초기화

        // ▼▼ [수정] 필터링 로직 추가: ALLBOUND 또는 OUTBOUND인 것만 남김 ▼▼
        const filteredNotices = notices.filter(item => 
          item.bound === 'ALLBOUND' || item.bound === 'INBOUND'
        );

        if (filteredNotices.length === 0) {
          noticeListBody.innerHTML = '<div style="padding:1rem; text-align:center; color:#999;">해당하는 공지가 없습니다.</div>';
          return;
        }

        // 필터링된 목록으로 루프 실행
        filteredNotices.forEach(item => {
          const row = document.createElement('div');
          row.className = 'nt-row';

          // BOUND 열
          const colBound = document.createElement('div');
          colBound.className = 'nt-col-bound';
          colBound.textContent = item.bound || '-';
          
          // 제목 열
          const colTitle = document.createElement('div');
          colTitle.className = 'nt-col-title';
          colTitle.textContent = item.title;
          
          // 클릭 이벤트 (팝업 오픈)
          colTitle.addEventListener('click', () => openNoticePopup(item));

          row.appendChild(colBound);
          row.appendChild(colTitle);
          noticeListBody.appendChild(row);
        });
      }

    // 3. 팝업 열기
    function openNoticePopup(item) {
      popupTitle.textContent = item.title;
      popupBound.textContent = item.bound || 'ALL';
      
      const start = item.startDate || '';
      const end   = item.endDate || '';
      if(start && end) popupPeriod.textContent = `기간: ${start} ~ ${end}`;
      else if(start)   popupPeriod.textContent = `기간: ${start} ~`;
      else             popupPeriod.textContent = `기간: 상시`;

      // 본문 렌더링 (Notion Blocks -> HTML)
      popupBody.innerHTML = '';
      if (item.content && item.content.length > 0) {
        item.content.forEach(block => {
          const htmlElement = createBlockElement(block);
          if(htmlElement) popupBody.appendChild(htmlElement);
        });
      } else {
        popupBody.textContent = '내용이 없습니다.';
      }

      noticeModal.classList.add('open');
    }

    // 4. Notion Block -> HTML 변환 헬퍼
    function createBlockElement(block) {
      const type = block.type;
      const data = block[type]; // paragraph, heading_1 등등

      // 텍스트 내용 추출 (rich_text 배열 합치기)
      let textContent = "";
      if (data.rich_text) {
        textContent = data.rich_text.map(t => t.plain_text).join("");
        // *심화: 여기서 bold, color 처리도 가능하지만 일단 plain_text만
      }

      // 태그 생성
      if (type === 'paragraph') {
        const p = document.createElement('p');
        p.className = 'notion-p';
        p.textContent = textContent || '\u00A0'; // 빈 줄 처리
        return p;
      } 
      else if (type === 'heading_1') {
        const h = document.createElement('h1');
        h.className = 'notion-h1';
        h.textContent = textContent;
        return h;
      }
      else if (type === 'heading_2') {
        const h = document.createElement('h2');
        h.className = 'notion-h2';
        h.textContent = textContent;
        return h;
      }
      else if (type === 'heading_3') {
        const h = document.createElement('h3');
        h.className = 'notion-h3';
        h.textContent = textContent;
        return h;
      }
      else if (type === 'bulleted_list_item') {
        const li = document.createElement('li');
        li.className = 'notion-li';
        li.textContent = textContent;
        // 원래 ul/ol 감싸야 하지만 약식으로 div 처리하거나, CSS로 처리
        // 여기서는 간단히 li만 리턴하고 부모가 없으면 div처럼 보임
        // *제대로 하려면 이전 형제가 ul인지 체크해야 함. 일단 간단히 bullet 처리
        li.style.listStyleType = 'disc';
        li.style.marginLeft = '1.2rem';
        return li;
      }
      else if (type === 'numbered_list_item') {
        const li = document.createElement('li');
        li.className = 'notion-li';
        li.textContent = textContent;
        li.style.listStyleType = 'decimal';
        li.style.marginLeft = '1.2rem';
        return li;
      }
      else if (type === 'divider') {
        const hr = document.createElement('hr');
        hr.className = 'notion-hr';
        return hr;
      }

      return null; // 지원하지 않는 블록은 패스
    }

    // 5. 팝업 닫기
    btnCloseModal.addEventListener('click', () => {
      noticeModal.classList.remove('open');
    });
    // 배경 클릭 시 닫기
    noticeModal.addEventListener('click', (e) => {
      if (e.target === noticeModal) {
        noticeModal.classList.remove('open');
      }
    });

    // 실행: 페이지 로드 시 공지사항 불러오기
    fetchNotices();
  </script>
</body>
</html>

