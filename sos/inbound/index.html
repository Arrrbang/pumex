<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>SOS ìš”ê¸ˆ ì¡°íšŒ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../common/header/header.css">
  <link rel="stylesheet" href="../sos.css">

</head>
<body>
<div id="header-placeholder"></div>
  


    <!-- ë‹¬ë ¥ -->
  <div class="sos-layout">
      <div class="calendar">
        <div class="cal-header">
          <button type="button" id="btnPrevMonth">â—€</button>
          <h2 id="calTitle"></h2>
          <button type="button" id="btnNextMonth">â–¶</button>
        </div>
        <div class="cal-grid" id="calGrid">
          <!-- JSê°€ ìš”ì¼ í—¤ë” + ë‚ ì§œ ì±„ì›€ -->
        </div>
      </div>

    <div class="vertical-divider"></div>

    <div class="sos-wrap">
      <h1 class="sos-title">INBOUND SOS ê³„ì‚°</h1>
      <div class="sos-divider"></div>
      <!-- ì»¨íŠ¸ë¡¤ -->
      <div class="controls">
        <div class="field">
          <label for="dateInput">ì‘ì—…ì¼</label>
          <input id="dateInput" type="date" />
        </div>

        <div class="field">
          <label for="typeSelect">íƒ€ì…</label>
          <select id="typeSelect">
            <option value="CONSOLE">CONSOLE</option>
            <option value="20DRY">20DRY</option>
            <option value="40HC">40HC</option>
          </select>
        </div>

        <div class="field">
          <label for="cbmComboInput">CBM</label>
          <div class="combo" id="cbmCombo">
            <input type="text" id="cbmComboInput" placeholder="CBM ì…ë ¥ ë˜ëŠ” ì„ íƒ" autocomplete="off">
          </div>
        </div>
      </div>

      <div class="deduct-section" id="deductSection">
        <div class="deduct-row">
          <button type="button" class="deduct-add-btn" id="btnAddDeduct">+</button>
          <input
            type="text"
            class="deduct-input"
            placeholder="ë„ê¸‰ë¹„ ì…ë ¥"
          />
        </div>
      </div>

      <button class="btn" id="btnFetch">ì¡°íšŒ</button>

      <div class="result" id="resultBox" hidden>
        <div id="resultDesc"></div>
          <div id="resultOriginal"></div>
        <div class="value" id="resultValue"></div>
        <div id="resultExtra"></div>
      </div>
    </div>
  </div>


<script>
  fetch('../../common/header/header.html')
    .then(res => res.text())
    .then(html => {
      document.getElementById('header-placeholder').innerHTML = html;

      if (window.setActiveHeaderMenu) {
        window.setActiveHeaderMenu();
      }
    })
    .catch(err => console.error('Header load error:', err));
</script>
<script src="../../common/header/header.js"></script>
<script src="../../common/js/login.js"></script>

  <script>
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ê³µíœ´ì¼ + ë‹¬ë ¥ ë Œë” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const API_BASE = "https://notion-api-hub.vercel.app";
    const calGrid   = document.getElementById('calGrid');
    const calTitle  = document.getElementById('calTitle');
    const dateInput = document.getElementById('dateInput');
    const statusEl  = document.getElementById('dateStatus');

    const today     = new Date();
    let currentYear = today.getFullYear();
    let currentMonth= today.getMonth(); // 0=Jan
    let selectedDateStr = null;         // "YYYY-MM-DD"
    const holidaySets = {};             // { [year]: Set<'YYYY-MM-DD'> }

    const KR_HOLIDAY_API = 'https://date.nager.at/api/v3/PublicHolidays';

    async function loadHolidaySet(year){
      if (holidaySets[year]) return holidaySets[year];
      const res = await fetch(`${KR_HOLIDAY_API}/${year}/KR`);
      if (!res.ok) {
        holidaySets[year] = new Set();
        return holidaySets[year];
      }
      const data = await res.json();
      const set = new Set(data.map(h => h.date));
      holidaySets[year] = set;
      return set;
    }

    function formatDate(y,m,d){
      const mm = String(m+1).padStart(2,'0');
      const dd = String(d).padStart(2,'0');
      return `${y}-${mm}-${dd}`;
    }

    function isWeekendKST(y, monthIndex, d) {
      // y: ì—°ë„, monthIndex: 0~11, d: ì¼
      const dt = new Date(y, monthIndex, d); // ë¡œì»¬ íƒ€ì„ì¡´ ê¸°ì¤€
      const day = dt.getDay();               // 0=ì¼, 6=í†  (ë¡œì»¬ ê¸°ì¤€)
      return day === 0 || day === 6;
    }

    async function renderCalendar(){
      const year = currentYear;
      const month= currentMonth;

      const holidaySet = await loadHolidaySet(year);

      calGrid.innerHTML = '';

      // ìš”ì¼ í—¤ë”
      const dayNames = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
      dayNames.forEach((name,idx)=>{
        const div = document.createElement('div');
        div.textContent = name;
        div.className = 'cal-day-name' + (idx===0 || idx===6 ? ' weekend':'');
        calGrid.appendChild(div);
      });

      // í•´ë‹¹ ì›” 1ì¼ ìš”ì¼
      const firstDate = new Date(year, month, 1);
      const firstDay  = firstDate.getDay();   // 0~6
      const daysInMonth = new Date(year, month+1, 0).getDate();

      // ì´ì „ ë‹¬ ê³µë°±
      for(let i=0;i<firstDay;i++){
        const cell = document.createElement('div');
        cell.className = 'cal-cell empty';
        calGrid.appendChild(cell);
      }

      for(let d=1; d<=daysInMonth; d++){
        const cell = document.createElement('div');
        const dateStr = formatDate(year, month, d);
        cell.textContent = d;
        cell.className = 'cal-cell';

        const weekend = isWeekendKST(year, month, d);
        const holiday = holidaySet.has(dateStr);

        if (weekend) cell.classList.add('weekend');
        if (holiday) cell.classList.add('holiday');
        if (selectedDateStr === dateStr) cell.classList.add('selected');

        cell.dataset.date = dateStr;
        cell.addEventListener('click', ()=>{
          selectedDateStr = dateStr;
          dateInput.value = dateStr;
          updateStatus();
          renderCalendar(); // ë‹¤ì‹œ ë Œë”í•´ì„œ ì„ íƒ í‘œì‹œ
        });

        calGrid.appendChild(cell);
      }

      calTitle.textContent = `${year}ë…„ ${month+1}ì›”`;
    }

      function updateStatus(){      
        const [y,m,d] = selectedDateStr.split('-').map(Number);
        const weekend = isWeekendKST(y, m-1, d);
      
        const year = String(y);
        const set  = holidaySets[year];              // Nager.Dateë¡œ ë°›ì•„ì˜¨ ê³µíœ´ì¼ ì„¸íŠ¸
        const isHoliday = set ? set.has(selectedDateStr) : false;
      
        const isOffDay = weekend || isHoliday;       // â­ í† /ì¼ + ë²•ì • ê³µíœ´ì¼ = ì „ë¶€ ì£¼ë§ ì·¨ê¸‰
      
      }


    document.getElementById('btnPrevMonth').addEventListener('click', ()=>{
      currentMonth--;
      if (currentMonth < 0){ currentMonth = 11; currentYear--; }
      renderCalendar();
    });
    document.getElementById('btnNextMonth').addEventListener('click', ()=>{
      currentMonth++;
      if (currentMonth > 11){ currentMonth = 0; currentYear++; }
      renderCalendar();
    });

    dateInput.addEventListener('change', ()=>{
      selectedDateStr = dateInput.value || null;
      if (selectedDateStr) {
        const dt = new Date(selectedDateStr + "T00:00:00");
        currentYear  = dt.getFullYear();
        currentMonth = dt.getMonth();
      }
      updateStatus();
      renderCalendar();
    });

    // ì´ˆê¸° ë‚ ì§œ
    selectedDateStr = formatDate(today.getFullYear(), today.getMonth(), today.getDate());
    dateInput.value = selectedDateStr;
    updateStatus();
    renderCalendar();

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ CBM ì½¤ë³´ë°•ìŠ¤ ë¡œì§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const cbmInput = document.getElementById('cbmComboInput');
    cbmInput.addEventListener('input', () => {
      cbmInput.value = cbmInput.value.replace(/[^0-9.]/g, '');
    });
    // CBM 1~80 ë¦¬ìŠ¤íŠ¸ ìƒì„±
    const cbmArray = [];
    for (let i = 1; i <= 80; i++) cbmArray.push(i);

    // ì…ë ¥ ì‹œ ìë™ í•„í„°ë§
    cbmInput.addEventListener('input', () => {
      const text = cbmInput.value.trim();
      renderCbmList(text);

      // ìˆ«ì ì •í™•íˆ ì…ë ¥ ì‹œ ìë™ ì„ íƒ
      const num = Number(text);
      if (num >= 1 && num <= 80) {
        cbmInput.value = num;
      }
    });


    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì°¨ê° ì…ë ¥ ì»¨í…Œì´ë„ˆ ë¡œì§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const deductSection = document.getElementById('deductSection');
    const btnAddDeduct  = document.getElementById('btnAddDeduct');

    // ìˆ«ì ì…ë ¥ì„ ì²œë‹¨ìœ„ ì½¤ë§ˆë¡œ í¬ë§·í•˜ëŠ” í•¨ìˆ˜
    function formatNumberWithCommas(value){
      const onlyDigits = value.replace(/[^\d]/g, '');  // ìˆ«ìë§Œ ë‚¨ê¸°ê¸°
      if (!onlyDigits) return '';
      const num = Number(onlyDigits);
      if (Number.isNaN(num)) return '';
      return num.toLocaleString('ko-KR');
    }

    // input ìš”ì†Œì— í¬ë§· ì´ë²¤íŠ¸ ë°”ì¸ë”©
    function attachFormatHandler(input){
      input.addEventListener('input', () => {
        const cursorToEnd = document.activeElement === input;
        const formatted = formatNumberWithCommas(input.value);
        input.value = formatted;
        if (cursorToEnd) {
          // ì»¤ì„œëŠ” ë§¨ ëìœ¼ë¡œ ê°€ì§€ë§Œ, ì´ ì •ë„ëŠ” UXìƒ í¬ê²Œ ë¬¸ì œ ì•ˆ ë¨
          input.selectionStart = input.selectionEnd = input.value.length;
        }
      });
    }

    // ìƒˆ ì°¨ê° ì¤„ ìƒì„± ( - ë²„íŠ¼ í¬í•¨ )
    function createDeductRow(){
      const row = document.createElement('div');
      row.className = 'deduct-row';

      const minusBtn = document.createElement('button');
      minusBtn.type = 'button';
      minusBtn.className = 'deduct-remove-btn';
      minusBtn.textContent = 'âˆ’';   // ì¡°ê¸ˆ ì˜ˆìœ ë§ˆì´ë„ˆìŠ¤

      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'deduct-input';
      input.placeholder = 'ë„ê¸‰ë¹„ ì…ë ¥';

      attachFormatHandler(input);

      minusBtn.addEventListener('click', () => {
        deductSection.removeChild(row);
      });

      row.appendChild(minusBtn);
      row.appendChild(input);

      deductSection.appendChild(row);
    }

    // ì²« ì¤„ inputì—ë„ í¬ë§· í•¸ë“¤ëŸ¬ ì—°ê²°
    const firstDeductInput = deductSection.querySelector('.deduct-input');
    if (firstDeductInput) attachFormatHandler(firstDeductInput);

    // + ë²„íŠ¼ ëˆŒë €ì„ ë•Œ ìƒˆ ì¤„ ì¶”ê°€
    btnAddDeduct.addEventListener('click', () => {
      createDeductRow();
    });


    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ì¡°íšŒ ë²„íŠ¼: /api/sos-rate í˜¸ì¶œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const typeSelect = document.getElementById('typeSelect');
    const btnFetch   = document.getElementById('btnFetch');
    const resultBox  = document.getElementById('resultBox');
    const resultDesc = document.getElementById('resultDesc');
    const resultOriginal = document.getElementById('resultOriginal');
    const resultVal  = document.getElementById('resultValue');
    const resultExtra= document.getElementById('resultExtra');

    btnFetch.addEventListener('click', async ()=>{
      if (!selectedDateStr){
        alert('ë‚ ì§œë¥¼ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”.');
        return;
      }
      const type = typeSelect.value;
      const cbm  = cbmInput.value;

    
      btnFetch.disabled = true;
      btnFetch.textContent = 'ì¡°íšŒì¤‘...';
    
      try{
        const params = new URLSearchParams({ date:selectedDateStr, type, cbm });
        const res = await fetch(`${API_BASE}/api/sos-rate/inbound?${params.toString()}`);
        const data = await res.json();

        if (!res.ok || !data.ok){
          alert(data.error || 'ì¡°íšŒ ì‹¤íŒ¨');
          resultBox.hidden = true;
        } else {
          resultBox.hidden = false;

          resultDesc.textContent =
            `${data.input.date} / ${data.input.weekdayType} / ${type} / ${cbm} CBM`;

          const v = data.match.value;

          if (v == null){
            resultVal.textContent = 'ê°’ ì—†ìŒ';
            resultOriginal.textContent = '';   // ì›ë³¸/ì°¨ê° ë¼ì¸ ë¹„ìš°ê¸°
          } else {
            // âœ… ì°¨ê° ì…ë ¥ì¹¸ ê°’ ëª¨ë‘ í•©ì‚° (ì½¤ë§ˆ ì œê±° í›„ ìˆ«ì ë³€í™˜)
            let deductionTotal = 0;
            document.querySelectorAll('.deduct-input').forEach(input => {
              const cleaned = input.value.replace(/,/g, '').trim();
              if (cleaned){
                const n = Number(cleaned);
                if (!Number.isNaN(n)) deductionTotal += n;
              }
            });

            const finalValue = v - deductionTotal;

            const originalStr  = v.toLocaleString('ko-KR');
            const deductionStr = deductionTotal.toLocaleString('ko-KR');
            const finalStr     = finalValue.toLocaleString('ko-KR');

            // ğŸ”¹ ìœ„ ì¤„: "ì›ë³¸ : xxx - ì°¨ê°ê¸ˆì•¡ : yyy ="
            resultOriginal.textContent =
              `(ì›ë³¸) ${originalStr} - (ë„ê¸‰ë¹„) ${deductionStr} =`;

            // ğŸ”¹ ì•„ë˜ ì¤„: ìµœì¢… ê²°ê³¼ê°’
            resultVal.textContent = `${finalStr} ì›`;
          }
          resultExtra.textContent = data.match.extra ? `ë©”ëª¨: ${data.match.extra}` : '';
        }
      }catch(e){
        console.error(e);
        alert('ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }finally{
        btnFetch.disabled = false;
        btnFetch.textContent = 'ì¡°íšŒ';
      }
    });
  </script>
</body>
</html>

