<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <title>ì¹´ì¹´ì˜¤ë§µ ê±°ë¦¬ & ë…¸ì…˜ ìš´ì„ ì¡°íšŒ</title>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; padding: 20px; background-color: #f0f2f5; }
        .container { max-width: 800px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; margin-bottom: 20px; }
        
        .input-group { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        .input-row { display: flex; gap: 10px; align-items: flex-end; }
        .input-wrapper { flex: 1; }
        .input-wrapper label { display: block; font-size: 0.9em; color: #666; margin-bottom: 5px; font-weight: bold; }
        
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; background-color: #f9f9f9; cursor: pointer; }
        input:focus { outline: none; border-color: #ff5f00; }
        
        .btn-search { padding: 12px 15px; background: #333; color: white; border: none; border-radius: 6px; cursor: pointer; white-space: nowrap; font-weight: bold; }
        .btn-search:hover { background: #555; }

        .btn-action { width: 100%; padding: 15px; background: #ff5f00; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1.1em; transition: background 0.3s; }
        .btn-action:hover { background: #e04f00; }
        
        #result { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center; font-size: 1.1em; color: #333; border: 1px solid #eee; }
        #result span { color: #ff5f00; font-weight: bold; font-size: 1.3em; }

        .cost-info { margin-top: 15px; padding-top: 15px; border-top: 1px dashed #ddd; display: none; }
        .cost-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 1.1em; }
        .cost-label { color: #555; }
        .cost-value { font-weight: bold; color: #333; }
        
        #map { width: 100%; height: 500px; border-radius: 12px; margin-top: 20px; border: 1px solid #ddd; }
    </style>
</head>
<body>

    <div class="container">
        <h2>ğŸ“ ê±°ë¦¬(Kakao) + ìš´ì„(Notion) ì¡°íšŒ</h2>
        
        <div class="input-group">
            <div class="input-row">
                <div class="input-wrapper">
                    <label>ì¶œë°œì§€</label>
                    <input type="text" id="startAddr" placeholder="ì˜ˆ: ì„œìš¸ì—­" readonly onclick="searchAddress('startAddr')">
                </div>
                <button class="btn-search" onclick="searchAddress('startAddr')">ğŸ” ì£¼ì†Œ ê²€ìƒ‰</button>
            </div>
            <div class="input-row">
                <div class="input-wrapper">
                    <label>ë„ì°©ì§€</label>
                    <input type="text" id="endAddr" placeholder="ì˜ˆ: ë¶€ì‚°ì—­" readonly onclick="searchAddress('endAddr')">
                </div>
                <button class="btn-search" onclick="searchAddress('endAddr')">ğŸ” ì£¼ì†Œ ê²€ìƒ‰</button>
            </div>
        </div>
        
        <button class="btn-action" onclick="startProcess()">ğŸš€ ê³„ì‚° ë° ì¡°íšŒ ì‹œì‘</button>
        
        <div id="result">
            <div>ì£¼ì†Œë¥¼ ê²€ìƒ‰í•˜ì—¬ ì…ë ¥í•˜ê³  ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
            <div id="costArea" class="cost-info">
                <div class="cost-row">
                    <span class="cost-label">ğŸš› 20FT ì•ˆì „ìš´ì„:</span>
                    <span class="cost-value" id="cost20">0ì›</span>
                </div>
                <div class="cost-row">
                    <span class="cost-label">ğŸš› 40FT ì•ˆì „ìš´ì„:</span>
                    <span class="cost-value" id="cost40">0ì›</span>
                </div>
            </div>
        </div>
        
        <div id="map"></div>
    </div>

    <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=d8014be9aeabfb44e1705e125f327105&libraries=services"></script>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

    <script>
        // â˜…â˜…â˜… í•µì‹¬: ë‘ ê°œì˜ ë°±ì—”ë“œ ì£¼ì†Œ ë¶„ë¦¬ â˜…â˜…â˜…
        const KAKAO_BACKEND_URL = "https://kakao-backend.vercel.app";    // ê±°ë¦¬ ê³„ì‚°ìš©
        const NOTION_BACKEND_URL = "https://notion-api-hub.vercel.app";  // ë¹„ìš© ì¡°íšŒìš©

        var mapContainer = document.getElementById('map'), 
            mapOption = { center: new kakao.maps.LatLng(36.5, 127.5), level: 13 };
        var map = new kakao.maps.Map(mapContainer, mapOption);
        var geocoder = new kakao.maps.services.Geocoder();

        var polylines = [], flyingMarker = null, animationTimer = null, fixedMarkers = []; 

        function searchAddress(targetId) {
            new daum.Postcode({
                oncomplete: function(data) {
                    var addr = data.userSelectedType === 'R' ? data.roadAddress : data.jibunAddress;
                    document.getElementById(targetId).value = addr;
                }
            }).open();
        }

        async function startProcess() {
            var startAddr = document.getElementById('startAddr').value;
            var endAddr = document.getElementById('endAddr').value;
            var resultDiv = document.querySelector('#result > div:first-child');
            var costArea = document.getElementById('costArea');

            costArea.style.display = 'none';

            if(!startAddr || !endAddr) return alert("ì£¼ì†Œë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            resultDiv.innerHTML = "ë°ì´í„° ì¡°íšŒ ì¤‘...";

            try {
                // 1. ì§€ë„ ê´€ë ¨ ì²˜ë¦¬
                var startCoords = await getCoords(startAddr);
                var endCoords = await getCoords(endAddr);
                
                var startLatLng = new kakao.maps.LatLng(startCoords.y, startCoords.x);
                var endLatLng = new kakao.maps.LatLng(endCoords.y, endCoords.x);

                displayMarkers(startLatLng, endLatLng, false); 
                animateMarker(startLatLng, endLatLng);

                // 2. [KAKAO ë°±ì—”ë“œ] ê±°ë¦¬ ê³„ì‚° ìš”ì²­
                const routeData = await getRouteData(startCoords, endCoords);
                
                const distanceMeters = routeData.routes[0].summary.distance;
                const distanceKm = distanceMeters / 1000;
                const durationMin = (routeData.routes[0].summary.duration / 60).toFixed(0);

                // 3. ë°˜ì˜¬ë¦¼ (Notion ê²€ìƒ‰ìš©)
                const roundedDistance = Math.round(distanceKm);

                // 4. [NOTION ë°±ì—”ë“œ] ìš´ì„ ì¡°íšŒ ìš”ì²­
                const costData = await getTruckingCost(roundedDistance);

                // 5. ê²°ê³¼ ì¶œë ¥
                let costHtml = "";
                if (costData.found) {
                    document.getElementById('cost20').innerText = Number(costData.data.cost20).toLocaleString() + "ì›";
                    document.getElementById('cost40').innerText = Number(costData.data.cost40).toLocaleString() + "ì›";
                    costArea.style.display = 'block';
                } else {
                    costHtml = `<br><span style="color:gray; font-size:0.8em;">(ê±°ë¦¬ ${roundedDistance}kmì— í•´ë‹¹í•˜ëŠ” ìš´ì„ ì •ë³´ê°€ DBì— ì—†ìŠµë‹ˆë‹¤)</span>`;
                }

                resultDiv.innerHTML = `
                    ì´ ê±°ë¦¬: <span>${distanceKm.toFixed(1)}km</span> (ì•½ ${durationMin}ë¶„)<br>
                    ì ìš© êµ¬ê°„: <span>${roundedDistance}km</span> ê¸°ì¤€
                    ${costHtml}
                `;

            } catch (e) {
                console.error(e);
                resultDiv.innerHTML = "ì˜¤ë¥˜ ë°œìƒ: " + e.message;
            }
        }

        function getCoords(addr) {
            return new Promise((resolve, reject) => {
                geocoder.addressSearch(addr, (res, status) => {
                    status === kakao.maps.services.Status.OK ? resolve(res[0]) : reject(new Error("ì£¼ì†Œ ì—†ìŒ"));
                });
            });
        }

        // [A] ì¹´ì¹´ì˜¤ ë°±ì—”ë“œ í˜¸ì¶œ í•¨ìˆ˜
        async function getRouteData(start, end) {
            const startParam = `${start.x},${start.y}`;
            const endParam = `${end.x},${end.y}`;
            // KAKAO_BACKEND_URL ì‚¬ìš©
            const url = `${KAKAO_BACKEND_URL}/api/distance?start=${startParam}&end=${endParam}`;

            const response = await fetch(url, { headers: { 'Content-Type': 'application/json' } });
            if (!response.ok) throw new Error("ê±°ë¦¬ ê³„ì‚° ì„œë²„ ì˜¤ë¥˜");
            return await response.json();
        }

        // [B] ë…¸ì…˜ ë°±ì—”ë“œ í˜¸ì¶œ í•¨ìˆ˜
        async function getTruckingCost(distance) {
            // NOTION_BACKEND_URL ì‚¬ìš©
            const url = `${NOTION_BACKEND_URL}/api/trc/cal?distance=${distance}`;
            
            const response = await fetch(url, { headers: { 'Content-Type': 'application/json' } });
            if (!response.ok) throw new Error("ìš´ì„ ì¡°íšŒ ì„œë²„ ì˜¤ë¥˜");
            return await response.json();
        }

        // --- ì´í•˜ ì§€ë„ ì• ë‹ˆë©”ì´ì…˜ í•¨ìˆ˜ (ë™ì¼) ---
        function displayMarkers(start, end, showEndMarker = true) {
            fixedMarkers.forEach(m => m.setMap(null)); fixedMarkers = [];
            var bounds = new kakao.maps.LatLngBounds();
            bounds.extend(start); bounds.extend(end);
            map.setBounds(bounds);
            var startMarker = new kakao.maps.Marker({ position: start, map: map, title: 'ì¶œë°œ' });
            fixedMarkers.push(startMarker);
            if (showEndMarker) {
                var endMarker = new kakao.maps.Marker({ position: end, map: map, title: 'ë„ì°©' });
                fixedMarkers.push(endMarker);
            }
        }
        function animateMarker(start, end) {
            if (animationTimer) clearInterval(animationTimer);
            polylines.forEach(p => p.setMap(null)); polylines = [];
            if (flyingMarker) flyingMarker.setMap(null);
            var frames = 60; 
            var pathData = calculateBezierPath(start, end, frames);
            var imageSrc = "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png"; 
            var imageSize = new kakao.maps.Size(30, 40); 
            var imageOption = {offset: new kakao.maps.Point(15, 40)}; 
            var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption);
            flyingMarker = new kakao.maps.Marker({ position: start, map: map, image: markerImage, zIndex: 10 });
            var currentFrame = 0;
            animationTimer = setInterval(() => {
                if (currentFrame >= pathData.length - 1) { clearInterval(animationTimer); return; }
                var currPos = pathData[currentFrame];
                var nextPos = pathData[currentFrame + 1];
                var t = currentFrame / frames; 
                var currentWeight = 2 + (14 * Math.sin(t * Math.PI)); 
                var segment = new kakao.maps.Polyline({
                    path: [currPos, nextPos], strokeWeight: currentWeight, strokeColor: '#ff5f00', strokeOpacity: 0.8, strokeStyle: 'solid'
                });
                segment.setMap(map); polylines.push(segment);
                flyingMarker.setPosition(nextPos);
                currentFrame++;
            }, 20);
        }
        function calculateBezierPath(start, end, count) {
            var path = [];
            var latDiff = Math.abs(start.getLat() - end.getLat());
            var lngDiff = Math.abs(start.getLng() - end.getLng());
            var offset = (latDiff + lngDiff) * 0.3;
            var control = new kakao.maps.LatLng((start.getLat() + end.getLat()) / 2 + offset, (start.getLng() + end.getLng()) / 2);
            for (var i = 0; i <= count; i++) {
                var t = i / count;
                var x = (1 - t) * (1 - t) * start.getLng() + 2 * (1 - t) * t * control.getLng() + t * t * end.getLng();
                var y = (1 - t) * (1 - t) * start.getLat() + 2 * (1 - t) * t * control.getLat() + t * t * end.getLat();
                path.push(new kakao.maps.LatLng(y, x));
            }
            return path;
        }
    </script>
</body>
</html>
