<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>P.A.S.S[PUMEX All-in-one Support System]</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;800&display=swap" rel="stylesheet">    
    <link rel="stylesheet" href="https://arrrbang.github.io/pumex/common/header/header.css">
    <link rel="stylesheet" href="home.css">
</head>
<body>

    <div id="header-placeholder"></div>

    <div id="loading-container">
        <div class="spinner"></div>
        <div class="loading-msg">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>

    <div id="notice-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modal-title-text">ê³µì§€ì‚¬í•­</div>
                <button class="modal-close" onclick="closeNoticeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-body-content">ë¡œë”© ì¤‘...</div>
        </div>
    </div>



    <h1 id="dashboard-title">DASHBOARD</h1>
    <div class="main-layout">
  
        <div class="left-wrap">

            <div id="sales-dashboard-view">
                <h2>ğŸ”¥ ì—¬ê¶Œ ë¯¸ì œì¶œ <span id="passport-count" class="count-badge"></span></h2>
                <table class="sales-passport">
                    <thead><tr><th>ì„œë¥˜ë§ˆê°</th><th>ê³ ê°ëª…</th><th>êµ­ê°€</th><th>ì—…ë¬´ë‹´ë‹¹</th></tr></thead>
                    <tbody id="passport-table-body"></tbody>
                </table>

                <h2>ğŸ“¦ ë³´ê´€ ì¤‘ì¸ ê±´ <span id="storage-count" class="count-badge"></span></h2>
                <table class="sales-storage">
                    <thead><tr><th>í¬ì¥ì¼</th><th>ê³ ê°ëª…</th><th>êµ­ê°€</th><th>ì—…ë¬´ë‹´ë‹¹</th></tr></thead>
                    <tbody id="storage-table-body"></tbody>
                </table>

                <h2>â˜‚ï¸ ë³´í—˜ ìš”ì²­ ê±´ <span id="insurance-count" class="count-badge"></span></h2>
                <table class="sales-insurance">
                    <thead><tr><th>ì…í•­ì¼</th><th>ê³ ê°ëª…</th><th>êµ­ê°€</th><th>ì—…ë¬´ë‹´ë‹¹</th></tr></thead>
                    <tbody id="insurance-table-body"></tbody>
                </table>

            </div>

            <div id="ops-dashboard-view">
                <h2>ğŸ“• ì—¬ê¶Œ ìˆ˜ì·¨ í•„ìš” <span id="ops-passport-count" class="count-badge"></span></h2>
                <table class="ops-passport">
                    <thead><tr><th>ì„œë¥˜ ë§ˆê°ì¼</th><th>ê³ ê°ëª…</th><th>ì˜ì—…ë‹´ë‹¹</th></tr></thead>
                    <tbody id="ops-passport-body"></tbody>
                </table>

                <h2>â° 2ì¼ ì´ë‚´ ë§ˆê° (ê³µíœ´ì¼ ì œì™¸) <span id="ops-deadline-count" class="count-badge"></span></h2>
                <table class="ops-documentcut">
                    <thead><tr><th>ì„œë¥˜ ë§ˆê°ì¼</th><th>ì»¨ì‘ì—…ì¼ì •</th><th>ê³ ê°ëª…</th></tr></thead>
                    <tbody id="ops-deadline-body"></tbody>
                </table>
            </div>
        </div>

        <div class="vertical-divider"></div>

        <div class="right-wrap">
            <div id="common-notice-area" style="display:none;">
                <h2>ğŸ“¢ ê³µì§€ì‚¬í•­</h2>
                <table class="common-notice">
                    <colgroup><col style="width: 20%;"><col style="width: 80%;"></colgroup>
                    <thead><tr><th>êµ­ê°€ëª…</th><th>ë‚´ì—­ (í´ë¦­í•˜ì—¬ ë³´ê¸°)</th></tr></thead>
                    <tbody id="notice-table-body"></tbody>
                </table>

                <div id="sales-dashboard-view">
                <h2>ğŸš› ì½˜ì†” ëŒ€ê¸° (ì „ì²´) <span id="console-count" class="count-badge"></span></h2>
                <table class="sales-console">
                    <thead><tr><th>POE</th><th>í¬ì¥ì¼</th><th>CBM</th><th>ê³ ê°ëª…</th><th>ì˜ì—…ë‹´ë‹¹</th><th>ì—…ë¬´ë‹´ë‹¹</th></tr></thead>
                    <tbody id="console-table-body"></tbody>
                </table>
                </div>
            </div>
        </div>

    </div>
    
    <script src="../common/js/loading.js"></script>
    <script src="../common/js/login.js"></script>
    <script src="sales.js"></script>
    <script src="ops.js"></script>

    <script>
        function closeNoticeModal() { document.getElementById('notice-modal').style.display = 'none'; }
        
        document.getElementById('notice-modal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('notice-modal')) closeNoticeModal();
        });

        async function loadNotices() {
            const NOTICE_API_URL = "https://notion-api-hub.vercel.app/api/home/notice";
            const response = await fetch(NOTICE_API_URL);
            if (response.ok) {
                const result = await response.json();
                renderNoticeTable(result.data);
                document.getElementById('common-notice-area').style.display = 'block';
            }
        }

        async function openNoticeModal(pageId, title) {
            const modal = document.getElementById('notice-modal');
            const bodyEl = document.getElementById('modal-body-content');
            document.getElementById('modal-title-text').textContent = title;
            modal.style.display = 'flex';
            bodyEl.innerHTML = '<div style="text-align:center;">ë¡œë”© ì¤‘...</div>';
            
            try {
                const res = await fetch(`https://notion-api-hub.vercel.app/api/home/notice/${pageId}`);
                const json = await res.json();
                if (json.ok) bodyEl.innerHTML = renderNotionBlocks(json.data);
                else bodyEl.innerHTML = 'ë‚´ìš© ë¡œë“œ ì‹¤íŒ¨';
            } catch(e) { bodyEl.innerHTML = 'í†µì‹  ì˜¤ë¥˜'; }
        }

        function renderNoticeTable(list) {
            const tbody = document.getElementById('notice-table-body');
            tbody.innerHTML = "";
            if (!list || !list.length) { tbody.innerHTML = "<tr><td colspan='2' style='text-align:center'>ê³µì§€ì‚¬í•­ ì—†ìŒ</td></tr>"; return; }
            list.forEach(item => {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td style="text-align:center; font-weight:bold;">${item.country}</td>
                                <td><span class="notice-link" onclick="openNoticeModal('${item.id}', '${item.content.replace(/'/g, "\\'")}')">${item.content}</span></td>`;
                tbody.appendChild(tr);
            });
        }
        
        function renderNotionBlocks(blocks) {
            if (!blocks || !blocks.length) return "";

            return blocks.map(block => {
                const type = block.type;
                const value = block[type]; 
                const getText = (richTextArray) => {
                    if (!richTextArray) return "";
                    return richTextArray.map(t => {
                        let content = t.plain_text
                            .replace(/</g, "&lt;")
                            .replace(/>/g, "&gt;")
                            .replace(/\n/g, "<br>");

                        const anno = t.annotations;
                        if (anno.bold) content = `<span class="notion-bold">${content}</span>`;
                        if (anno.italic) content = `<span class="notion-italic">${content}</span>`;
                        if (anno.strikethrough) content = `<span class="notion-strikethrough">${content}</span>`;
                        if (anno.underline) content = `<span class="notion-underline">${content}</span>`;
                        if (anno.code) content = `<span class="notion-code">${content}</span>`;
                        return content;
                    }).join("");
                };
                
                let childrenHtml = "";
                if (block.children && block.children.length > 0) {
                    childrenHtml = `<div class="notion-toggle-content">${renderNotionBlocks(block.children)}</div>`;
                }

                switch (type) {
                    case 'toggle':
                        return `
                            <details class="notion-toggle">
                                <summary class="notion-toggle-summary">â–¶ ${getText(value.rich_text)}</summary>
                                ${childrenHtml} </details>
                        `;

                    case 'heading_1': 
                    case 'heading_2': 
                    case 'heading_3':
                        const tag = type === 'heading_1' ? 'h1' : (type === 'heading_2' ? 'h2' : 'h3');
                        const className = `notion-${tag}`;
                        const content = `<${tag} class="${className}">${getText(value.rich_text)}</${tag}>`;
                        
                        if (childrenHtml) {
                            return `
                                <details class="notion-toggle">
                                    <summary class="notion-toggle-summary">${content}</summary>
                                    ${childrenHtml}
                                </details>
                            `;
                        }
                        return content;

                    case 'bulleted_list_item': 
                        return `<ul class="notion-ul"><li>${getText(value.rich_text)}${childrenHtml}</li></ul>`;
                    case 'numbered_list_item': 
                        return `<ol class="notion-ol"><li>${getText(value.rich_text)}${childrenHtml}</li></ol>`;
                    
                    case 'callout':
                        const icon = value.icon?.emoji || "ğŸ’¡";
                        return `<div class="notion-callout"><span>${icon}</span><div>${getText(value.rich_text)}${childrenHtml}</div></div>`;
                    
                    case 'paragraph': 
                        return `<div class="notion-p">${getText(value.rich_text)}${childrenHtml}</div>`;

                    case 'image':
                        const src = value.type === 'external' ? value.external.url : value.file.url;
                        return `<img src="${src}" class="notion-image" alt="image">`;
                    
                    case 'divider': 
                        return `<hr class="notion-hr">`;
                    
                    default: 
                        return ""; 
                }
            }).join("");
        }

        document.addEventListener("DOMContentLoaded", async () => {

            const loadingContainer = document.getElementById('loading-container');

            // [ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš©] 
            // const infoText = document.getElementById('info-text');
            // const username = 'opere';

            const username = localStorage.getItem('username');

                if (!username) {
                    alert("ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
                    
                    if (typeof logout === 'function') {
                        logout();
                    } else {
                        location.href = 'https://arrrbang.github.io/pumex/index.html'; 
                    }
                    return;
                }

            const salesGroup = ['salea', 'saleb', 'salek', 'oh', 'eric', 'kbs', 'pjs', 'jackson', 'crjung', 'sk'];
            const opsGroup   = ['admin', 'opere', 'opero', 'operd'];

            try {
                const tasks = [loadNotices()];

                if (salesGroup.includes(username)) {
                    tasks.push(initSalesDashboard(username));
                    await Promise.all(tasks);
                    
                    document.getElementById('sales-dashboard-view').style.display = 'block';

                } else if (opsGroup.includes(username)) {
                    tasks.push(initOpsDashboard(username));
                    await Promise.all(tasks);

                    document.getElementById('ops-dashboard-view').style.display = 'block';

                } else {
                    document.getElementById('dashboard-title').textContent = "DASHBOARD(ì¤€ë¹„ì¤‘...)";
                }
            } catch (e) {
                console.error(e);
                infoText.className = 'error';
                infoText.textContent = "ë°ì´í„° ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e.message;
            } finally {
                loadingContainer.style.display = 'none';
            }
        });
    </script>
</body>
</html>
