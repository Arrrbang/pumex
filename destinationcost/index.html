<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>도착지 비용 계산</title>

  <!-- 폰트: 로그인 페이지와 동일 -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <div class="page-bg" aria-hidden="true"></div>

  <!-- 상단 바 -->
  <header class="site-header">
    <div class="container header-inner">
      <a class="brand" href="#">
        <img src="https://arrrbang.github.io/pumex/image/pumexlogonew.png" alt="PUMEX Logo" class="brand__logo" />
      </a>
      <a class="header__title" href="#">도착지 비용 계산</a>
      <nav class="header__nav" aria-label="상단 링크"> // 이동할 링크 추가
      </nav>
    </div>
  </header>

  <!-- 메인 -->
  <main class="container section">
    <nav class="tabs" aria-label="카테고리 선택">
      <button class="tab" type="button" id="btnDiplomat">Diplomat</button>
      <button class="tab" type="button" id="btnNonDiplomat">Non-Diplomat</button>
    </nav>
    
<div class="dropdown-container">
  <div class="dropdown" id="dropdownMenu">
    <div class="dropdown-inner">
      <label class="dropdown-label" for="countryCombo">국가 선택</label>
      <div class="combo" id="countryCombo">
        <input type="text" placeholder="국가를 입력/선택 (예: 미국, 중국)" autocomplete="off">
        <div class="list"></div>
      </div>
  
      <div class="dropdown-label-row">
        <span class="label-text">지역 선택</span>
        <button class="map-button-inline" type="button">지도에서 선택</button>
      </div>
      <div class="combo" id="regionCombo">
        <input type="text" placeholder="지역을 입력/선택 (예: A지역, B지역)" autocomplete="off" disabled>
        <div class="list"></div>
      </div>
  
      <label class="dropdown-label" for="companyCombo">업체 선택</label>
      <div class="combo" id="companyCombo">
        <input type="text" placeholder="업체를 입력/선택 (예: A업체, B업체)" autocomplete="off" disabled>
        <div class="list"></div>
      </div>
    </div>
  </div>
</div>
<div class="selection-summary" id="selectionSummary"></div>

<div class="dropdown-container">
  <div class="dropdown" id="nextDropdowns">
    <div class="dropdown-inner">
      <label class="dropdown-label" for="typeCombo">컨테이너 타입</label>
      <div class="combo" id="typeCombo">
        <input type="text" placeholder="20FT / 40HC / CONSOLE" autocomplete="off" value="20FT">
        <div class="list"></div>
      </div>
  
      <label class="dropdown-label" for="cbmSelect">CBM 선택</label>
      <select id="cbmSelect" class="dropdown-select"></select>
    </div><!-- /.dropdown-inner -->
  </div>
</div>
    
<div class="selection-summary" id="nextSelectionSummary"></div>

  <section id="resultSection" class="result-section" aria-live="polite">
    <div id="costList" class="cost-list"></div>
  </section>
    
</main>

<script>
/* =========================
   공통 유틸
========================= */
const BASE = 'https://notion-api-hub.vercel.app';
const $  = (s, r=document)=>r.querySelector(s);

/* =========================
   떠 있는 콤보 팝업 관리자
   - 콤보 .list를 body로 옮겨서 overflow 잘림 회피
========================= */
const Floating = (() => {
  const mounts = new Map(); // listEl -> { comboEl, onScroll, onResize }
  function open(comboEl){
    const input = comboEl.querySelector('input');
    const list  = comboEl.querySelector('.list');
    if(!input || !list) return;

    // 이미 떠 있으면 위치만 갱신
    if(mounts.has(list)){ position(comboEl); return; }

    // body에 붙일 래퍼
    const wrap = document.createElement('div');
    wrap.className = 'combo-float-wrap';
    wrap.style.position = 'fixed';
    wrap.style.zIndex = '1000';
    wrap.style.left = '0'; wrap.style.top = '0';
    wrap.style.width = '0'; wrap.style.height = '0';
    document.body.appendChild(wrap);

    // 기존 list를 래퍼로 이동
    list.dataset.__float = '1';
    wrap.appendChild(list);

    // 위치 지정 함수
    const onScroll = () => position(comboEl);
    const onResize = () => position(comboEl);
    window.addEventListener('scroll', onScroll, true);
    window.addEventListener('resize', onResize);

    mounts.set(list, { comboEl, wrap, onScroll, onResize });
    position(comboEl);
  }
  function position(comboEl){
    const input = comboEl.querySelector('input');
    const list  = getList(comboEl);
    if(!input || !list) return;
    const r = input.getBoundingClientRect();
    const maxW = r.width;
    list.style.display = 'block';
    list.style.position = 'fixed';
    list.style.left = `${r.left}px`;
    list.style.top  = `${r.bottom + 6}px`;
    list.style.width= `${maxW}px`;
    // 화면 하단 넘치면 위로 띄우기
    const rect = list.getBoundingClientRect();
    const tooLow = rect.bottom > window.innerHeight - 8;
    if(tooLow){
      list.style.top = `${Math.max(8, r.top - 6 - rect.height)}px`;
    }
  }
  function close(comboEl){
    const list = getList(comboEl);
    if(!list) return;
    const mount = mounts.get(list);
    if(!mount) return;
    window.removeEventListener('scroll', mount.onScroll, true);
    window.removeEventListener('resize', mount.onResize);
    mounts.delete(list);

    // 원래 자리로 복귀
    list.removeAttribute('style');
    list.removeAttribute('data-__float');
    mount.wrap.remove(); // 래퍼 제거
    comboEl.appendChild(list);
    list.style.display = 'none';
  }
  function getList(comboEl){ return document.querySelector('.list[data-__float="1"]') || comboEl.querySelector('.list'); }
  function isInsideFloating(el){
    return !!el.closest('.combo-float-wrap') || !!el.closest('.list[data-__float="1"]');
  }
  return { open, close, position, isInsideFloating };
})();

/* =========================
   타이핑 콤보
========================= */
function makeCombo(el, items=[]){
  const input = el.querySelector('input');
  const list  = el.querySelector('.list');
  let data = [...items];
  let selected = null;

  function render(filter=''){
    const f = (filter||'').trim().toLowerCase();
    list.innerHTML='';
    const filtered = f ? data.filter(x=>x.toLowerCase().includes(f)) : [...data];
    const sorted = filtered.sort((a,b)=>{
      const an=Number(a), bn=Number(b);
      if(!isNaN(an)&&!isNaN(bn)) return an-bn;
      const ap=f && a.toLowerCase().startsWith(f)?0:1;
      const bp=f && b.toLowerCase().startsWith(f)?0:1;
      if(ap!==bp) return ap-bp;
      return a.localeCompare(b, 'ko');
    });
    sorted.forEach(v=>{
      const d=document.createElement('div');
      d.className='item' + (selected===v ? ' is-selected':'');
      d.textContent=v;
      d.addEventListener('click', (e)=>{
        e.stopPropagation();
        selected=v;
        input.value=v;
        // 선택하면 콤보 리스트는 닫는 게 맞음
        el.classList.remove('open');
        Floating.close(el);
        el.dispatchEvent(new CustomEvent('change',{detail:v}));
      });
      list.appendChild(d);
    });
  }
  function setItems(arr){
    data = [...new Set((arr||[]).filter(Boolean))];
    input.disabled = data.length===0;
    if(document.activeElement!==input) input.value='';
    selected=null;
    render(input.value);
  }
  function getValue(){ return selected || input.value.trim(); }
  function setValue(v){ selected=v||null; input.value=v??''; render(input.value); }

  // 열기/필터
  input.addEventListener('focus', ()=>{
    el.classList.add('open'); render(input.value); Floating.open(el);
  });
  input.addEventListener('input', ()=>{
    el.classList.add('open'); render(input.value); Floating.open(el);
  });

  // Enter → 첫 항목 선택
  input.addEventListener('keydown', (e)=>{
    if(e.key==='Enter'){
      const first=(Floating.isInsideFloating(document.activeElement)?document:el).querySelector('.item');
      if(first) first.click();
    }
  });

  setItems(items);
  return { setItems, getValue, setValue, root: el, input, list };
}

/* =========================
   요소 참조
========================= */
const btnDiplomat    = $("#btnDiplomat");
const btnNonDiplomat = $("#btnNonDiplomat");
const dropdownMenu   = $("#dropdownMenu");
const nextDropdowns  = $("#nextDropdowns");
const summary        = $("#selectionSummary");
const nextSummary    = $("#nextSelectionSummary");

const countryCombo = makeCombo(document.getElementById('countryCombo'));
const regionCombo  = makeCombo(document.getElementById('regionCombo'));
const companyCombo = makeCombo(document.getElementById('companyCombo'));
const typeCombo    = makeCombo(document.getElementById('typeCombo'), ['20FT','40HC','CONSOLE']);

const cbmSelect    = $("#cbmSelect");

let isDropdownVisible=false;
let isNextVisible=false;

/* =========================
   1단계/2단계 열고 닫기
========================= */
function openFirst(){
  dropdownMenu.classList.add('show');
  summary.classList.remove('show');
  nextDropdowns.classList.remove('show');
  nextSummary.classList.remove('show');
  isDropdownVisible=true;
}
function closeFirst(){
  dropdownMenu.classList.remove('show');
  isDropdownVisible=false;
  setTimeout(()=>{ showFirstSummary(); openSecond(); }, 400);
}
function openSecond(){
  nextDropdowns.classList.add('show');
  nextSummary.classList.remove('show');
  isNextVisible=true;
}
function closeSecond(){
  nextDropdowns.classList.remove('show');
  isNextVisible=false;
  setTimeout(()=>{
    const t = typeCombo.getValue() || '미선택';
    const cbm = cbmSelect?.value ? (cbmSelect.options[cbmSelect.selectedIndex]?.text||cbmSelect.value) : '미선택';
    nextSummary.textContent = `${t} — ${cbm}`;
    nextSummary.classList.add('show');
  }, 400);
}
function showFirstSummary(){
  const c = countryCombo.getValue() || '미선택';
  const r = regionCombo.getValue()  || '미선택';
  const comp = companyCombo.getValue() || '미선택';
  summary.textContent = `${c} — ${r} — ${comp}`;
  summary.classList.add('show');
}

/* 탭 버튼 */
btnDiplomat?.addEventListener('click', ()=>{
  if(isDropdownVisible) closeFirst(); else openFirst();
});
btnNonDiplomat?.addEventListener('click', ()=>{
  if(isDropdownVisible) closeFirst(); else openFirst();
});

/* 바깥 클릭 시 닫기 (정확한 내부 판별 포함) */
document.addEventListener('pointerdown', (e)=>{
  // 1단계: dropdownMenu 내부이거나, 떠 있는 콤보 팝업을 클릭하면 닫지 않음
  if(isDropdownVisible){
    const insideDropdown = dropdownMenu.contains(e.target);
    const insideFloating = Floating.isInsideFloating(e.target);
    if(!insideDropdown && !insideFloating){
      closeFirst();
    }
  }
  // 2단계
  if(isNextVisible){
    const inside2 = nextDropdowns.contains(e.target);
    if(!inside2) closeSecond();
  }
}, {passive:true});

/* =========================
   API 연동: 국가→지역→업체
========================= */
async function loadCountries(){
  try{
    const r = await fetch(`${BASE}/api/debug/config`);
    const j = await r.json();
    const countries = j.countries || Object.keys(j.dbStructure||{}) || [];
    countryCombo.setItems(countries);
  }catch(e){ countryCombo.setItems([]); }
}
countryCombo.root.addEventListener('change', async ()=>{
  const country = countryCombo.getValue();
  regionCombo.setItems([]); companyCombo.setItems([]);
  if(!country) return;
  try{
    const r = await fetch(`${BASE}/api/regions/${encodeURIComponent(country)}`);
    const j = await r.json();
    regionCombo.setItems(j.regions||[]);
  }catch(e){ regionCombo.setItems([]); }
});
regionCombo.root.addEventListener('change', async ()=>{
  const country = countryCombo.getValue();
  const region  = regionCombo.getValue();
  companyCombo.setItems([]);
  if(!country || !region) return;
  try{
    const url = `${BASE}/api/companies/by-region?country=${encodeURIComponent(country)}&region=${encodeURIComponent(region)}&mode=options`;
    const r = await fetch(url);
    const j = await r.json();
    companyCombo.setItems(j.companies||[]);
  }catch(e){ companyCombo.setItems([]); }
});

/* =========================
   컨테이너 타입 & CBM
========================= */
function setOptions(selectEl, values, placeholder='CBM 선택'){
  const opts = ['<option value="">'+placeholder+'</option>']
   .concat(values.map(v=>`<option value="${String(v)}">${String(v)}</option>`));
  selectEl.innerHTML = opts.join('');
}
function fillCbmByType(type){
  if(!cbmSelect) return;
  const T=(type||'').toUpperCase();
  let values=[];
  if(!T){ setOptions(cbmSelect,[], 'CBM 선택'); return; }
  if(T==='CONSOLE'){ values = Array.from({length:30},(_,i)=>i+1); }
  else { values = [5,10,15,20,25,30,35,40]; }
  setOptions(cbmSelect, values);
}
typeCombo.root.addEventListener('change', ()=> fillCbmByType(typeCombo.getValue()) );

/* =========================
   초기화
========================= */
window.addEventListener('DOMContentLoaded', async ()=>{
  await loadCountries();
  fillCbmByType(typeCombo.getValue() || '20FT');
});
</script>



</body>
</html>
