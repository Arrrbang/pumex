<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë„ì°©ì§€ ë¹„ìš© ê³„ì‚° (one-partner ë¶„ë¦¬ ë²„ì „-ìˆ˜ì •)</title>

  <!-- í°íŠ¸ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- í—¤ë” ì „ìš© CSS -->
  <link rel="stylesheet" href="../common/header/header.css" />
  <!-- ë©”ì¸ ìŠ¤íƒ€ì¼ -->
  <link rel="stylesheet" href="./app.css" />
</head>

<body>
<div id="header-placeholder"></div>

<main class="app-shell">
  <div class="app-main">

    <!-- ì™¼ìª½: ì§€ë„ ì˜ì—­ -->
    <section class="left-pane">
      <div id="mpkMap" class="map-canvas" aria-label="ì§€ë„ ì˜ì—­">
        <div class="map-placeholder">ì§€ë„(Leaflet)ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
      </div>
    </section>

    <!-- ì˜¤ë¥¸ìª½: í¼ ì˜ì—­ -->
    <section class="right-pane">
      <!--<div class="pane-title">í™”ë¬¼ ì •ë³´ ì…ë ¥</div>-->

      <!-- 1ì°¨: êµ­ê°€/ì§€ì—­ -->
      <div class="dropdown-container">
        <label class="dropdown-label" for="countryCombo">êµ­ê°€/ì§€ì—­ ì„ íƒ</label>

        <div class="combo-line">
          <div class="combo" id="countryCombo">
            <input type="text" placeholder="êµ­ê°€ ì„ íƒ" autocomplete="off">
            <div class="list"></div>
          </div>
        </div>

        <div class="combo-line">
          <div class="combo" id="regionCombo">
            <input type="text" placeholder="ë°°ì†¡ ì§€ì—­ ì„ íƒ" autocomplete="off" disabled>
            <div class="list"></div>
          </div>
        </div>
      </div>

      <div class="combo-line">
        <div class="cost-button-container" id="cost-button-container" aria-label="ë¹„ìš© ê´€ë ¨ ë™ì‘ ë²„íŠ¼">
          <button id="costCheck" class="cost-check-type-btn" type="button">ë¹„ìš© ì¡°íšŒ</button>
          <button id="costComparison" class="cost-check-type-btn" type="button">ë¹„ìš© ë¹„êµ</button>
        </div>
      </div>

      <!-- one-partner -->
      <div class="one partner" id="one-partner" hidden>
        <!-- 2ì°¨ ì„ íƒ: ì—…ì²´/POE -->
        <div class="dropdown-container">
          <label class="dropdown-label" for="companyCombo">íŒŒíŠ¸ë„ˆ/POE/í™”ë¬¼íƒ€ì… ì„ íƒ</label>

          <div class="combo-line">
            <div class="combo" id="companyCombo">
              <input type="text" placeholder="íŒŒíŠ¸ë„ˆ ì„ íƒ" autocomplete="off" disabled>
              <div class="list"></div>
            </div>
          </div>

          <div class="combo-line">
            <div class="combo" id="poeCombo">
              <input type="text" placeholder="POE ì„ íƒ" autocomplete="off" disabled>
              <div class="list"></div>
            </div>
          </div>

          <div class="combo-line">
            <div class="combo" id="cargoTypeCombo">
              <input type="text" placeholder="í™”ë¬¼ íƒ€ì… ì„ íƒ" autocomplete="off" disabled />
              <div class="list"></div>
            </div>
          </div>
        </div>

        <!-- 3ì°¨ ì„ íƒ -->
        <div class="dropdown-container">
          <label class="dropdown-label" for="cargoTypeSelect">ì»¨í…Œì´ë„ˆ íƒ€ì…/CBM ì„ íƒ</label>

          <div class="combo-line">
            <div class="combo" id="typeCombo">
              <input type="text" placeholder="20FT / 40HC / CONSOLE" autocomplete="off" disabled>
              <div class="list"></div>
            </div>
          </div>

          <div class="combo-line">
            <div class="combo" id="cbmCombo_Wrapper">
              <input type="text" id="cbmSelect" placeholder="CBM ì„ íƒ" autocomplete="off">
              <div class="list"></div>
            </div>
          </div>

        <!-- ì¡°íšŒ ë²„íŠ¼ -->
        <div class="action-row center show revealed">
          <button id="btnFetch" class="primary-btn"><span class="label">ì¡°íšŒ</span></button>
        </div>
      </div>

      <!-- two-partner (ì›ë³¸ ìœ ì§€) -->
      <div class="two partner" id="two-partner" hidden>
        <div class="dropdown-container">
          <label class="dropdown-label" for="companyCombo">íŒŒíŠ¸ë„ˆ/POE/í™”ë¬¼íƒ€ì… ì„ íƒ</label>
          <div class="combo-line-row">
            <div class="combo" id="companyComboA">
              <input type="text" placeholder="íŒŒíŠ¸ë„ˆ ì„ íƒ" autocomplete="off" disabled>
              <div class="list"></div>
            </div>
            <div class="combo" id="companyComboB">
              <input type="text" placeholder="íŒŒíŠ¸ë„ˆ ì„ íƒ" autocomplete="off" disabled>
              <div class="list"></div>
            </div>
          </div>
          <div class="combo-line-row">
            <div class="combo" id="poeComboA">
              <input type="text" placeholder="POE ì„ íƒ" autocomplete="off" disabled>
              <div class="list"></div>
            </div>
            <div class="combo" id="poeComboB">
              <input type="text" placeholder="POE ì„ íƒ" autocomplete="off" disabled>
              <div class="list"></div>
            </div>
          </div>
          <div class="combo-line-row">
            <div class="combo" id="cargoTypeComboA">
              <input type="text" placeholder="í™”ë¬¼ íƒ€ì… ì„ íƒ" autocomplete="off" disabled />
              <div class="list"></div>
            </div>
            <div class="combo" id="cargoTypeComboB">
              <input type="text" placeholder="í™”ë¬¼ íƒ€ì… ì„ íƒ" autocomplete="off" disabled />
              <div class="list"></div>
            </div>
          </div>
        </div>

        <div class="dropdown-container">
          <label class="dropdown-label" for="cargoTypeSelect">ì»¨í…Œì´ë„ˆ íƒ€ì…/CBM ì„ íƒ</label>
          <div class="combo-line">
            <div class="combo" id="typeCombo2">
              <input type="text" placeholder="20FT / 40HC / CONSOLE" autocomplete="off" disabled>
              <div class="list"></div>
            </div>
          </div>
          <div class="combo-line">
            <div class="combo" id="cbmCombo2_Wrapper">
              <input type="text" id="cbmSelect2" placeholder="CBM ì„ íƒ" autocomplete="off">
              <div class="list"></div>
            </div>
          </div>

        <div class="action-row center show revealed">
          <button id="btnFetchTwo" class="primary-btn"><span class="label">ì¡°íšŒ</span></button>
        </div>
      </div>
    </section>
  </div>
</main>

<section id="collapsedPanel" hidden></section>
<section id="collapsedSummary" class="collapsed-summary" hidden>
  <div class="container">
    <div class="chips">
      <button class="chip" data-key="country">
        <span class="k">êµ­ê°€</span><span class="v" id="sumCountry">-</span>
      </button>
      <button class="chip" data-key="region">
        <span class="k">ì§€ì—­</span><span class="v" id="sumRegion">-</span>
      </button>
      <button class="chip" data-key="cbm">
        <span class="k">CBM/ì»¨í…Œì´ë„ˆ</span><span class="v" id="sumCbmType">-</span>
      </button>
      <button class="chip" data-key="company">
        <span class="k">íŒŒíŠ¸ë„ˆ</span><span class="v" id="sumCompany">-</span>
      </button>
    </div>
  </div>
</section>

<section id="resultSection" class="result-section" hidden>
  <section id="currencySection" class="result-currency" hidden>
    <div class="container currency-bar">
      <span id="currencyRate" class="currency-rate">-</span>

      <select id="currencySelect" class="dropdown-select currency-select">
      </select>
    </div>
  </section>
  <div class="result-container container">
    <div id="tableWrap" class="table-wrap"></div>
  </div>
</section>

<section id="resultSectionCompare" class="result-section" hidden>
  <div class="result-container container compare-wrap">

    <!-- A ì»¬ëŸ¼ -->
    <div class="compare-col">
      <div class="compare-top">
        <div class="compare-head">A</div>

        <!-- ğŸ”¹ A ì „ìš© í™˜ìœ¨ + ì¢ì€ ë“œë¡­ë‹¤ìš´ -->
        <div class="currency-bar">
          <span id="currencyRateA" class="currency-rate">-</span>
          <select id="currencySelectA" class="dropdown-select currency-select">
            <!-- currency-converter.js ê°€ ì±„ì›€ -->
          </select>
        </div>
      </div>

      <div id="tableWrapA" class="table-wrap"></div>
    </div>

    <!-- B ì»¬ëŸ¼ -->
    <div class="compare-col">
      <div class="compare-top">
        <div class="compare-head">B</div>

        <!-- ğŸ”¹ B ì „ìš© í™˜ìœ¨ + ì¢ì€ ë“œë¡­ë‹¤ìš´ -->
        <div class="currency-bar">
          <span id="currencyRateB" class="currency-rate">-</span>
          <select id="currencySelectB" class="dropdown-select currency-select">
            <!-- currency-converter.js ê°€ ì±„ì›€ -->
          </select>
        </div>
      </div>

      <div id="tableWrapB" class="table-wrap"></div>
    </div>

  </div>
</section>


<script>
  fetch("../common/header/header.html")
    .then(res => res.text())
    .then(html => {
      document.getElementById("header-placeholder").innerHTML = html;

      // ğŸ”¥ í—¤ë”ê°€ DOMì— ì‚½ì…ëœ ì‹œì ì—ì„œ header.js ì‹¤í–‰
      const s = document.createElement("script");
      s.src = "../common/header/header.js";
      document.body.appendChild(s);
    });
</script>
<!-- =========================== ë¡œê·¸ì¸ ìŠ¤í¬ë¦½íŠ¸ =========================== -->
<script src="../common/js/login.js"></script>
<!-- ====================================================================== -->

<script src="./unified-partners.js"></script>
<script src="./currency-converter.js"></script>
<script>
  window.CostUI?.one?.init();   // one-partner
  window.CostUI?.twoA?.init();  // two-partner A
  window.CostUI?.twoB?.init();  // two-partner B
</script>

<!-- âœ… ë‚˜ë¨¸ì§€ ì „ë¶€(ì›ë³¸ì—ì„œ one-partnerì— í¬í•¨ë˜ì§€ ì•Šì€ ë¡œì§ë§Œ ìœ ì§€) -->
<script>
/* ============================================================================
   0) ì „ì—­ ìƒíƒœ (one-partner-jsì™€ ì¤‘ë³µë˜ì§€ ì•ŠëŠ” ë¶€ë¶„)
   ========================================================================== */

  const BASE = 'https://notion-api-hub.vercel.app';   // âœ… ì „ì—­ BASE ì„ ì–¸ (inline ë¡œë”ë“¤ì´ ì‚¬ìš©)
  /* ============================================================================
     0) ì „ì—­ ìƒíƒœ (one-partner-jsì™€ ì¤‘ë³µë˜ì§€ ì•ŠëŠ” ë¶€ë¶„)
     ========================================================================== */
  const SHELL_STATES = Object.freeze({
    OPEN: 'OPEN',
    COLLAPSING: 'COLLAPSING',
    COLLAPSED: 'COLLAPSED',
    EXPANDING: 'EXPANDING',
  });
let __shellState = SHELL_STATES.OPEN;
let __summaryClickLocked = false;
let __justCollapsedAt = 0;
let __allowExpand = false;

/* ì„ íƒ ì „ìš© ë¡œë”© ìŠ¤í”¼ë„ˆ(used elsewhere) */
function setSelectLoading(selectId, on){
  const sel = document.getElementById(selectId);
  if (!sel) return;
  sel.classList.toggle('is-loading', !!on);
  const next = sel.nextElementSibling;
  if (next && next.classList.contains('select-spinner')) next.remove();
  if (on){
    const sp = document.createElement('span');
    sp.className = 'select-spinner';
    sel.insertAdjacentElement('afterend', sp);
  }
}
// âœ… .comboìš© ê°„ë‹¨ ìŠ¤í”¼ë„ˆ (countryCombo / regionCombo ì „ìš©)
function setComboLoadingFor(id, on){
  const root = document.getElementById(id);
  if (!root) return;
  root.classList.toggle('is-loading', !!on);
}


/* ì™¸ë¶€ ìŠ¤í¬ë¦½íŠ¸/ìŠ¤íƒ€ì¼ ë¡œë” */
function loadCssOnce(href){
  return new Promise((res, rej)=>{
    if (document.querySelector(`link[href="${href}"]`)) return res();
    const l = document.createElement('link');
    l.rel='stylesheet'; l.href=href; l.onload=res; l.onerror=rej; document.head.appendChild(l);
  });
}
function loadJsOnce(src){
  return new Promise((res, rej)=>{
    if (document.querySelector(`script[src="${src}"]`)) return res();
    const s = document.createElement('script');
    s.src=src; s.onload=res; s.onerror=rej; document.head.appendChild(s);
  });
}

/* ê°€ë‚˜ë‹¤/ì•ŒíŒŒ ì •ë ¬ + íƒ€ì…ì–´í—¤ë“œ(êµ­ê°€/ì§€ì—­ìš©) */
function sortKoAZ(arr){
  return (arr||[]).slice().filter(Boolean)
    .sort((a,b)=> String(a).localeCompare(String(b),'ko',{sensitivity:'base'}));
}
function enhanceTypeAhead(id, baseItems){
  const root  = document.getElementById(id);
  const input = root?.querySelector('input');
  const api   = window[id] || null;
  if (!root || !input) return;

  const list  = root.querySelector('.list');
  if (!list) return;

  // ë¦¬ìŠ¤íŠ¸ì— í•­ëª© ë„£ê³ , í´ë¦­ ë°”ì¸ë”©ê¹Œì§€ ë§¤ë²ˆ ë‹¤ì‹œ ì—°ê²°
  const setItems = (arr)=>{
    if (api && typeof api.setItems === 'function') {
      api.setItems(arr);
      return;
    }
    list.innerHTML = (arr||[]).map(v=>`<div class="item" data-v="${v}">${v}</div>`).join('');
    // âœ… í´ë¦­í•˜ë©´ ê°’ ë°˜ì˜ + ë¦¬ìŠ¤íŠ¸ ë‹«ê¸° + change ì´ë²¤íŠ¸ ë°œìƒ
    list.querySelectorAll('.item').forEach(it=>{
      it.addEventListener('click', ()=>{
        input.value = it.getAttribute('data-v') || '';
        list.style.display = 'none';
        input.dispatchEvent(new Event('change',{bubbles:true}));
      });
    });
  };

  const baseSorted = sortKoAZ(baseItems);
  setItems(baseSorted);

  // âœ… í¬ì»¤ìŠ¤/ì…ë ¥ ì‹œ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ
  input.addEventListener('focus', ()=>{ list.style.display='block'; });
  input.addEventListener('input', ()=>{
    list.style.display='block';
    const q = String(input.value||'').trim().toLowerCase();
    if (!q){ setItems(baseSorted); return; }

    const matched = [];
    const unmatched = [];
    for (const v of baseSorted){
      const s = String(v).toLowerCase();
      const idx = s.indexOf(q);
      if (idx === -1){ unmatched.push(v); continue; }
      const score = (idx === 0) ? 0 : (100 + idx);
      matched.push({v, score});
    }
    matched.sort((a,b)=> (a.score-b.score) || a.v.localeCompare(b.v,'ko',{sensitivity:'base'}));
    setItems([...matched.map(x=>x.v), ...unmatched]);
  }, {passive:true});

  // âœ… ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
  document.addEventListener('pointerdown',(e)=>{
    if (!root.contains(e.target)) list.style.display='none';
  });
}


/* ============================================================================
   1) ì§€ë„(Leaflet) - one-partner-jsì—ëŠ” ì—†ìŒ
   ========================================================================== */
const LCSS = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.css";
const LJS  = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js";
const GCSS = "https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css";
const GJS  = "https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js";

let map, markerLayer, geocoder, mapInited=false, mapData=null, tmpSearch=null;
let __countryPoints = [];
const pinReg    = '#2563eb';
const pinSearch = '#ef4444';

let currentRegionMarker = null;

function makeSvgPinIcon(color){
  const svg = `<svg class="pin-svg" viewBox="0 0 24 24" aria-hidden="true"><path fill="${color}" d="M12 2C8.134 2 5 5.134 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.866-3.134-7-7-7zm0 9.5a2.5 2.5 0 1 1 0-5a2.5 2.5 0 0 1 0 5z"/></svg>`;
  return L.divIcon({ className:"", html:`<div class="pin-wrap">${svg}</div>`, iconSize:[26,26], iconAnchor:[13,26] });
}
function normalizeCountryKey(raw){ return String(raw||'').trim(); }

function haversineKm(aLat,aLng,bLat,bLng){
  const R=6371, dLat=(bLat-aLat)*Math.PI/180, dLng=(bLng-aLng)*Math.PI/180;
  const A=Math.sin(dLat/2)**2+Math.cos(aLat*Math.PI/180)*Math.cos(bLat*Math.PI/180)*Math.sin(dLng/2)**2;
  return 2*R*Math.asin(Math.sqrt(A));
}
function findNearest(lat,lng,pts){
  if(!pts?.length) return null;
  let best=null,bd=Infinity;
  for(const p of pts){
    const d=haversineKm(lat,lng,p.lat,p.lng);
    if(d<bd){best=p;bd=d;}
  }
  return {point:best,distanceKm:bd};
}

async function initAlwaysOnMap(){
  if (mapInited) return;
  await loadCssOnce(LCSS); await loadJsOnce(LJS);
  await loadCssOnce(GCSS); await loadJsOnce(GJS);

  const worldBounds = L.latLngBounds([[-85,-180],[85,180]]);
  map = L.map('mpkMap', { center:[20,0], zoom:2, worldCopyJump:false, maxBounds:worldBounds, maxBoundsViscosity:1.0 });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OSM', noWrap:true, bounds:worldBounds }).addTo(map);
  markerLayer = L.layerGroup().addTo(map);

  const WORLD = L.latLngBounds([-85, -180], [85, 180]);
  function fitMinZoomToContainer({ cover = true } = {}) {
    map.invalidateSize();
    const z = map.getBoundsZoom(WORLD, cover);
    map.setMinZoom(z);
    map.setMaxBounds(WORLD);
    map.options.maxBoundsViscosity = 1.0;
    const center = map.getCenter();
    map.setView(center || [0, 0], z);
  }
  requestAnimationFrame(() => fitMinZoomToContainer({ cover: true }));
  window.addEventListener('resize', () => fitMinZoomToContainer({ cover: true }));

  /*â˜…20251127ìˆ˜ì •*/
  geocoder = L.Control.geocoder({ 
    defaultMarkGeocode:false, 
    collapsed: false,   // ğŸ”¹ ì¤‘ìš”: ì²˜ìŒë¶€í„° í¼ì³ì§„ ìƒíƒœë¡œ ê³ ì •
    position: 'topleft',
    placeholder: "êµ­ê°€ ì„ íƒ í›„ ì§€ì—­ ê²€ìƒ‰ ê°€ëŠ¥", // ğŸ”¹ ì•ˆë‚´ ë¬¸êµ¬ ë³€ê²½
    errorMessage: "ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." // (ì„ íƒì‚¬í•­) ì—ëŸ¬ ë©”ì‹œì§€ í•œê¸€í™”
  })
    .on('markgeocode', (e)=>{
      const c = e.geocode.center;
      if (tmpSearch) { map.removeLayer(tmpSearch); tmpSearch=null; }
      tmpSearch = L.marker(c, {icon: makeSvgPinIcon(pinSearch)}).addTo(map);
      map.setView(c, 9);

      const hit = findNearest(c.lat, c.lng, __countryPoints);
      if (hit?.point){
        setRegion(hit.point.name);
      }
    }).addTo(map);

  try{
    const r = await fetch('./map.json', {cache:'no-store'});
    mapData = await r.json();
  }catch(e){
    console.warn('map.json ë¡œë“œ ì‹¤íŒ¨:', e);
    mapData = {};
  }

  mapInited = true;
  setTimeout(()=> map.invalidateSize(), 100);
}
function setMapCountry(country){
  if (!mapInited) return;
  markerLayer.clearLayers();
  __countryPoints = [];
  if (!mapData) return;
  const key = normalizeCountryKey(country);
  const pts = mapData[key];
  if (!pts || !pts.length){ return; }

  const bounds = [];
  pts.forEach(p=>{
    const m = L.marker([p.lat, p.lng], { icon: makeSvgPinIcon(pinReg) }).addTo(markerLayer);
    m.on('click', ()=>{ setRegion(p.name); });
    __countryPoints.push({ ...p, marker:m });
    bounds.push([p.lat, p.lng]);
  });
  if (bounds.length) map.fitBounds(bounds, { padding:[20,20] });
}


function zoomToRegion(regionName, {fallbackZoom=11} = {}){   // ğŸ” ê¸°ë³¸ ì¤Œì„ 11ë¡œ ì¡°ê¸ˆ ë” í™•ëŒ€
  if (!map || !regionName) return;
  const name = String(regionName).trim();
  if (!name) return;

  let hit = __countryPoints?.find(p => {
    const a = (p.name || '').replace(/,/g,'').trim().toLowerCase();
    const b = name.replace(/,/g,'').trim().toLowerCase();
    return a === b;
  });
  if (!hit && Array.isArray(__countryPoints)) {
    const b = name.replace(/,/g,'').trim().toLowerCase();
    hit = __countryPoints.find(p => (p.name||'').toLowerCase().includes(b));
  }

  if (hit && Number.isFinite(hit.lat) && Number.isFinite(hit.lng)) {
    const target = [hit.lat, hit.lng];

    // 1) ì§€ë„ ë·° ì´ë™
    map.setView(target, fallbackZoom, { animate:true });

    // 2) ê¸°ì¡´ ì„ íƒ ë§ˆì»¤ ì œê±°
    if (currentRegionMarker){
      try { markerLayer.removeLayer(currentRegionMarker); } catch(_){}
      currentRegionMarker = null;
    }

    // 3) ì„ íƒëœ ì§€ì—­ ìœ„ì¹˜ì— ğŸ”´ ë¹¨ê°„ ë§ˆì»¤ ì¶”ê°€
    currentRegionMarker = L.marker(target, { icon: makeSvgPinIcon(pinSearch) })
      .addTo(markerLayer);

    // 4) ê¸°ì¡´ íŒŒë€ ë§ˆì»¤ì— íŒì—…ì´ ìˆìœ¼ë©´ ì—´ì–´ì£¼ê¸°(ìˆìœ¼ë©´)
    try { hit.marker?.openPopup?.(); } catch(_){}
  }
}

function getCountry(){ const el = document.querySelector('#countryCombo input'); return el?.value?.trim() || ''; }
function getRegion(){  const el = document.querySelector('#regionCombo input');  return el?.value?.trim() || ''; }
function setRegion(v){
  const combo = document.querySelector('#regionCombo input');
  if (combo){
    combo.value = v;
    combo.dispatchEvent(new Event('input',{bubbles:true}));
    combo.dispatchEvent(new Event('change',{bubbles:true}));
  }
  zoomToRegion(v, { fallbackZoom: 12 });
}

/* ============================================================================
   2) íŒ¨ë„ í† ê¸€(ë¹„ìš© ì¡°íšŒ/ë¹„êµ íƒ­) - one-partner-jsì— ì—†ìŒ
   ========================================================================== */
  (function(){
    const btnCheck = document.getElementById('costCheck');
    const btnComp  = document.getElementById('costComparison');

    function activate(btn){
      [btnCheck, btnComp].forEach(b=> b?.classList.remove('is-active'));
      btn?.classList.add('is-active');
    }

    function showPanel(which){
      const one = document.getElementById('one-partner');
      const two = document.getElementById('two-partner');
      const showOne = (which === 'one');
      if (one) one.hidden = !showOne;
      if (two) two.hidden = showOne;
      btnCheck?.setAttribute('aria-expanded', String(showOne));
      btnComp ?.setAttribute('aria-expanded', String(!showOne));
      (showOne ? one : two)?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    btnCheck?.addEventListener('click', () => {
      activate(btnCheck);
      showPanel('one');
    });

    btnComp ?.addEventListener('click', () => {
      activate(btnComp);
      showPanel('two');

      // ğŸ”¥ ë¹„êµ ëª¨ë“œë¡œ ì „í™˜í•  ë•Œ A/B íšŒì‚¬ ë“œë¡­ë‹¤ìš´ ê°•ì œ ì´ˆê¸° ë¡œë”©
      window.CostUI?.twoA?.loadCompanies();
      window.CostUI?.twoB?.loadCompanies();
    });
  })();

/* í•„ìš” ì‹œ one-partner í‘œì‹œ ì „ìš© */
function showPartnerContainer(){
  const partnerContainer = document.getElementById('one-partner');
  if (partnerContainer){
    partnerContainer.hidden = false;
    partnerContainer.style.display = 'block';
    partnerContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
}
document.getElementById('costCheck')?.addEventListener('click', showPartnerContainer);

/* ============================================================================
   3) ì…¸ ì ‘í˜/í¼ì¹¨ - one-partner-jsì—ì„œ í˜¸ì¶œë§Œ í•¨
   ========================================================================== */
function collapseShell(){
  return new Promise((resolve)=>{
    const shell = document.querySelector('.app-shell');
    if (!shell) return resolve();

    if (__shellState === SHELL_STATES.COLLAPSED || __shellState === SHELL_STATES.COLLAPSING) {
      return resolve();
    }

    __shellState = SHELL_STATES.COLLAPSING;

    shell.classList.remove('is-collapsed','is-expanding');
    shell.style.display = 'block';
    const h = shell.scrollHeight;
    shell.style.maxHeight = h + 'px';

    requestAnimationFrame(()=>{
      shell.classList.add('is-collapsing');
      shell.style.maxHeight = '0px';
    });

    const onEnd = (e)=>{
      if (e.propertyName !== 'max-height') return;
      shell.removeEventListener('transitionend', onEnd);
      shell.classList.remove('is-collapsing');
      shell.classList.add('is-collapsed');
      shell.style.maxHeight = '';
      shell.style.display = 'none';
      __shellState = SHELL_STATES.COLLAPSED;
      __justCollapsedAt = performance.now();
      resolve();
    };
    shell.addEventListener('transitionend', onEnd);
  });
}

function expandShell(){
  return new Promise((resolve)=>{
    const shell = document.querySelector('.app-shell');
    if (!shell) return resolve();
    if (!__allowExpand || __shellState !== SHELL_STATES.COLLAPSED) {
      return resolve();
    }

    __shellState = SHELL_STATES.EXPANDING;

    shell.classList.remove('is-collapsed');
    shell.style.display = 'block';
    shell.style.maxHeight = '0px';

    requestAnimationFrame(()=>{
      shell.classList.add('is-expanding');
      const h = shell.scrollHeight;
      shell.style.maxHeight = h + 'px';
    });

    const onEnd = (e)=>{
      if (e.propertyName !== 'max-height') return;
      shell.removeEventListener('transitionend', onEnd);
      shell.classList.remove('is-expanding');
      shell.style.maxHeight = '';
      __shellState = SHELL_STATES.OPEN;
      __allowExpand = false;
      resolve();
    };
    shell.addEventListener('transitionend', onEnd);
  });
}

/* ============================================================================
   4) êµ­ê°€/ì§€ì—­ ë¡œë”© (one-partner-jsì— ì—†ëŠ” ë¶€ë¶„ ìœ ì§€)
   ========================================================================== */
async function loadCountries(){
  const countryAPI = window['countryCombo'] || null;
  const root = document.getElementById('countryCombo');
  const input = root?.querySelector('input');

  setComboLoadingFor('countryCombo', true);   // âœ… ìŠ¤í”¼ë„ˆ on
  try{
    const r = await fetch(`${BASE}/api/debug/config`, {cache:'no-store'});
    const j = await r.json();
    const countries = sortKoAZ(j.countries || Object.keys(j.dbStructure||{}) || []);

    // ê°„ë‹¨ ì„¸íŒ…
    if (countryAPI && typeof countryAPI.setItems === 'function') countryAPI.setItems(countries);
    else {
      const list = root?.querySelector('.list');
      if (input && list){
        input.addEventListener('focus', ()=>{ list.style.display='block'; });
        input.addEventListener('input', ()=>{ list.style.display='block'; });
        document.addEventListener('pointerdown',(e)=>{
          if (!root.contains(e.target)) list.style.display='none';
        });
      }
    }
    if (input) input.disabled = false;

    enhanceTypeAhead('countryCombo', countries);
  }catch(e){
    console.warn('loadCountries ì‹¤íŒ¨:', e);
    if (input) input.disabled = false;
  }finally{
    setComboLoadingFor('countryCombo', false); // âœ… ìŠ¤í”¼ë„ˆ off
  }
}


async function loadRegions(){
  const root = document.getElementById('regionCombo');
  const input = root?.querySelector('input');
  const list  = root?.querySelector('.list');
  const country = getCountry();
  if (!country || !list || !input) return;

  setComboLoadingFor('regionCombo', true);   // âœ… ìŠ¤í”¼ë„ˆ on
  try{
    const r = await fetch(`${BASE}/api/regions/${encodeURIComponent(country)}`, {cache:'no-store'});
    const j = await r.json();
    const regions = sortKoAZ(j.regions || []);
    list.innerHTML = regions.map(v=>`<div class="item" data-v="${v}">${v}</div>`).join('');
    list.querySelectorAll('.item').forEach(it=>{
      it.addEventListener('click', ()=>{
        input.value = it.getAttribute('data-v') || '';
        list.style.display = 'none';
        input.dispatchEvent(new Event('change',{bubbles:true}));
      });
    });
    input.disabled = false;
    enhanceTypeAhead('regionCombo', regions);

    if (input && list){
      input.addEventListener('focus', ()=>{ list.style.display='block'; });
      input.addEventListener('input', ()=>{ list.style.display='block'; });
      document.addEventListener('pointerdown',(e)=>{
        if (!root.contains(e.target)) list.style.display='none';
      });
    }
  }catch(e){
    console.warn('loadRegions ì‹¤íŒ¨:', e);
  }finally{
    setComboLoadingFor('regionCombo', false); // âœ… ìŠ¤í”¼ë„ˆ off
  }
}


/* ============================================================================
   5) ì´ë²¤íŠ¸ ë°”ì¸ë”©(ë‚˜ë¨¸ì§€ ì „ë¶€)
   - êµ­ê°€ ë³€ê²½: ì§€ì—­ ë¡œë“œ + ì§€ë„ ê°±ì‹ 
   - ì§€ì—­ ë³€ê²½: ì§€ë„ ì¤Œ(ì—…ì²´/POE/í™”ë¬¼íƒ€ì… ë¡œë“œëŠ” one-partner-jsì—ì„œ ì²˜ë¦¬)
   - ìš”ì•½ í´ë¦­ ì‹œ ì¬ì˜¤í”ˆ
   ========================================================================== */
function wireEventsRemainder(){
  const ccEl = document.querySelector('#countryCombo input') || document.getElementById('countryCombo');
  const rcEl = document.querySelector('#regionCombo input')  || document.getElementById('regionCombo');

  ccEl?.addEventListener('change', async ()=>{
    await loadRegions();
    const c = getCountry();
    if (c) setMapCountry(c);
  });

  rcEl?.addEventListener('change', async ()=>{
    const region = getRegion();
    if (region) zoomToRegion(region, { fallbackZoom: 12 });
  });

  const sumRoot  = document.getElementById('collapsedSummary');       // ì„¹ì…˜ ì „ì²´
  const sumInner = sumRoot?.querySelector('.container');              // ì•ˆìª½ ì»¨í…Œì´ë„ˆ
  
  if (sumRoot && sumInner) {
    sumInner.addEventListener('click', (e)=>{
      if (__summaryClickLocked) return;
      if (performance.now() - __justCollapsedAt < 450) {
        e.preventDefault();
        e.stopPropagation();
        return;
      }
      __allowExpand = true;
      expandShell().then(()=>{
        // âœ… ê²°ê³¼í‘œ/ë¹„êµí‘œë„ ê°™ì´ ìˆ¨ê¹€
        const r1 = document.getElementById('resultSection');
        const r2 = document.getElementById('resultSectionCompare');
        if (r1){ r1.classList.remove('show'); r1.hidden = true; }
        if (r2){ r2.classList.remove('show'); r2.hidden = true; }
  
        // ì„¹ì…˜ ì „ì²´ëŠ” ì—¬ì „íˆ ìˆ¨ê¹€
        sumRoot.hidden = true;
        document.querySelector('.app-shell')?.scrollIntoView({behavior:'smooth', block:'start'});
      });
    });
  }
}

/* ============================================================================
   [ì—…ê·¸ë ˆì´ë“œ] CBM ì½¤ë³´ë°•ìŠ¤ (ì§ì ‘ ì…ë ¥ + ë“œë¡­ë‹¤ìš´ ì„ íƒ)
   ========================================================================== */
/* ============================================================================
   [ìµœì¢… ìˆ˜ì •] CBM ì½¤ë³´ë°•ìŠ¤ (1~68 ì •ìˆ˜ / ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ / ê²€ìƒ‰ ê°€ëŠ¥)
   ========================================================================== */
function initCbmCombos() {
  // 1. CBM ëª©ë¡ ë°ì´í„° ìƒì„± (1 ~ 68 ì •ìˆ˜)
  const cbmData = [];
  for (let i = 1; i <= 68; i++) {
    cbmData.push(i + " CBM"); // ì†Œìˆ˜ì  ì œê±°, ì •ìˆ˜ + CBM
  }

  // 2. ì½¤ë³´ë°•ìŠ¤ ë™ì‘ ì—°ê²°
  function setupCbm(wrapperId) {
    const root = document.getElementById(wrapperId);
    if (!root) return;
    
    const input = root.querySelector('input');
    const list = root.querySelector('.list');
    if (!input || !list) return;

    // ë¦¬ìŠ¤íŠ¸ ê·¸ë¦¬ê¸° í•¨ìˆ˜
    const renderList = (items) => {
      if (items.length === 0) {
        list.innerHTML = '<div class="item" style="pointer-events:none; color:#aaa;">ê²°ê³¼ ì—†ìŒ</div>';
      } else {
        list.innerHTML = items.map(v => `<div class="item" data-v="${v}">${v}</div>`).join('');
      }
      
      // í•­ëª© í´ë¦­ ì´ë²¤íŠ¸
      list.querySelectorAll('.item').forEach(item => {
        if(!item.hasAttribute('data-v')) return;
        item.addEventListener('click', () => {
          input.value = item.getAttribute('data-v'); 
          list.style.display = 'none';
        });
      });
    };

    renderList(cbmData);

    // ì´ë²¤íŠ¸: ë¦¬ìŠ¤íŠ¸ ì—´ê¸°
    const openList = () => {
      document.querySelectorAll('.combo .list').forEach(el => {
        if(el !== list) el.style.display = 'none';
      });
      list.style.display = 'block';
    };
    input.addEventListener('click', openList);
    input.addEventListener('focus', openList);

    // ì´ë²¤íŠ¸: ê²€ìƒ‰ ê¸°ëŠ¥
    input.addEventListener('input', () => {
      list.style.display = 'block';
      const val = input.value.trim().toLowerCase();
      // "CBM" ê¸€ìë¥¼ ì œì™¸í•˜ê³  ìˆ«ìë§Œìœ¼ë¡œë„ ê²€ìƒ‰ë˜ê²Œ í•„í„°ë§
      const filtered = cbmData.filter(item => item.toLowerCase().includes(val));
      renderList(filtered);
    });

    // ì´ë²¤íŠ¸: ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
    document.addEventListener('click', (e) => {
      if (!root.contains(e.target)) list.style.display = 'none';
    });
  }

  setupCbm('cbmCombo_Wrapper');  
  setupCbm('cbmCombo2_Wrapper'); 
}

window.addEventListener('DOMContentLoaded', () => {
  initCbmCombos();
});


/* ============================================================================
   6) ì´ˆê¸°í™”
   ========================================================================== */
window.addEventListener('DOMContentLoaded', async ()=>{
  try{ await initAlwaysOnMap(); }catch(_){}
  await loadCountries();
  wireEventsRemainder();

  // ì´ˆê¸° êµ­ê°€ê°€ ìˆìœ¼ë©´ ì§€ë„ ë°˜ì˜
  const initialCountry = getCountry();
  if (initialCountry) setMapCountry(initialCountry);

  // one-partner ì´ˆê¸°í™” (íƒ€ì…/CBM/ì´ë²¤íŠ¸ ë°”ì¸ë”©)
    window.CostUI?.one?.init();
    window.CostUI?.twoA?.init();
    window.CostUI?.twoB?.init();
});
</script>
</body>
</html>




