<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>도착지 비용 계산</title>

  <!-- 폰트: 로그인 페이지와 동일 -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="./styles.css" />
</head>
<body>
  <div class="page-bg" aria-hidden="true"></div>

  <!-- 상단 바 -->
  <header class="site-header">
    <div class="container header-inner">
      <a class="brand" href="#">
        <img src="https://arrrbang.github.io/pumex/image/pumexlogonew.png" alt="PUMEX Logo" class="brand__logo" />
      </a>
      <a class="header__title" href="#">도착지 비용 계산</a>
      <nav class="header__nav" aria-label="상단 링크"> // 이동할 링크 추가
      </nav>
    </div>
  </header>

  <!-- 메인 -->
  <main class="container section">
    
<div class="selection-summary" id="selectionSummary"></div>
    
<div class="dropdown-container">
  <div class="dropdown" id="dropdownMenu">
    <div class="dropdown-inner">
      <label class="dropdown-label" for="countryCombo">국가 선택</label>
      <div class="combo" id="countryCombo">
        <input type="text" placeholder="국가를 입력/선택 (예: 미국, 중국)" autocomplete="off">
        <div class="list"></div>
      </div>

      <div class="dropdown-label-row">
        <span class="label-text">지역 선택</span>
        <button id="btnSelectOnMap" type="button" class="map-button-inline">지도에서 선택</button>

      </div>
      <div class="combo" id="regionCombo">
        <input type="text" placeholder="지역을 입력/선택 (예: A지역, B지역)" autocomplete="off" disabled>
        <div class="list"></div>
      </div>
      <div class="action-row">
        <button id="btnSelectFirst" class="select-btn" type="button">선택</button>
      </div>
    </div>
  </div>
</div>

<div class="dropdown-container">
  <div class="dropdown" id="nextDropdowns">
    <div class="dropdown-inner">
      <label class="dropdown-label" for="cargoTypeSelect">화물타입</label>
      <select id="cargoTypeSelect" class="dropdown-select"></select>
      
      <label class="dropdown-label" for="typeCombo">컨테이너 타입</label>
      <div class="combo" id="typeCombo">
        <input type="text" placeholder="20FT / 40HC / CONSOLE" autocomplete="off" value="20FT">
        <div class="list"></div>
      </div>

      <label class="dropdown-label" for="cbmSelect">CBM 선택</label>
      <select id="cbmSelect" class="dropdown-select"></select>

      <div class="action-row">
        <button id="btnSelectSecond" class="select-btn" type="button">선택</button>
      </div>
    </div>
  </div>
</div>

<div class="selection-summary" id="nextSelectionSummary"></div>

<div class="selection-summary" id="thirdSelectionSummary"></div>

<div class="dropdown-container">
  <div class="dropdown" id="thirdDropdowns">
    <div class="dropdown-inner">
      <label class="dropdown-label" for="companyCombo">업체 선택</label>
      <div class="combo" id="companyCombo">
        <input type="text" placeholder="업체를 입력/선택 (예: A업체, B업체)" autocomplete="off" disabled>
        <div class="list"></div>
      </div>

      <label class="dropdown-label" for="poeCombo">POE 선택</label>
      <div class="combo" id="poeCombo">
        <input type="text" placeholder="POE를 입력/선택 (예: DAMMAM, RIYADH DRY PORT)" autocomplete="off" disabled>
        <div class="list"></div>
      </div>
      <div class="action-row">
        <button id="btnSelectThird" class="select-btn" type="button">선택</button>
      </div>
    </div>
  </div>
</div>

<div class="action-row center">
  <button id="btnFetch" class="primary-btn" type="button">조회</button>
</div>

<section id="resultSection" class="result-section">
  <div class="result-container">
    <div id="tableWrap" class="table-wrap"></div>
  </div>
</section>


</main>

<script>
/* =========================================================
   App Core — Dropdowns + Combos + Map Picker (완성본)
   요구 HTML ID:
   - 1차 컨테이너: #dropdownMenu   / 요약: #selectionSummary
   - 2차 컨테이너: #nextDropdowns  / 요약: #nextSelectionSummary
   - 콤보: #countryCombo, #regionCombo, #companyCombo, #typeCombo
   - 셀렉트: #cbmSelect
   - 지도버튼: #btnSelectOnMap
   외부 API (Notion Hub): BASE
========================================================= */

/* ------------------------------
   공통 유틸
------------------------------ */
const BASE = 'https://notion-api-hub.vercel.app';
const $  = (s, r=document)=>r.querySelector(s);

/* ------------------------------
   Floating(포털) 콤보 리스트 관리자
   - 부모 overflow에 잘리지 않도록 .list를 body로 띄움
------------------------------ */
const Floating = (() => {
  const mounts = new Map(); // listEl -> { comboEl, wrap, onScroll, onResize }
  function open(comboEl){
    const input = comboEl.querySelector('input');
    const list  = comboEl.querySelector('.list');
    if(!input || !list) return;

    if(mounts.has(list)){ position(comboEl); return; }

    const wrap = document.createElement('div');
    wrap.className = 'combo-float-wrap';
    wrap.style.position = 'fixed';
    wrap.style.zIndex = '1200';
    wrap.style.left = '0'; wrap.style.top = '0';
    wrap.style.width = '0'; wrap.style.height = '0';
    document.body.appendChild(wrap);

    list.dataset.__float = '1';
    wrap.appendChild(list);

    const onScroll = () => position(comboEl);
    const onResize = () => position(comboEl);
    window.addEventListener('scroll', onScroll, true);
    window.addEventListener('resize', onResize);

    mounts.set(list, { comboEl, wrap, onScroll, onResize });
    position(comboEl);
  }
  function position(comboEl){
    const input = comboEl.querySelector('input');
    const list  = getList(comboEl);
    if(!input || !list) return;

    const r = input.getBoundingClientRect();
    list.style.display = 'block';
    list.style.position = 'fixed';
    list.style.left = `${Math.max(8, r.left)}px`;
    list.style.top  = `${r.bottom + 6}px`;
    list.style.width= `${r.width}px`;

    // 화면 하단 넘치면 위로
    const rect = list.getBoundingClientRect();
    if(rect.bottom > window.innerHeight - 8){
      list.style.top = `${Math.max(8, r.top - 6 - rect.height)}px`;
    }
  }
  function close(comboEl){
    const list = getList(comboEl);
    if(!list) return;
    const mount = mounts.get(list);
    if(!mount) return;
    window.removeEventListener('scroll', mount.onScroll, true);
    window.removeEventListener('resize', mount.onResize);
    mounts.delete(list);

    list.removeAttribute('style');
    list.removeAttribute('data-__float');
    mount.wrap.remove();
    comboEl.appendChild(list);
    list.style.display = 'none';
  }
  function getList(comboEl){
    const floated = document.querySelector('.list[data-__float="1"]');
    return floated || comboEl.querySelector('.list');
  }
  function isInsideFloating(target){
    return !!target.closest('.combo-float-wrap') || !!target.closest('.list[data-__float="1"]');
  }
  return { open, close, position, isInsideFloating };
})();

/* ------------------------------
   타이핑 콤보 (검색/선택 가능)
------------------------------ */
function makeCombo(el, items=[]){
  const input = el.querySelector('input');
  const list  = el.querySelector('.list');
  let data = [...items];
  let selected = null;

  function render(filter=''){
    const f = (filter||'').trim().toLowerCase();
    list.innerHTML='';
    const filtered = f ? data.filter(x=>x.toLowerCase().includes(f)) : [...data];
    const sorted = filtered.sort((a,b)=>{
      const an=Number(a), bn=Number(b);
      if(!isNaN(an)&&!isNaN(bn)) return an-bn;
      const ap=f && a.toLowerCase().startsWith(f)?0:1;
      const bp=f && b.toLowerCase().startsWith(f)?0:1;
      if(ap!==bp) return ap-bp;
      return a.localeCompare(b, 'ko');
    });
    sorted.forEach(v=>{
      const d=document.createElement('div');
      d.className='item' + (selected===v ? ' is-selected':'');
      d.textContent=v;
      d.addEventListener('click', (e)=>{
        e.stopPropagation();
        selected=v;
        input.value=v;
        // 콤보는 선택 시 닫음(요구사항)
        el.classList.remove('open');
        Floating.close(el);
        el.dispatchEvent(new CustomEvent('change',{detail:v}));
      });
      list.appendChild(d);
    });
  }
  function setItems(arr){
    data = [...new Set((arr||[]).filter(Boolean))];
    input.disabled = data.length===0;
    if(document.activeElement!==input) input.value='';
    selected=null;
    render(input.value);
  }
  function getValue(){ return selected || input.value.trim(); }
  function setValue(v){ selected=v||null; input.value=v??''; render(input.value); el.dispatchEvent(new CustomEvent('change',{detail:v})); }

  input.addEventListener('focus', ()=>{
    el.classList.add('open'); render(input.value); Floating.open(el);
  });
  input.addEventListener('input', ()=>{
    el.classList.add('open'); render(input.value); Floating.open(el);
  });
  input.addEventListener('keydown', (e)=>{
    if(e.key==='Enter'){
      const first=(Floating.isInsideFloating(document.activeElement)?document:el).querySelector('.item');
      if(first) first.click();
    }
  });

  ['pointerdown','mousedown','click','touchstart'].forEach(evt=>{
    list.addEventListener(evt, e=>e.stopPropagation(), {passive:true});
    input.addEventListener(evt, e=>e.stopPropagation(), {passive:true});
  });

  setItems(items);
  return { setItems, getValue, setValue, root: el, input, list };
}

/* ------------------------------
   요소 참조
------------------------------ */
const dropdownMenu   = $("#dropdownMenu");
const nextDropdowns  = $("#nextDropdowns");
const summary        = $("#selectionSummary");
const nextSummary    = $("#nextSelectionSummary");

const countryCombo = makeCombo(document.getElementById('countryCombo'));
const regionCombo  = makeCombo(document.getElementById('regionCombo'));
const companyCombo = makeCombo(document.getElementById('companyCombo'));
const typeCombo    = makeCombo(document.getElementById('typeCombo'), ['20FT','40HC','CONSOLE']);

const cbmSelect    = $("#cbmSelect");

const thirdDropdowns = document.getElementById('thirdDropdowns');
const thirdSummary   = document.getElementById('thirdSelectionSummary');
const poeCombo       = makeCombo(document.getElementById('poeCombo'));

let isThirdVisible   = false;
let isDropdownVisible=false;
let isNextVisible=false;

// === [NEW] 콤보 리스트(플로팅)만 닫기 유틸 ===
function closeAllCombos(){
  const combos = [countryCombo, regionCombo, companyCombo, typeCombo, poeCombo].filter(Boolean);
  combos.forEach(c=>{
    try{
      c.root.classList.remove('open');
      Floating.close(c.root);
    }catch(_){}
  });
}
// === [NEW] 컨테이너 내부 빈 곳 클릭하면, 콤보/리스트만 닫기 (컨테이너는 그대로) ===
['dropdownMenu','nextDropdowns','thirdDropdowns'].forEach(id=>{
  const container = document.getElementById(id);
  if(!container) return;

  container.addEventListener('pointerdown', (e)=>{
    const t = e.target;

    // 1) 콤보 input/리스트 클릭이면 닫지 않음
    if (t.closest('.combo') || (Floating?.isInsideFloating?.(t))) return;

    // 2) 컨테이너 내부의 빈 영역/라벨/버튼 등 클릭 → 콤보만 닫기
    closeAllCombos();

    // 3) 네이티브 <select>가 열려 있었다면 포커스만 제거 (실제 '강제 닫기' 대용)
    container.querySelectorAll('select').forEach(sel => sel.blur());
  }, { passive:true });
});

// === 각 단계의 <선택> 버튼 → 다음 단계로 진행 ===
document.getElementById('btnSelectFirst')?.addEventListener('click', ()=>{
  // 1단계(국가/지역) 컨테이너 닫고 → 요약 노출 → 2단계 자동 오픈 (기존 closeFirst 로직)
  closeFirst();
});

document.getElementById('btnSelectSecond')?.addEventListener('click', ()=>{
  // 2단계(화물타입/컨테이너/CBM) 닫고 → 요약 노출 → 3단계 자동 오픈 (기존 closeSecond 로직)
  closeSecond();
});

document.getElementById('btnSelectThird')?.addEventListener('click', ()=>{
  // 3단계(업체/POE) 닫고 → 요약 노출 + 조회 버튼 애니메이션(기존 closeThird 로직)
  closeThird();
});
  
/* ------------------------------
   1차/2차 컨테이너 열고 닫기
------------------------------ */
function openFirst(){
  dropdownMenu.classList.add('show');
  summary.classList.remove('show');
  nextDropdowns.classList.remove('show');
  nextSummary.classList.remove('show');
  isDropdownVisible=true;
}
function closeFirst(){
  dropdownMenu.classList.remove('show');
  isDropdownVisible=false;
  setTimeout(()=>{ showFirstSummary(); openSecond(); }, 400);
}
function openSecond(){
  nextDropdowns.classList.add('show');
  nextSummary.classList.remove('show');
  isNextVisible=true;
}
function closeSecond(){
  nextDropdowns.classList.remove('show');
  isNextVisible=false;
  setTimeout(()=>{
    const t   = typeCombo.getValue() || '미선택';
    const cbmText = cbmSelect?.value
      ? (cbmSelect.options[cbmSelect.selectedIndex]?.text || cbmSelect.value)
      : '미선택';
    const text = `${esc(cbmText)} CBM (${esc(t)})`;
    nextSummary.innerHTML = `<span class="summary-hot">${text}</span>`;
    nextSummary.classList.add('show');

    openThird();
  }, 400);
}

function openThird(){
  thirdDropdowns.classList.add('show');
  thirdSummary.classList.remove('show');
  isThirdVisible = true;
  
  document.querySelector('.action-row.center')?.classList.remove('revealed');
}
function closeThird(){
  thirdDropdowns.classList.remove('show');
  isThirdVisible = false;
  setTimeout(()=>{
    const comp = (companyCombo.getValue() || '미선택');
    const poe  = (poeCombo.getValue()     || '미선택');
    const text = `${esc(comp)} (POE: ${esc(poe)})`;
    thirdSummary.innerHTML = `<span class="summary-hot">${text}</span>`;
    thirdSummary.classList.add('show');

    document.querySelector('.action-row.center')?.classList.add('revealed');
  }, 400);
}


function showFirstSummary(){
  const c = countryCombo.getValue();
  const r = regionCombo.getValue();
  if (!summary) return;
  if (!c && !r && !comp) return;

  const text = `[${esc(r)}, ${esc(c)}]`;
  summary.innerHTML = `<span class="summary-hot">${text}</span>`;
  summary.classList.add('show');
}

/* ------------------------------
   전역 “바깥 클릭 닫기”
   - 지도 모달이 열려 있을 땐 닫기 로직 스킵
   - 콤보 떠있는 리스트 클릭은 내부로 간주
------------------------------ */
let MAP_MODAL_OPEN = false;
document.addEventListener('pointerdown', (e)=>{
  if (MAP_MODAL_OPEN) return; // 지도 열려 있으면 스킵

  if (isDropdownVisible) {
    const insideDropdown = dropdownMenu.contains(e.target);
    const insideFloating = Floating?.isInsideFloating?.(e.target);
    if (!insideDropdown && !insideFloating) closeFirst();
  }
  if (isNextVisible) {
    const inside2 = nextDropdowns.contains(e.target);
    if (!inside2) closeSecond();
  }
  if (isThirdVisible) {
    const inside3 = thirdDropdowns.contains(e.target);
    if (!inside3) closeThird();
  }
}, { passive:true });

/* ------------------------------
   API 연동: 국가→지역→업체
------------------------------ */
async function loadCountries(){
  try{
    const r = await fetch(`${BASE}/api/debug/config`);
    const j = await r.json();
    const countries = j.countries || Object.keys(j.dbStructure||{}) || [];
    countryCombo.setItems(countries);
  }catch(e){ countryCombo.setItems([]); }
}
countryCombo.root.addEventListener('change', async ()=>{
  const country = countryCombo.getValue();
  regionCombo.setItems([]); companyCombo.setItems([]); poeCombo.setItems([]);
  regionCombo.input.disabled = true; companyCombo.input.disabled = true; poeCombo.input.disabled = true;
  if(!country) return;
  try{
    const r = await fetch(`${BASE}/api/regions/${encodeURIComponent(country)}`);
    const j = await r.json();
    regionCombo.setItems(j.regions||[]);
    regionCombo.input.disabled = false;
  }catch(e){ regionCombo.setItems([]); }
  updateCargoTypeOptions();
});
regionCombo.root.addEventListener('change', async ()=>{
  const country = countryCombo.getValue();
  const region  = regionCombo.getValue();
  companyCombo.setItems([]); companyCombo.input.disabled = true;
  poeCombo.setItems([]);     poeCombo.input.disabled     = true;
  if(!country || !region) return;
  try{
    const url = `${BASE}/api/companies/by-region?country=${encodeURIComponent(country)}&region=${encodeURIComponent(region)}&mode=options`;
    const r = await fetch(url);
    const j = await r.json();
    const companies = (j.companies || []).filter(Boolean);
    companyCombo.setItems(companies);
    companyCombo.input.disabled = companies.length === 0;
  }catch(e){
    companyCombo.setItems([]); 
    companyCombo.input.disabled = true;
  }
  updateCargoTypeOptions();

});
companyCombo.root.addEventListener('change', async ()=>{
  const country = countryCombo.getValue();
  const region  = regionCombo.getValue();
  const company = companyCombo.getValue();

  poeCombo.setItems([]); 
  poeCombo.input.disabled = true;

  if(!country || !region || !company) return;

  try{
    // ✅ 백엔드가 /api/poe/by-company 제공 시 (권장)
    const url = `${BASE}/api/poe/by-company?country=${encodeURIComponent(country)}&region=${encodeURIComponent(region)}&company=${encodeURIComponent(company)}&mode=data`;
    const r   = await fetch(url);
    const j   = await r.json();
    const poes = (j.poes || []).filter(Boolean);
    poeCombo.setItems(poes);
    poeCombo.input.disabled = poes.length === 0 ? true : false;
  }catch(e){
    poeCombo.setItems([]); 
    poeCombo.input.disabled = true;
  }
  updateCargoTypeOptions();
});


/* ------------------------------
   화물타입 & 컨테이너 타입 & CBM
------------------------------ */
// 화물타입 옵션 세팅
function setCargoTypeOptions(values){
  const el = document.getElementById('cargoTypeSelect');
  if(!el) return;
  const opts = ['<option value="">화물타입 선택</option>']
    .concat((values||[]).map(v=>`<option value="${String(v)}">${String(v)}</option>`));
  el.innerHTML = opts.join('');
}

// 지역/업체에 따라 화물타입 동적 구성 (기본값: DIPLOMAT/NON-DIPLOMAT)
function updateCargoTypeOptions(){
  const country = window.countryCombo?.getValue?.() || document.querySelector('#countryCombo input')?.value?.trim();
  const region  = window.regionCombo?.getValue?.()  || document.querySelector('#regionCombo input')?.value?.trim();
  const company = window.companyCombo?.getValue?.() || document.querySelector('#companyCombo input')?.value?.trim();

  // 기본값
  let values = ['DIPLOMAT','NON-DIPLOMAT'];

  // 필요 시 조건 분기 (예: 특정 업체/지역에서만 DIPLOMAT 허용 등)
  // if (company === 'XXX') values = ['NON-DIPLOMAT'];
  // if (region?.includes('Embassy')) values = ['DIPLOMAT'];

  setCargoTypeOptions(values);
  toggleFetchVisibility?.();
}

function setOptions(selectEl, values, placeholder='CBM 선택'){
  const opts = ['<option value="">'+placeholder+'</option>']
   .concat(values.map(v=>`<option value="${String(v)}">${String(v)}</option>`));
  selectEl.innerHTML = opts.join('');
}
function fillCbmByType(type){
  if(!cbmSelect) return;
  const T=(type||'').toUpperCase();
  let values=[];
  if(!T){ setOptions(cbmSelect,[], 'CBM 선택'); return; }
  if(T==='CONSOLE'){ values = Array.from({length:30},(_,i)=>i+1); }
  else { values = [5,10,15,20,25,30,35,40]; }
  setOptions(cbmSelect, values);
}
typeCombo.root.addEventListener('change', ()=> fillCbmByType(typeCombo.getValue()) );

/* =========================================================
   MapPicker — ORIGINAL 기반 지도 팝업
   - 버튼 id="btnSelectOnMap" 클릭 시 팝업
   - map.json: ./map.json (destinationcost/map.json)
========================================================= */
function loadCssOnce(href){ return new Promise((res, rej)=>{ if(document.querySelector(`link[href="${href}"]`)) return res(); const l=document.createElement('link'); l.rel='stylesheet'; l.href=href; l.onload=res; l.onerror=rej; document.head.appendChild(l); }); }
function loadJsOnce(src){ return new Promise((res, rej)=>{ if(document.querySelector(`script[src="${src}"]`)) return res(); const s=document.createElement('script'); s.src=src; s.onload=res; s.onerror=rej; document.head.appendChild(s); }); }
const LCSS  = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.css";
const LJS   = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js";
const GCSS  = "https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css";
const GJS   = "https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js";

function getCountry(){ if (window.countryCombo?.getValue) return window.countryCombo.getValue(); const el = document.querySelector('#countryCombo input'); return el?.value?.trim() || ''; }
function getRegion(){  if (window.regionCombo?.getValue)  return window.regionCombo.getValue();  const el = document.querySelector('#regionCombo input');  return el?.value?.trim() || ''; }
function setRegion(v){ if (window.regionCombo?.setValue)  return window.regionCombo.setValue(v);  const el = document.querySelector('#regionCombo input');  if(el){ el.value = v; el.dispatchEvent(new Event('input')); } }

let __sticky = null;
function toast(msg, {sticky=false, timeout=1500}={}) {
  if (__sticky) { __sticky.remove(); __sticky = null; }
  }
  if (sticky) {
    if (__sticky) __sticky.remove();
    const el = document.createElement('div');
      el.innerHTML = `<div style="
        position:fixed;left:50%;top:33vh;transform:translate(-50%,-50%);
        background:rgba(17,17,17,.92);color:#fff;padding:12px 16px;
        border-radius:12px;border:1px solid rgba(255,255,255,.15);
        box-shadow:0 10px 30px rgba(0,0,0,.35);z-index:10000;
        font-size:14px;line-height:1.4;display:flex;gap:12px;align-items:center;
        max-width:min(90vw,640px);text-align:center
      ">
        <span>${msg}</span>
        <button type="button" style="background:#fff;color:#111;border:0;border-radius:10px;padding:6px 12px;cursor:pointer;">닫기</button>
      </div>`;
    el.querySelector('button').onclick = ()=>{ el.remove(); __sticky=null; };
    document.body.appendChild(el); __sticky = el; return;
  }
  const d = document.createElement('div');
  d.textContent = msg;
  d.style.cssText = `
    position:fixed;left:50%;top:33vh;transform:translate(-50%,-50%);
    background:rgba(0,0,0,.85);color:#fff;padding:10px 14px;
    border-radius:12px;z-index:10000;font-size:14px;line-height:1.4;
    box-shadow:0 10px 30px rgba(0,0,0,.35);max-width:min(90vw,640px);
    text-align:center
  `;
  document.body.appendChild(d); setTimeout(()=>d.remove(), timeout);
}

function haversineKm(aLat,aLng,bLat,bLng){ const R=6371, dLat=(bLat-aLat)*Math.PI/180, dLng=(bLng-aLng)*Math.PI/180; const A=Math.sin(dLat/2)**2+Math.cos(aLat*Math.PI/180)*Math.cos(bLat*Math.PI/180)*Math.sin(dLng/2)**2; return 2*R*Math.asin(Math.sqrt(A)); }
function findNearest(lat,lng,pts){ if(!pts?.length) return null; let best=null,bd=Infinity; for(const p of pts){ const d=haversineKm(lat,lng,p.lat,p.lng); if(d<bd){best=p;bd=d;} } return {point:best,distanceKm:bd}; }

let map, markerLayer, geocoder, mapInited=false, mapData=null, tmpSearch=null;
const pinReg    = '#2563eb';
const pinSearch = '#ef4444';

function makeSvgPinIcon(color, withLabel=false, labelText="") {
  const svg = `<svg class="pin-svg" viewBox="0 0 24 24" aria-hidden="true"><path fill="${color}" d="M12 2C8.134 2 5 5.134 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.866-3.134-7-7-7zm0 9.5a2.5 2.5 0 1 1 0-5a2.5 2.5 0 0 1 0 5z"/></svg>`;
  const labelHtml = withLabel ? `<div class="pin-label">${String(labelText).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]))}</div>` : "";
  const html = `<div class="pin-wrap">${svg}${labelHtml}</div>`;
  return L.divIcon({ className: "", html, iconSize: [26,26], iconAnchor: [13,26] });
}

function ensureModal() {
  if (document.getElementById('mapPickerModal')) return;
  const wrap = document.createElement('div');
  wrap.id = 'mapPickerModal';
  wrap.innerHTML = `
    <div class="mpk__backdrop" style="position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:2000;"></div>
    <div class="mpk__panel" style="position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:min(95vw,980px);background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.35);z-index:2001;display:flex;flex-direction:column;overflow:hidden;">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #e5e7eb;">
        <strong style="font-size:16px;color:#111">지도에서 지역 선택</strong>
        <div style="display:flex;gap:8px;">
          <button type="button" id="mpkBtnConfirm" style="border:1px solid #1F9461;background:#1F9461;color:#fff;border-radius:8px;padding:8px 12px;cursor:pointer;">선택 완료</button>
          <button type="button" id="mpkBtnClose"   style="border:1px solid #e5e7eb;background:#fff;color:#111;border-radius:8px;padding:8px 12px;cursor:pointer;">닫기</button>
        </div>
      </div>
      <div id="mpkMap" style="height:520px;"></div>
      <div style="padding:10px 14px;color:#4b5563;font-size:13px;border-top:1px solid #e5e7eb;background:#f8fafc;">
        • 핀을 클릭하면 해당 지역이 자동 선택됩니다. • 돋보기로 위치 검색 가능 • 등록되지 않은 자유 입력은 최근접 등록 지역으로 보정됩니다.
      </div>
    </div>
  `;
  document.body.appendChild(wrap);
  wrap.querySelector('#mpkBtnClose').onclick = closeModal;
  wrap.querySelector('.mpk__backdrop').onclick = closeModal;
  wrap.querySelector('#mpkBtnConfirm').onclick = ()=>{
  // 지도의 '가장 가까운 등록 지역' 안내(sticky)도 함께 닫기
  closeStickyToast();        // ★ [NEW]
  closeModal();
};
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });
}

async function ensureMapReady() {
  if (!mapInited) {
    await loadCssOnce(LCSS); await loadJsOnce(LJS);
    await loadCssOnce(GCSS); await loadJsOnce(GJS);

    const worldBounds = L.latLngBounds([[-85,-180],[85,180]]);
    map = L.map('mpkMap', { center:[20,0], zoom:2, worldCopyJump:false, maxBounds:worldBounds, maxBoundsViscosity:1.0 });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OSM', noWrap:true, bounds:worldBounds }).addTo(map);
    markerLayer = L.layerGroup().addTo(map);

    geocoder = L.Control.geocoder({ defaultMarkGeocode:false })
      .on('markgeocode', (e)=>{
        const c = e.geocode.center;
        if (tmpSearch) { map.removeLayer(tmpSearch); tmpSearch=null; }
        tmpSearch = L.marker(c, {icon: makeSvgPinIcon(pinSearch,false)}).addTo(map);
        map.setView(c, 9);

        const pts = __countryPoints;
        if (pts?.length) {
          const hit = findNearest(c.lat,c.lng,pts);
          if (hit?.point) {
            setRegion(hit.point.name);
            toast(`가장 가까운 등록 지역: ${hit.point.name} (~${hit.distanceKm.toFixed(1)}km)`, {sticky:true});

            // ★ 1차 컨테이너 유지 (지도 동작 중에는 항상 열린 상태)
            dropdownMenu?.classList.add('show');
            isDropdownVisible = true;
          }
        }
      }).addTo(map);

    try {
      const r = await fetch('./map.json', { cache:'no-store' });  // ← destinationcost/map.json
      mapData = await r.json();
    } catch(e) {
      console.warn('map.json 로드 실패:', e);
      mapData = {};
    }
    mapInited = true;
  }
  setTimeout(()=> map.invalidateSize(), 50);
}

let __countryPoints = [];
function setMapCountry(country) {
  if (!mapInited) return;
  markerLayer.clearLayers();
  __countryPoints = [];
  if (!mapData || !mapData[country]) return;

  const pts = mapData[country];
  const bounds = [];

  pts.forEach(p => {
    const m = L.marker([p.lat, p.lng], { icon: makeSvgPinIcon(pinReg, false) })
      .addTo(markerLayer);

    // 핀 클릭 시: 지역값 세팅 + 1차 컨테이너 유지
    m.on('click', () => {
      setRegion(p.name);
      toast(`지역 선택: ${p.name}`);
      dropdownMenu?.classList.add('show');
      isDropdownVisible = true;
    });

    __countryPoints.push({ ...p, marker: m });
    bounds.push([p.lat, p.lng]);
  });

  if (bounds.length) {
    map.fitBounds(bounds, { padding: [20, 20] });
  }
}


/* ------------------------------
   지도 모달 열기/닫기 + 스냅샷 복구
------------------------------ */
let __uiSnapshot = {
  isDropdownVisible: false,
  isNextVisible: false,
  dropdownMenuHadShow: false,
  nextDropdownsHadShow: false,
  summaryHadShow: false,
  nextSummaryHadShow: false,
};

function openModal(){
  ensureModal();
  // 지도 열기 직전 상태 저장
  __uiSnapshot = {
    isDropdownVisible,
    isNextVisible,
    dropdownMenuHadShow:  dropdownMenu?.classList.contains('show'),
    nextDropdownsHadShow: nextDropdowns?.classList.contains('show'),
    summaryHadShow:       summary?.classList.contains('show'),
    nextSummaryHadShow:   nextSummary?.classList.contains('show'),
  };
  MAP_MODAL_OPEN = true;

  const m = document.getElementById('mapPickerModal');
  if (m) m.style.display = 'block';
}
function closeModal(){
  closeStickyToast(); // ★ [NEW] 닫기 버튼/배경 클릭/ESC 등 모든 경로에서 sticky 닫기
  const m = document.getElementById('mapPickerModal');
  if (m) m.style.display = 'none';
  MAP_MODAL_OPEN = false;

  // ★ 지도 닫힌 후: 1차 컨테이너는 열린 상태로 복귀
  dropdownMenu?.classList.add('show');
  isDropdownVisible = true;

  // ★ 지도 열기 전 상태로 2차/요약 복구(강제 '미선택' 방지)
  summary?.classList.toggle('show', __uiSnapshot.summaryHadShow);
  nextDropdowns?.classList.toggle('show', __uiSnapshot.nextDropdownsHadShow);
  isNextVisible = __uiSnapshot.nextDropdownsHadShow;
  nextSummary?.classList.toggle('show', __uiSnapshot.nextSummaryHadShow);
}

/* ------------------------------
   지도 버튼 바인딩
------------------------------ */
const __bindMapBtn = ()=>{
  const btn = document.getElementById('btnSelectOnMap');
  if (!btn) return;
  btn.addEventListener('click', async ()=>{
    openModal();
    await ensureMapReady();
    const c = getCountry();
    if (c) setMapCountry(c);
  }, { once:false });
};
if (document.readyState !== 'loading') __bindMapBtn();
else document.addEventListener('DOMContentLoaded', __bindMapBtn);

/* ------------------------------
   초기화
------------------------------ */
window.addEventListener('DOMContentLoaded', async ()=>{
  await loadCountries();
  fillCbmByType(typeCombo.getValue() || '20FT');
  openFirst();               // 첫 드롭다운 자동 열기
  updateCargoTypeOptions();  // 화물타입 초기화
});


/** ========= 조회 버튼 → API 호출 ========= */

// === 조회 버튼 표시 토글 ===
const actionRowCenter = document.querySelector('.action-row.center');

function allReady() {
  const country = window.countryCombo?.getValue?.() || document.querySelector('#countryCombo input')?.value?.trim();
  const region  = window.regionCombo?.getValue?.()  || document.querySelector('#regionCombo input')?.value?.trim();
  const company = window.companyCombo?.getValue?.() || document.querySelector('#companyCombo input')?.value?.trim();
  const type    = window.typeCombo?.getValue?.()    || document.querySelector('#typeCombo input')?.value?.trim() || '20FT';
  const cargo   = document.getElementById('cargoTypeSelect')?.value || '';

  const cbmSel  = document.getElementById('cbmSelect');
  const cbmOk   = (String(type).toUpperCase()==='CONSOLE') ? !!cbmSel?.value : true;

  // 필수: 국가, 업체, 화물타입 (+ 콘솔이면 CBM)
  return !!country && !!company && !!cargo && cbmOk;
}


function toggleFetchVisibility() {
  if (!actionRowCenter) return;
  actionRowCenter.classList.toggle('show', allReady());
}

// 콤보/셀렉트가 바뀔 때마다 체크
['countryCombo','regionCombo','companyCombo','poeCombo','typeCombo'].forEach(id=>{
  const root = document.getElementById(id);
  if (!root) return;
  root.addEventListener('change', toggleFetchVisibility);
});
document.getElementById('cbmSelect')?.addEventListener('change', toggleFetchVisibility);
document.getElementById('cargoTypeSelect')?.addEventListener('change', toggleFetchVisibility);


// 지도에서 지역을 설정하는 경우도 반영
window.addEventListener('DOMContentLoaded', ()=>{
  toggleFetchVisibility(); // 초기 1회
});

// 조회 성공 시 표 영역은 기존 코드대로 .show 추가됨

document.getElementById('btnFetch')?.addEventListener('click', async () => {
  try{
    // 현재 콤보/셀렉트에서 값 읽기 (ID는 INDEX(43)과 동일)
    const country = window.countryCombo?.getValue?.() || document.querySelector('#countryCombo input')?.value?.trim();
    const region  = window.regionCombo?.getValue?.()  || document.querySelector('#regionCombo input')?.value?.trim();
    const company = window.companyCombo?.getValue?.() || document.querySelector('#companyCombo input')?.value?.trim();
    const type    = window.typeCombo?.getValue?.()    || document.querySelector('#typeCombo input')?.value?.trim() || '20FT';
    const cbmSel  = document.getElementById('cbmSelect');
    const cbm     = cbmSel?.value ? Number(cbmSel.value) : undefined;

    if (!country){ alert('국가를 선택하세요.'); return; }
    if (!company){ alert('업체를 선택하세요.'); return; }

    // 화물타입 드롭다운 값으로 roles 설정
    const cargoSel = document.getElementById('cargoTypeSelect');
    const roles = [];
    const cargo = cargoSel?.value?.trim();
    if (cargo) roles.push(cargo.toUpperCase()); // 'DIPLOMAT' 또는 'NON-DIPLOMAT'


    const params = new URLSearchParams();
    params.set('type', type);
    params.set('company', company);
    if (region) params.set('region', region);
    if (roles.length) params.set('roles', roles.join(','));
    if (!isNaN(cbm)) params.set('cbm', String(cbm));

    const url = `${BASE}/api/costs/${encodeURIComponent(country)}?${params.toString()}`;
    const res = await fetch(url);
    const j   = await res.json();

    // 숫자 포맷 메타 저장 → 금액 포맷에 사용
    __numberFormats = j?.numberFormats || {};

    // 표 렌더링 (단일 지역 필터 여부에 따라 컬럼 구성 달라짐)
    renderTable(j, type, Boolean(region));
    const rs = document.getElementById('resultSection');
    if (rs) rs.classList.add('show');
  }catch(e){
    console.error(e);
    alert('조회 중 오류가 발생했습니다.');
  }
});

  // === 써머리 클릭 시 해당 드롭다운 재오픈 ===
// 1단계 써머리 클릭 → 1단계 드롭다운 열기
summary?.addEventListener('click', (e)=>{
  if (!(e.target instanceof HTMLElement)) return;
  if (!e.target.classList.contains('summary-hot')) return; // ← 텍스트만 반응
  openFirst();
  document.getElementById('resultSection')?.classList.remove('show');
  document.querySelector('.action-row.center')?.classList.remove('revealed');
});

// 2단계 써머리 클릭 → 2단계 드롭다운 열기
nextSummary?.addEventListener('click', (e)=>{
  if (!(e.target instanceof HTMLElement)) return;
  if (!e.target.classList.contains('summary-hot')) return;
  dropdownMenu?.classList.remove('show');
  isDropdownVisible = false;
  openSecond();
  document.getElementById('resultSection')?.classList.remove('show');
  document.querySelector('.action-row.center')?.classList.remove('revealed');
});

// 3단계 써머리 클릭 → 3단계 드롭다운 열기
thirdSummary?.addEventListener('click', (e)=>{
  if (!(e.target instanceof HTMLElement)) return;
  if (!e.target.classList.contains('summary-hot')) return;
  openThird();
  document.getElementById('resultSection')?.classList.remove('show');
  document.querySelector('.action-row.center')?.classList.remove('revealed');
});


  
/** ========= 결과 표 렌더링 유틸 ========= */

// Notion 숫자 포맷 메타 저장용 (백엔드 /api/costs 응답에 포함됨)
let __numberFormats = {};

function esc(s){ return String(s==null?'':s)
  .replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

function formatAmount(n, columnKey){
  if (n==null || n==='' || isNaN(Number(n))) return '';
  const v = Number(n);
  const fmt = __numberFormats?.[columnKey] || '';
  // 아주 단순 매핑 — 필요 시 확대 가능
  if (/dollar|usd/i.test(fmt)) return '$' + v.toLocaleString('en-US');
  if (/won|krw/i.test(fmt))    return '₩' + v.toLocaleString('ko-KR');
  if (/euro|eur/i.test(fmt))   return '€' + v.toLocaleString('de-DE');
  return v.toLocaleString(); // 기본
}

/**
 * renderTable(data, type, isRegionFiltered)
 * - data.rows: [{ item, region, extra, "20FT", "40HC", "CONSOLE", ... }]
 * - type: 현재 선택 타입(20FT/40HC/CONSOLE)
 * - isRegionFiltered: region 파라미터를 넣어 단일 지역으로 조회했는지 여부
 */
function renderTable(data, type, isRegionFiltered){
  const wrap = document.getElementById('tableWrap');
  if (!wrap){ return; }

  const rows = Array.isArray(data?.rows) ? data.rows : [];
  if (!rows.length){
    wrap.innerHTML = '<div class="muted">표시할 데이터가 없습니다.</div>';
    return;
  }

  // 헤더 구성
  let thead = '<tr><th>항목</th>';
  if (!isRegionFiltered) thead += '<th>지역</th>';
  thead += `<th class="type-col">${esc(type)}</th><th>비고</th></tr>`;

  // 바디 구성
  let tbody = '';
  for (const r of rows){
    const amt = r?.[type];
    const amtText = formatAmount(amt, type) || '-';
    tbody += '<tr>';
    tbody += `<td>${esc(r.item || '')}</td>`;
    if (!isRegionFiltered) tbody += `<td>${esc(r.region || '')}</td>`;
    tbody += `<td class="amt">${amtText}</td>`;
    // extra는 백엔드에서 안전한 HTML(링크/줄바꿈) 형태로 내려줄 수 있음
    tbody += `<td>${r.extra || ''}</td>`;
    tbody += '</tr>';
  }

  // 렌더
  wrap.innerHTML = `
    <table class="result-table">
      <thead>${thead}</thead>
      <tbody>${tbody}</tbody>
    </table>
  `;
}
</script>



</body>
</html>
