<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë„ì°©ì§€ ë¹„ìš© ê³„ì‚°</title>

  <!-- í°íŠ¸: ë¡œê·¸ì¸ í˜ì´ì§€ì™€ ë™ì¼ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="./styles2.css" />
</head>
<body>
  <div class="page-bg" aria-hidden="true"></div>

  <!-- ìƒë‹¨ ë°” -->
  <header class="site-header">
    <div class="container header-inner">
      <a class="brand" href="#">
        <img src="https://arrrbang.github.io/pumex/image/pumexlogonew.png" alt="PUMEX Logo" class="brand__logo" />
      </a>
      <a class="header__title" href="#">ë„ì°©ì§€ ë¹„ìš© ê³„ì‚°</a>
      <nav class="header__nav" aria-label="ìƒë‹¨ ë§í¬"> // ì´ë™í•  ë§í¬ ì¶”ê°€
      </nav>
    </div>
  </header>

  <!-- ë©”ì¸ -->
  <main class="container section">
    
<div class="selection-summary" id="selectionSummary"></div>
    
<div class="dropdown-container">
  <div class="dropdown" id="dropdownMenu">
    <div class="dropdown-inner">
      <label class="dropdown-label" for="countryCombo">êµ­ê°€ ì„ íƒ</label>
      <div class="combo" id="countryCombo">
        <input type="text" placeholder="êµ­ê°€ë¥¼ ì…ë ¥/ì„ íƒ (ì˜ˆ: ë¯¸êµ­, ì¤‘êµ­)" autocomplete="off">
        <div class="list"></div>
      </div>

      <div class="dropdown-label-row">
        <span class="label-text">ì§€ì—­ ì„ íƒ</span>
        <button id="btnSelectOnMap" type="button" class="map-button-inline">ì§€ë„ì—ì„œ ì„ íƒ</button>
      </div>
      
      <div class="combo" id="regionCombo">
        <input type="text" placeholder="ì§€ì—­ì„ ì…ë ¥/ì„ íƒ (ì˜ˆ: Aì§€ì—­, Bì§€ì—­)" autocomplete="off" disabled>
        <div class="list"></div>
      </div>
      <div class="action-row">
        <button id="btnSelectFirst" class="select-btn" type="button">ì„ íƒ</button>
      </div>
    </div>
  </div>
</div>

<div class="dropdown-container">
  <div class="dropdown" id="nextDropdowns">
    <div class="dropdown-inner">
      <label class="dropdown-label" for="cargoTypeSelect">í™”ë¬¼íƒ€ì…</label>
      <select id="cargoTypeSelect" class="dropdown-select"></select>
      
      <label class="dropdown-label" for="typeCombo">ì»¨í…Œì´ë„ˆ íƒ€ì…</label>
      <div class="combo" id="typeCombo">
        <input type="text" placeholder="20FT / 40HC / CONSOLE" autocomplete="off" value="20FT">
        <div class="list"></div>
      </div>

      <label class="dropdown-label" for="cbmSelect">CBM ì„ íƒ</label>
      <select id="cbmSelect" class="dropdown-select"></select>

      <div class="action-row">
        <button id="btnSelectSecond" class="select-btn" type="button">ì„ íƒ</button>
      </div>
    </div>
  </div>
</div>

<div class="selection-summary" id="nextSelectionSummary"></div>

<div class="selection-summary" id="thirdSelectionSummary"></div>

<!-- 3ë‹¨ê³„: A/B ë‘ ì»¬ëŸ¼ ë¹„êµ -->
<div class="compare-grid">
  <!-- A ì»¬ëŸ¼ -->
  <div class="dropdown-container">
    <div class="dropdown" id="thirdDropdownsA">
      <div class="dropdown-inner">
        <label class="dropdown-label" for="companyComboA">ì—…ì²´ ì„ íƒ (A)</label>
        <div class="combo" id="companyComboA">
          <input type="text" placeholder="ì—…ì²´ë¥¼ ì…ë ¥/ì„ íƒ (ì˜ˆ: Aì—…ì²´)" autocomplete="off" disabled>
          <div class="list"></div>
        </div>

        <label class="dropdown-label" for="poeComboA">POE ì„ íƒ (A)</label>
        <div class="combo" id="poeComboA">
          <input type="text" placeholder="POEë¥¼ ì…ë ¥/ì„ íƒ" autocomplete="off" disabled>
          <div class="list"></div>
        </div>

        <div class="action-row">
          <button id="btnSelectThirdA" class="select-btn" type="button">ì„ íƒ(A)</button>
        </div>
      </div>
    </div>
  </div>

  <!-- B ì»¬ëŸ¼ -->
  <div class="dropdown-container">
    <div class="dropdown" id="thirdDropdownsB">
      <div class="dropdown-inner">
        <label class="dropdown-label" for="companyComboB">ì—…ì²´ ì„ íƒ (B)</label>
        <div class="combo" id="companyComboB">
          <input type="text" placeholder="ì—…ì²´ë¥¼ ì…ë ¥/ì„ íƒ (ì˜ˆ: Bì—…ì²´)" autocomplete="off" disabled>
          <div class="list"></div>
        </div>

        <label class="dropdown-label" for="poeComboB">POE ì„ íƒ (B)</label>
        <div class="combo" id="poeComboB">
          <input type="text" placeholder="POEë¥¼ ì…ë ¥/ì„ íƒ" autocomplete="off" disabled>
          <div class="list"></div>
        </div>

        <div class="action-row">
          <button id="btnSelectThirdB" class="select-btn" type="button">ì„ íƒ(B)</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ì¡°íšŒ ë²„íŠ¼ì€ í•˜ë‚˜ë¡œ ê³µìœ  -->
<div class="action-row center compare-grid">
  <button id="btnFetchA" class="primary-btn" type="button">ì¡°íšŒ (A)</button>
  <button id="btnFetchB" class="primary-btn" type="button">ì¡°íšŒ (B)</button>
</div>

<section id="resultSection" class="result-section">
  <div class="result-container compare-grid">
    <div>
      <h3 class="muted">A ì—…ì²´ ê²°ê³¼</h3>
      <div id="tableWrapA" class="table-wrap"></div>
    </div>
    <div>
      <h3 class="muted">B ì—…ì²´ ê²°ê³¼</h3>
      <div id="tableWrapB" class="table-wrap"></div>
    </div>
  </div>
</section>



</main>

<script>
/* =========================================================
   App Core â€” Dropdowns + Combos + Map Picker (ì™„ì„±ë³¸)
   ìš”êµ¬ HTML ID:
   - 1ì°¨ ì»¨í…Œì´ë„ˆ: #dropdownMenu   / ìš”ì•½: #selectionSummary
   - 2ì°¨ ì»¨í…Œì´ë„ˆ: #nextDropdowns  / ìš”ì•½: #nextSelectionSummary
   - ì½¤ë³´: #countryCombo, #regionCombo, #companyCombo, #typeCombo
   - ì…€ë ‰íŠ¸: #cbmSelect
   - ì§€ë„ë²„íŠ¼: #btnSelectOnMap
   ì™¸ë¶€ API (Notion Hub): BASE
========================================================= */

/* ------------------------------
   ê³µí†µ ìœ í‹¸
------------------------------ */
const BASE = 'https://notion-api-hub.vercel.app';
const $  = (s, r=document)=>r.querySelector(s);

/* ------------------------------
   Floating(í¬í„¸) ì½¤ë³´ ë¦¬ìŠ¤íŠ¸ ê´€ë¦¬ì
   - ë¶€ëª¨ overflowì— ì˜ë¦¬ì§€ ì•Šë„ë¡ .listë¥¼ bodyë¡œ ë„ì›€
------------------------------ */
const Floating = (() => {
  const mounts = new Map(); // listEl -> { comboEl, wrap, onScroll, onResize }
  function open(comboEl){
    const input = comboEl.querySelector('input');
    const list  = comboEl.querySelector('.list');
    if(!input || !list) return;

    if(mounts.has(list)){ position(comboEl); return; }

    const wrap = document.createElement('div');
    wrap.className = 'combo-float-wrap';
    wrap.style.position = 'fixed';
    wrap.style.zIndex = '1200';
    wrap.style.left = '0'; wrap.style.top = '0';
    wrap.style.width = '0'; wrap.style.height = '0';
    document.body.appendChild(wrap);

    list.dataset.__float = '1';
    wrap.appendChild(list);

    const onScroll = () => position(comboEl);
    const onResize = () => position(comboEl);
    window.addEventListener('scroll', onScroll, true);
    window.addEventListener('resize', onResize);

    mounts.set(list, { comboEl, wrap, onScroll, onResize });
    position(comboEl);
  }
  function position(comboEl){
    const input = comboEl.querySelector('input');
    const list  = getList(comboEl);
    if(!input || !list) return;

    const r = input.getBoundingClientRect();
    list.style.display = 'block';
    list.style.position = 'fixed';
    list.style.left = `${Math.max(8, r.left)}px`;
    list.style.top  = `${r.bottom + 6}px`;
    list.style.width= `${r.width}px`;

    // í™”ë©´ í•˜ë‹¨ ë„˜ì¹˜ë©´ ìœ„ë¡œ
    const rect = list.getBoundingClientRect();
    if(rect.bottom > window.innerHeight - 8){
      list.style.top = `${Math.max(8, r.top - 6 - rect.height)}px`;
    }
  }
  function close(comboEl){
    const list = getList(comboEl);
    if(!list) return;
    const mount = mounts.get(list);
    if(!mount) return;
    window.removeEventListener('scroll', mount.onScroll, true);
    window.removeEventListener('resize', mount.onResize);
    mounts.delete(list);

    list.removeAttribute('style');
    list.removeAttribute('data-__float');
    mount.wrap.remove();
    comboEl.appendChild(list);
    list.style.display = 'none';
  }
  function getList(comboEl){
    const floated = document.querySelector('.list[data-__float="1"]');
    return floated || comboEl.querySelector('.list');
  }
  function isInsideFloating(target){
    return !!target.closest('.combo-float-wrap') || !!target.closest('.list[data-__float="1"]');
  }
  return { open, close, position, isInsideFloating };
})();

/* ------------------------------
   íƒ€ì´í•‘ ì½¤ë³´ (ê²€ìƒ‰/ì„ íƒ ê°€ëŠ¥)
------------------------------ */
function makeCombo(el, items=[]){
  const input = el.querySelector('input');
  const list  = el.querySelector('.list');
  let data = [...items];
  let selected = null;

  function render(filter=''){
    const f = (filter||'').trim().toLowerCase();
    list.innerHTML='';
    const filtered = f ? data.filter(x=>x.toLowerCase().includes(f)) : [...data];
    const sorted = filtered.sort((a,b)=>{
      const an=Number(a), bn=Number(b);
      if(!isNaN(an)&&!isNaN(bn)) return an-bn;
      const ap=f && a.toLowerCase().startsWith(f)?0:1;
      const bp=f && b.toLowerCase().startsWith(f)?0:1;
      if(ap!==bp) return ap-bp;
      return a.localeCompare(b, 'ko');
    });
    sorted.forEach(v=>{
      const d=document.createElement('div');
      d.className='item' + (selected===v ? ' is-selected':'');
      d.textContent=v;
      d.addEventListener('click', (e)=>{
        e.stopPropagation();
        selected=v;
        input.value=v;
        // ì½¤ë³´ëŠ” ì„ íƒ ì‹œ ë‹«ìŒ(ìš”êµ¬ì‚¬í•­)
        el.classList.remove('open');
        Floating.close(el);
        el.dispatchEvent(new CustomEvent('change',{detail:v}));
      });
      list.appendChild(d);
    });
  }
  function setItems(arr){
    data = [...new Set((arr||[]).filter(Boolean))];
    input.disabled = data.length===0;
    if(document.activeElement!==input) input.value='';
    selected=null;
    render(input.value);
  }
  function getValue(){ return selected || input.value.trim(); }
  function setValue(v){ selected=v||null; input.value=v??''; render(input.value); el.dispatchEvent(new CustomEvent('change',{detail:v})); }

  input.addEventListener('focus', ()=>{
    el.classList.add('open'); render(input.value); Floating.open(el);
  });
  input.addEventListener('input', ()=>{
    el.classList.add('open'); render(input.value); Floating.open(el);
  });
  input.addEventListener('keydown', (e)=>{
    if(e.key==='Enter'){
      const first=(Floating.isInsideFloating(document.activeElement)?document:el).querySelector('.item');
      if(first) first.click();
    }
  });

  ['pointerdown','mousedown','click','touchstart'].forEach(evt=>{
    list.addEventListener(evt, e=>e.stopPropagation(), {passive:true});
    input.addEventListener(evt, e=>e.stopPropagation(), {passive:true});
  });

  setItems(items);
  return { setItems, getValue, setValue, root: el, input, list };
}

/* ------------------------------
   ìš”ì†Œ ì°¸ì¡°
------------------------------ */
const dropdownMenu   = $("#dropdownMenu");
const nextDropdowns  = $("#nextDropdowns");
const summary        = $("#selectionSummary");
const nextSummary    = $("#nextSelectionSummary");

const countryCombo = makeCombo(document.getElementById('countryCombo'));
const regionCombo  = makeCombo(document.getElementById('regionCombo'));
const typeCombo    = makeCombo(document.getElementById('typeCombo'), ['20FT','40HC','CONSOLE']);
const companyComboA = makeCombo(document.getElementById('companyComboA'));
const companyComboB = makeCombo(document.getElementById('companyComboB'));
const poeComboA     = makeCombo(document.getElementById('poeComboA'));
const poeComboB     = makeCombo(document.getElementById('poeComboB'));

const cbmSelect    = $("#cbmSelect");

const thirdDropdownsAEl = document.getElementById('thirdDropdownsA');
const thirdDropdownsBEl = document.getElementById('thirdDropdownsB');
const thirdSummary   = document.getElementById('thirdSelectionSummary');

let isThirdVisible   = false;
let isDropdownVisible=false;
let isNextVisible=false;

// === [NEW] ì½¤ë³´ ë¦¬ìŠ¤íŠ¸(í”Œë¡œíŒ…)ë§Œ ë‹«ê¸° ìœ í‹¸ ===
function closeAllCombos(){
  const combos = [countryCombo, regionCombo, companyCombo, typeCombo, poeCombo].filter(Boolean);
  combos.forEach(c=>{
    try{
      c.root.classList.remove('open');
      Floating.close(c.root);
    }catch(_){}
  });
}
// === [NEW] ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ë¹ˆ ê³³ í´ë¦­í•˜ë©´, ì½¤ë³´/ë¦¬ìŠ¤íŠ¸ë§Œ ë‹«ê¸° (ì»¨í…Œì´ë„ˆëŠ” ê·¸ëŒ€ë¡œ) ===
['dropdownMenu','nextDropdowns','thirdDropdowns'].forEach(id=>{
  const container = document.getElementById(id);
  if(!container) return;

  container.addEventListener('pointerdown', (e)=>{
    const t = e.target;

    // 1) ì½¤ë³´ input/ë¦¬ìŠ¤íŠ¸ í´ë¦­ì´ë©´ ë‹«ì§€ ì•ŠìŒ
    if (t.closest('.combo') || (Floating?.isInsideFloating?.(t))) return;

    // 2) ì»¨í…Œì´ë„ˆ ë‚´ë¶€ì˜ ë¹ˆ ì˜ì—­/ë¼ë²¨/ë²„íŠ¼ ë“± í´ë¦­ â†’ ì½¤ë³´ë§Œ ë‹«ê¸°
    closeAllCombos();

    // 3) ë„¤ì´í‹°ë¸Œ <select>ê°€ ì—´ë ¤ ìˆì—ˆë‹¤ë©´ í¬ì»¤ìŠ¤ë§Œ ì œê±° (ì‹¤ì œ 'ê°•ì œ ë‹«ê¸°' ëŒ€ìš©)
    container.querySelectorAll('select').forEach(sel => sel.blur());
  }, { passive:true });
});

// === ê° ë‹¨ê³„ì˜ <ì„ íƒ> ë²„íŠ¼ â†’ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰ ===
document.getElementById('btnSelectFirst')?.addEventListener('click', ()=>{
  // 1ë‹¨ê³„(êµ­ê°€/ì§€ì—­) ì»¨í…Œì´ë„ˆ ë‹«ê³  â†’ ìš”ì•½ ë…¸ì¶œ â†’ 2ë‹¨ê³„ ìë™ ì˜¤í”ˆ (ê¸°ì¡´ closeFirst ë¡œì§)
  closeFirst();
});

document.getElementById('btnSelectSecond')?.addEventListener('click', ()=>{
  // 2ë‹¨ê³„(í™”ë¬¼íƒ€ì…/ì»¨í…Œì´ë„ˆ/CBM) ë‹«ê³  â†’ ìš”ì•½ ë…¸ì¶œ â†’ 3ë‹¨ê³„ ìë™ ì˜¤í”ˆ (ê¸°ì¡´ closeSecond ë¡œì§)
  closeSecond();
});

document.getElementById('btnSelectThirdA')?.addEventListener('click', closeThird);
document.getElementById('btnSelectThirdB')?.addEventListener('click', closeThird);
  
/* ------------------------------
   1ì°¨/2ì°¨ ì»¨í…Œì´ë„ˆ ì—´ê³  ë‹«ê¸°
------------------------------ */
function openFirst(){
  dropdownMenu.classList.add('show');
  summary.classList.remove('show');
  nextDropdowns.classList.remove('show');
  nextSummary.classList.remove('show');
  isDropdownVisible=true;
}
function closeFirst(){
  dropdownMenu.classList.remove('show');
  isDropdownVisible=false;
  setTimeout(()=>{ showFirstSummary(); openSecond(); }, 400);
}
function openSecond(){
  nextDropdowns.classList.add('show');
  nextSummary.classList.remove('show');
  isNextVisible=true;
}
function closeSecond(){
  nextDropdowns.classList.remove('show');
  isNextVisible=false;
  setTimeout(()=>{
    const t   = typeCombo.getValue() || 'ë¯¸ì„ íƒ';
    const cbmText = cbmSelect?.value
      ? (cbmSelect.options[cbmSelect.selectedIndex]?.text || cbmSelect.value)
      : 'ë¯¸ì„ íƒ';
    const text = `${esc(cbmText)} CBM (${esc(t)})`;
    nextSummary.innerHTML = `<span class="summary-hot">${text}</span>`;
    nextSummary.classList.add('show');

    openThird();
  }, 400);
}

function openThird(){
  document.getElementById('thirdDropdownsA')?.classList.add('show');
  document.getElementById('thirdDropdownsB')?.classList.add('show');
  thirdSummary.classList.remove('show');
  isThirdVisible = true;
  document.querySelector('.action-row.center')?.classList.remove('revealed');
}

function closeThird(){
  document.getElementById('thirdDropdownsA')?.classList.remove('show');
  document.getElementById('thirdDropdownsB')?.classList.remove('show');
  isThirdVisible = false;
  setTimeout(()=>{
    const compA = (companyComboA.getValue() || 'ë¯¸ì„ íƒ');
    const poeA  = (poeComboA.getValue()     || 'ë¯¸ì„ íƒ');
    const compB = (companyComboB.getValue() || 'ë¯¸ì„ íƒ');
    const poeB  = (poeComboB.getValue()     || 'ë¯¸ì„ íƒ');
    const text = `A: ${esc(compA)} (POE: ${esc(poeA)})  |  B: ${esc(compB)} (POE: ${esc(poeB)})`;
    thirdSummary.innerHTML = `<span class="summary-hot">${text}</span>`;
    thirdSummary.classList.add('show');
    document.querySelector('.action-row.center')?.classList.add('revealed');
  }, 400);
}



function showFirstSummary(){
  const c = countryCombo.getValue();
  const r = regionCombo.getValue();
  if (!summary) return;
 if (!c && !r) return;

  const text = `[${esc(r)}, ${esc(c)}]`;
  summary.innerHTML = `<span class="summary-hot">${text}</span>`;
  summary.classList.add('show');
}

/* ------------------------------
   ì „ì—­ â€œë°”ê¹¥ í´ë¦­ ë‹«ê¸°â€
   - ì§€ë„ ëª¨ë‹¬ì´ ì—´ë ¤ ìˆì„ ë• ë‹«ê¸° ë¡œì§ ìŠ¤í‚µ
   - ì½¤ë³´ ë– ìˆëŠ” ë¦¬ìŠ¤íŠ¸ í´ë¦­ì€ ë‚´ë¶€ë¡œ ê°„ì£¼
------------------------------ */
let MAP_MODAL_OPEN = false;
document.addEventListener('pointerdown', (e)=>{
  if (MAP_MODAL_OPEN) return; // ì§€ë„ ì—´ë ¤ ìˆìœ¼ë©´ ìŠ¤í‚µ

  if (isDropdownVisible) {
    const insideDropdown = dropdownMenu.contains(e.target);
    const insideFloating = Floating?.isInsideFloating?.(e.target);
    if (!insideDropdown && !insideFloating) closeFirst();
  }
  if (isNextVisible) {
    const inside2 = nextDropdowns.contains(e.target);
    if (!inside2) closeSecond();
  }
  if (isThirdVisible) {
      const inside3 =
    (thirdDropdownsAEl && thirdDropdownsAEl.contains(e.target)) ||
    (thirdDropdownsBEl && thirdDropdownsBEl.contains(e.target));
    if (!inside3) closeThird();
  }
}, { passive:true });

/* ------------------------------
   API ì—°ë™: êµ­ê°€â†’ì§€ì—­â†’ì—…ì²´
------------------------------ */
async function loadCountries(){
  try{
    const r = await fetch(`${BASE}/api/debug/config`);
    const j = await r.json();
    const countries = j.countries || Object.keys(j.dbStructure||{}) || [];
    countryCombo.setItems(countries);
  }catch(e){ countryCombo.setItems([]); }
}
countryCombo.root.addEventListener('change', async ()=>{
  const country = countryCombo.getValue();
    regionCombo.setItems([]);
     companyComboA.setItems([]); companyComboB.setItems([]);
      poeComboA.setItems([]);     poeComboB.setItems([]);
      regionCombo.input.disabled = true;
      companyComboA.input.disabled = true; companyComboB.input.disabled = true;
      poeComboA.input.disabled = true;     poeComboB.input.disabled = true;
  if(!country) return;
  try{
    const r = await fetch(`${BASE}/api/regions/${encodeURIComponent(country)}`);
    const j = await r.json();
    regionCombo.setItems(j.regions||[]);
    regionCombo.input.disabled = false;
  }catch(e){ regionCombo.setItems([]); }
  updateCargoTypeOptions();
});
regionCombo.root.addEventListener('change', async ()=>{
  const country = countryCombo.getValue();
  const region  = regionCombo.getValue();
  companyComboA.setItems([]); companyComboA.input.disabled = true;
  companyComboB.setItems([]); companyComboB.input.disabled = true;
  poeComboA.setItems([]);     poeComboA.input.disabled     = true;
  poeComboB.setItems([]);     poeComboB.input.disabled     = true;
  if(!country || !region) return;
  try{
    const url = `${BASE}/api/companies/by-region?country=${encodeURIComponent(country)}&region=${encodeURIComponent(region)}&mode=options`;
    const r = await fetch(url);
    const j = await r.json();
    const companies = (j.companies || []).filter(Boolean);
    companyComboA.setItems(companies);
    companyComboB.setItems(companies);
    companyComboA.input.disabled = companies.length === 0;
    companyComboB.input.disabled = companies.length === 0;
  }catch(e){
    companyCombo.setItems([]); 
    companyCombo.input.disabled = true;
  }
  updateCargoTypeOptions();

});
async function loadPoesFor(side){
  const country = countryCombo.getValue();
  const region  = regionCombo.getValue();
  const company = (side==='A' ? companyComboA.getValue() : companyComboB.getValue());
  const poeComboX = (side==='A' ? poeComboA : poeComboB);

  poeComboX.setItems([]); poeComboX.input.disabled = true;
  if(!country || !region || !company) return;
  try{
    const url = `${BASE}/api/poe/by-company?country=${encodeURIComponent(country)}&region=${encodeURIComponent(region)}&company=${encodeURIComponent(company)}&mode=data`;
    const r   = await fetch(url);
    const j   = await r.json();
    const poes = (j.poes || []).filter(Boolean);
    poeComboX.setItems(poes);
    poeComboX.input.disabled = poes.length === 0 ? true : false;
  }catch(e){
    poeComboX.setItems([]); 
    poeComboX.input.disabled = true;
  }
  updateCargoTypeOptions();
}

companyComboA.root.addEventListener('change', ()=> loadPoesFor('A'));
companyComboB.root.addEventListener('change', ()=> loadPoesFor('B'));



/* ------------------------------
   í™”ë¬¼íƒ€ì… & ì»¨í…Œì´ë„ˆ íƒ€ì… & CBM
------------------------------ */
// í™”ë¬¼íƒ€ì… ì˜µì…˜ ì„¸íŒ…
function setCargoTypeOptions(values){
  const el = document.getElementById('cargoTypeSelect');
  if(!el) return;
  const opts = ['<option value="">í™”ë¬¼íƒ€ì… ì„ íƒ</option>']
    .concat((values||[]).map(v=>`<option value="${String(v)}">${String(v)}</option>`));
  el.innerHTML = opts.join('');
}

// ì§€ì—­/ì—…ì²´ì— ë”°ë¼ í™”ë¬¼íƒ€ì… ë™ì  êµ¬ì„± (ê¸°ë³¸ê°’: DIPLOMAT/NON-DIPLOMAT)
function updateCargoTypeOptions(){
  const sel = document.getElementById('cargoTypeSelect');
  if (!sel) return;

  // âœ… í•­ìƒ í™œì„±í™”
  sel.disabled = false;
  sel.style.pointerEvents = 'auto';
  sel.style.opacity = '';

  // âœ… ì´ì „ ì„ íƒ ë³´ì¡´
  const prev = sel.value;

  // (í•„ìš” ì‹œ ì˜µì…˜ ì—…ë°ì´íŠ¸ê°€ ìˆë”ë¼ë„) ê¸°ì¡´ ì˜µì…˜ì„ ë˜ë„ë¡ ìœ ì§€í•˜ê³ ,
  // ìƒˆ ì˜µì…˜ì„ ë§ë¶™ì´ê±°ë‚˜ enable/disableë§Œ í•˜ì„¸ìš”.
  // âŒ sel.value = '' ê°™ì€ ì´ˆê¸°í™” ê¸ˆì§€
  // âŒ sel.disabled = true ê¸ˆì§€

  // âœ… ê°€ëŠ¥í•œ ê²½ìš° ì´ì „ ì„ íƒ ë³µì›
  if (prev && Array.from(sel.options).some(o => o.value === prev)) {
    sel.value = prev;
  }
}


function setOptions(selectEl, values, placeholder='CBM ì„ íƒ'){
  const opts = ['<option value="">'+placeholder+'</option>']
   .concat(values.map(v=>`<option value="${String(v)}">${String(v)}</option>`));
  selectEl.innerHTML = opts.join('');
}
function fillCbmByType(type){
  if(!cbmSelect) return;
  const T=(type||'').toUpperCase();
  let values=[];
  if(!T){ setOptions(cbmSelect,[], 'CBM ì„ íƒ'); return; }
  if(T==='CONSOLE'){ values = Array.from({length:30},(_,i)=>i+1); }
  else { values = [5,10,15,20,25,30,35,40]; }
  setOptions(cbmSelect, values);
}
typeCombo.root.addEventListener('change', ()=> fillCbmByType(typeCombo.getValue()) );

/* =========================================================
   MapPicker â€” ORIGINAL ê¸°ë°˜ ì§€ë„ íŒì—…
   - ë²„íŠ¼ id="btnSelectOnMap" í´ë¦­ ì‹œ íŒì—…
   - map.json: ./map.json (destinationcost/map.json)
========================================================= */
function loadCssOnce(href){ return new Promise((res, rej)=>{ if(document.querySelector(`link[href="${href}"]`)) return res(); const l=document.createElement('link'); l.rel='stylesheet'; l.href=href; l.onload=res; l.onerror=rej; document.head.appendChild(l); }); }
function loadJsOnce(src){ return new Promise((res, rej)=>{ if(document.querySelector(`script[src="${src}"]`)) return res(); const s=document.createElement('script'); s.src=src; s.onload=res; s.onerror=rej; document.head.appendChild(s); }); }
const LCSS  = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.css";
const LJS   = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js";
const GCSS  = "https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css";
const GJS   = "https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js";

function getCountry(){ if (window.countryCombo?.getValue) return window.countryCombo.getValue(); const el = document.querySelector('#countryCombo input'); return el?.value?.trim() || ''; }
function getRegion(){  if (window.regionCombo?.getValue)  return window.regionCombo.getValue();  const el = document.querySelector('#regionCombo input');  return el?.value?.trim() || ''; }
function setRegion(v){ if (window.regionCombo?.setValue)  return window.regionCombo.setValue(v);  const el = document.querySelector('#regionCombo input');  if(el){ el.value = v; el.dispatchEvent(new Event('input')); } }

/* ========== [ì¶”ê°€] setRegion ë³´ê°•: change/input ì´ë²¤íŠ¸ ê°•ì œ ë°œìƒ ========== */
(function hardenSetRegion(){
  const _orig = window.setRegion;
  window.setRegion = function(v){
    if (window.regionCombo?.setValue) {
      regionCombo.setValue(v);
      try { regionCombo.el?.dispatchEvent?.(new Event('change', {bubbles:true})); } catch(e){}
      try { regionCombo.el?.dispatchEvent?.(new Event('input',  {bubbles:true})); } catch(e){}
      return;
    }
    const el = document.querySelector('#regionCombo input');
    if (el){
      el.value = v;
      el.dispatchEvent(new Event('input',  {bubbles:true}));
      el.dispatchEvent(new Event('change', {bubbles:true}));
      return;
    }
    const selEl = document.getElementById('regionSelect') || document.querySelector('select#regionSelect, select[name="region"]');
    if (selEl){
      let opt = Array.from(selEl.options).find(o => (o.value === v) || (o.text.trim() === v));
      if (!opt) { opt = new Option(v, v, true, true); selEl.add(opt); }
      selEl.value = opt.value;
      selEl.dispatchEvent(new Event('change', {bubbles:true}));
      selEl.dispatchEvent(new Event('input',  {bubbles:true}));
      return;
    }
    _orig?.(v);
  };
})();

  
let __sticky = null;
function toast(msg, {sticky=false, timeout=1500}={}) {
  if (__sticky) { __sticky.remove(); __sticky = null; }

  if (sticky) {
    if (__sticky) __sticky.remove();
    const el = document.createElement('div');
      el.innerHTML = `<div style="
        position:fixed;left:50%;top:33vh;transform:translate(-50%,-50%);
        background:rgba(17,17,17,.92);color:#fff;padding:12px 16px;
        border-radius:12px;border:1px solid rgba(255,255,255,.15);
        box-shadow:0 10px 30px rgba(0,0,0,.35);z-index:10000;
        font-size:14px;line-height:1.4;display:flex;gap:12px;align-items:center;
        max-width:min(90vw,640px);text-align:center
      ">
        <span>${msg}</span>
        <button type="button" style="background:#fff;color:#111;border:0;border-radius:10px;padding:6px 12px;cursor:pointer;">ë‹«ê¸°</button>
      </div>`;
    el.querySelector('button').onclick = ()=>{ el.remove(); __sticky=null; };
    document.body.appendChild(el); __sticky = el; return;
  }
  const d = document.createElement('div');
  d.textContent = msg;
  d.style.cssText = `
    position:fixed;left:50%;top:33vh;transform:translate(-50%,-50%);
    background:rgba(0,0,0,.85);color:#fff;padding:10px 14px;
    border-radius:12px;z-index:10000;font-size:14px;line-height:1.4;
    box-shadow:0 10px 30px rgba(0,0,0,.35);max-width:min(90vw,640px);
    text-align:center
  `;
  document.body.appendChild(d); setTimeout(()=>d.remove(), timeout);
}

function haversineKm(aLat,aLng,bLat,bLng){ const R=6371, dLat=(bLat-aLat)*Math.PI/180, dLng=(bLng-aLng)*Math.PI/180; const A=Math.sin(dLat/2)**2+Math.cos(aLat*Math.PI/180)*Math.cos(bLat*Math.PI/180)*Math.sin(dLng/2)**2; return 2*R*Math.asin(Math.sqrt(A)); }
function findNearest(lat,lng,pts){ if(!pts?.length) return null; let best=null,bd=Infinity; for(const p of pts){ const d=haversineKm(lat,lng,p.lat,p.lng); if(d<bd){best=p;bd=d;} } return {point:best,distanceKm:bd}; }

let map, markerLayer, geocoder, mapInited=false, mapData=null, tmpSearch=null;
const pinReg    = '#2563eb';
const pinSearch = '#ef4444';

function makeSvgPinIcon(color, withLabel=false, labelText="") {
  const svg = `<svg class="pin-svg" viewBox="0 0 24 24" aria-hidden="true"><path fill="${color}" d="M12 2C8.134 2 5 5.134 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.866-3.134-7-7-7zm0 9.5a2.5 2.5 0 1 1 0-5a2.5 2.5 0 0 1 0 5z"/></svg>`;
  const labelHtml = withLabel ? `<div class="pin-label">${String(labelText).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]))}</div>` : "";
  const html = `<div class="pin-wrap">${svg}${labelHtml}</div>`;
  return L.divIcon({ className: "", html, iconSize: [26,26], iconAnchor: [13,26] });
}

function ensureModal() {
  if (document.getElementById('mapPickerModal')) return;
  const wrap = document.createElement('div');
  wrap.id = 'mapPickerModal';
  wrap.innerHTML = `
    <div class="mpk__backdrop" style="position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:2000;"></div>
    <div class="mpk__panel" style="position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:min(95vw,980px);background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.35);z-index:2001;display:flex;flex-direction:column;overflow:hidden;">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid #e5e7eb;">
        <strong style="font-size:16px;color:#111">ì§€ë„ì—ì„œ ì§€ì—­ ì„ íƒ</strong>
        <div style="display:flex;gap:8px;">
          <button type="button" id="mpkBtnConfirm" style="border:1px solid #1F9461;background:#1F9461;color:#fff;border-radius:8px;padding:8px 12px;cursor:pointer;">ì„ íƒ ì™„ë£Œ</button>
          <button type="button" id="mpkBtnClose"   style="border:1px solid #e5e7eb;background:#fff;color:#111;border-radius:8px;padding:8px 12px;cursor:pointer;">ë‹«ê¸°</button>
        </div>
      </div>
      <div id="mpkMap" style="height:520px;"></div>
      <div style="padding:10px 14px;color:#4b5563;font-size:13px;border-top:1px solid #e5e7eb;background:#f8fafc;">
        â€¢ í•€ì„ í´ë¦­í•˜ë©´ í•´ë‹¹ ì§€ì—­ì´ ìë™ ì„ íƒë©ë‹ˆë‹¤. â€¢ ë‹ë³´ê¸°ë¡œ ìœ„ì¹˜ ê²€ìƒ‰ ê°€ëŠ¥ â€¢ ë“±ë¡ë˜ì§€ ì•Šì€ ììœ  ì…ë ¥ì€ ìµœê·¼ì ‘ ë“±ë¡ ì§€ì—­ìœ¼ë¡œ ë³´ì •ë©ë‹ˆë‹¤.
      </div>
    </div>
  `;
  document.body.appendChild(wrap);
wrap.querySelector('#mpkBtnClose').onclick = ()=>{ closeStickyToast(); closeModal(); };
wrap.querySelector('.mpk__backdrop').onclick = ()=>{ closeStickyToast(); closeModal(); };
wrap.querySelector('#mpkBtnConfirm').onclick = ()=>{
  const ok = applySelectedLocationFromMap();
  closeStickyToast();
  if (ok) closeModal();
};
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') { closeStickyToast(); closeModal(); } });
}

async function ensureMapReady() {
  if (!mapInited) {
    await loadCssOnce(LCSS); await loadJsOnce(LJS);
    await loadCssOnce(GCSS); await loadJsOnce(GJS);

    const worldBounds = L.latLngBounds([[-85,-180],[85,180]]);
    map = L.map('mpkMap', { center:[20,0], zoom:2, worldCopyJump:false, maxBounds:worldBounds, maxBoundsViscosity:1.0 });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OSM', noWrap:true, bounds:worldBounds }).addTo(map);
    markerLayer = L.layerGroup().addTo(map);

    geocoder = L.Control.geocoder({ defaultMarkGeocode:false })
      .on('markgeocode', (e)=>{
        const c = e.geocode.center;
        if (tmpSearch) { map.removeLayer(tmpSearch); tmpSearch=null; }
        tmpSearch = L.marker(c, {icon: makeSvgPinIcon(pinSearch,false)}).addTo(map);
        const gEl = document.querySelector('.leaflet-control-geocoder');
        if (gEl) gEl.style.display = 'block';
        map.setView(c, 9);

        window.__selectedPlace = {
          name: null,  
          lat:  c.lat,
          lng:  c.lng
        };
        const pts = __countryPoints;
        if (pts?.length) {
          const hit = findNearest(c.lat,c.lng,pts);
          if (hit?.point) {
            setRegion(hit.point.name);
            toast(`ê°€ì¥ ê°€ê¹Œìš´ ${hit.point.name} ì§€ì—­ì„ ì„ íƒí•˜ì˜€ìŠµë‹ˆë‹¤. (~${hit.distanceKm.toFixed(1)}km)`, {sticky:true});

            // â˜… 1ì°¨ ì»¨í…Œì´ë„ˆ ìœ ì§€ (ì§€ë„ ë™ì‘ ì¤‘ì—ëŠ” í•­ìƒ ì—´ë¦° ìƒíƒœ)
            dropdownMenu?.classList.add('show');
            isDropdownVisible = true;
          }
          if (hit?.point?.name) window.__selectedPlace.name = hit.point.name;
        }
      }).addTo(map);

    try {
      const r = await fetch('./map.json', { cache:'no-store' });  // â† destinationcost/map.json
      mapData = await r.json();
    } catch(e) {
      console.warn('map.json ë¡œë“œ ì‹¤íŒ¨:', e);
      mapData = {};
    }
    mapInited = true;
  }
  setTimeout(()=> map.invalidateSize(), 50);
}

let __countryPoints = [];

/* êµ­ê°€ í‚¤ ë³´ì • (í˜„ì¬ëŠ” trimë§Œ ìˆ˜í–‰ â€” í•„ìš”í•œ ë³„ì¹­ì€ ë§¤í•‘ ì¶”ê°€) */
function normalizeCountryKey(raw){
  if (!raw) return '';
  return String(raw).trim();
}

/* ì„ íƒ êµ­ê°€ì˜ ë§ˆì»¤ ì„¸íŒ… */
function setMapCountry(country) {
  if (!mapInited) return;
  markerLayer.clearLayers();
  __countryPoints = [];
  if (!mapData) return;

  const key = normalizeCountryKey(country);
  if (!mapData[key]) {
    console.warn('No map data for country:', country, 'â†’ normalized:', key);
    toast(`í•´ë‹¹ êµ­ê°€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤: ${country}`, {sticky:true});
    return;
  }

  const pts = mapData[key];
  console.log('[setMapCountry] using key=', key, 'points=', pts?.length);

  const bounds = [];
  pts.forEach(p => {
    const m = L.marker([p.lat, p.lng], { icon: makeSvgPinIcon(pinReg, false) })
      .addTo(markerLayer);
    m.on('click', () => {
      setRegion(p.name);
      toast(`ì§€ì—­ ì„ íƒ: ${p.name}`);
      dropdownMenu?.classList.add('show');
      isDropdownVisible = true;
    });
    __countryPoints.push({ ...p, marker: m });
    bounds.push([p.lat, p.lng]);
  });

  if (bounds.length) {
    map.fitBounds(bounds, { padding: [20, 20] });
  }
}


/* ------------------------------
   ì§€ë„ ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸° + ìŠ¤ëƒ…ìƒ· ë³µêµ¬
------------------------------ */

/* ========== [ì¶”ê°€] Sticky í† ìŠ¤íŠ¸ ë‹«ê¸° ========== */
function closeStickyToast(){
  if (window.__sticky) { __sticky.remove(); __sticky = null; }
}

/* ========== [ì¶”ê°€] ì§€ë„ ì„ íƒê°’ â†’ ë“œë¡­ë‹¤ìš´ ë°˜ì˜ ========== */
function applySelectedLocationFromMap(){
  const sel = window.__selectedPlace || {};
  let name = sel.name;

  if (!name && sel.lat != null && sel.lng != null && Array.isArray(__countryPoints) && __countryPoints.length){
    const hit = findNearest(sel.lat, sel.lng, __countryPoints);
    name = hit?.point?.name;
  }
  if (!name){
    toast('ì„ íƒëœ ì§€ì—­ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
    return false;
  }

  if (window.regionCombo?.setValue) {
    regionCombo.setValue(name);
    try { regionCombo.el?.dispatchEvent?.(new Event('change', {bubbles:true})); } catch(e){}
    try { regionCombo.el?.dispatchEvent?.(new Event('input',  {bubbles:true})); } catch(e){}
  } else {
    const selEl = document.getElementById('regionSelect') || document.querySelector('select#regionSelect, select[name="region"]');
    if (selEl) {
      let opt = Array.from(selEl.options).find(o => (o.value === name) || (o.text.trim() === name));
      if (!opt) { opt = new Option(name, name, true, true); selEl.add(opt); }
      selEl.value = opt.value;
      selEl.dispatchEvent(new Event('change', {bubbles:true}));
      selEl.dispatchEvent(new Event('input',  {bubbles:true}));
    } else {
      const el = document.querySelector('#regionCombo input');
      if (el){ el.value = name; el.dispatchEvent(new Event('input', {bubbles:true})); }
    }
  }

  try { if (typeof showFirstSummary === 'function') showFirstSummary(); } catch(e){}
  try { if (typeof updateSelectionSummary === 'function') updateSelectionSummary(); } catch(e){}

  toast(`ì§€ì—­ì´ "${name}"(ìœ¼)ë¡œ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.`);
  return true;
}

/* ========== [ì¶”ê°€] ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸° ========== */
let __mapModalOpen = false;
function openModal(){
  const m = document.getElementById('mapPickerModal');
  if (!m) return;
  m.style.display = 'block';
  m.setAttribute('aria-hidden','false');
  document.body.classList.add('no-scroll');
  __mapModalOpen = true;
  setTimeout(()=>{ if (window.map?.invalidateSize) map.invalidateSize(); }, 100);
}
function closeModal(){
  const m = document.getElementById('mapPickerModal');
  if (!m) return;
  m.style.display = 'none';
  m.setAttribute('aria-hidden','true');
  document.body.classList.remove('no-scroll');
  __mapModalOpen = false;
}
  
/* ========== [ì¶”ê°€] ë²„íŠ¼(id="btnSelectOnMap")ìœ¼ë¡œ ëª¨ë‹¬ ì—´ê¸° ========== */
(function wireOpenButton(){
  const btn = document.getElementById('btnSelectOnMap');
  if (!btn) return;
  btn.addEventListener('click', async ()=>{
    ensureModal();                 // ëª¨ë‹¬ DOM ìƒì„±
    await ensureMapReady();        // Leaflet/ì§€ì˜¤ì½”ë” ë¡œë“œ
    const c = getCountry();
    if (c) setMapCountry(c);       // êµ­ê°€ ë§ˆì»¤ ë¡œë“œ
    openModal();
  });
})();

let __uiSnapshot = {
  isDropdownVisible: false,
  isNextVisible: false,
  dropdownMenuHadShow: false,
  nextDropdownsHadShow: false,
  summaryHadShow: false,
  nextSummaryHadShow: false,
};

function openModal(){
  ensureModal();
  // ì§€ë„ ì—´ê¸° ì§ì „ ìƒíƒœ ì €ì¥
  __uiSnapshot = {
    isDropdownVisible,
    isNextVisible,
    dropdownMenuHadShow:  dropdownMenu?.classList.contains('show'),
    nextDropdownsHadShow: nextDropdowns?.classList.contains('show'),
    summaryHadShow:       summary?.classList.contains('show'),
    nextSummaryHadShow:   nextSummary?.classList.contains('show'),
  };
  MAP_MODAL_OPEN = true;

  const m = document.getElementById('mapPickerModal');
  if (m) m.style.display = 'block';
}
function closeModal(){
  closeStickyToast(); // â˜… [NEW] ë‹«ê¸° ë²„íŠ¼/ë°°ê²½ í´ë¦­/ESC ë“± ëª¨ë“  ê²½ë¡œì—ì„œ sticky ë‹«ê¸°
  const m = document.getElementById('mapPickerModal');
  if (m) m.style.display = 'none';
  MAP_MODAL_OPEN = false;

  // â˜… ì§€ë„ ë‹«íŒ í›„: 1ì°¨ ì»¨í…Œì´ë„ˆëŠ” ì—´ë¦° ìƒíƒœë¡œ ë³µê·€
  dropdownMenu?.classList.add('show');
  isDropdownVisible = true;

  // â˜… ì§€ë„ ì—´ê¸° ì „ ìƒíƒœë¡œ 2ì°¨/ìš”ì•½ ë³µêµ¬(ê°•ì œ 'ë¯¸ì„ íƒ' ë°©ì§€)
  summary?.classList.toggle('show', __uiSnapshot.summaryHadShow);
  nextDropdowns?.classList.toggle('show', __uiSnapshot.nextDropdownsHadShow);
  isNextVisible = __uiSnapshot.nextDropdownsHadShow;
  nextSummary?.classList.toggle('show', __uiSnapshot.nextSummaryHadShow);
}

/* ------------------------------
   ì§€ë„ ë²„íŠ¼ ë°”ì¸ë”©
------------------------------ */
// â†“â†“â†“ ì´ ë¸”ë¡ì€ ì£¼ì„ ì²˜ë¦¬í•´ë„ ë™ì‘ì— ë¬¸ì œ ì—†ìŠµë‹ˆë‹¤.
// const __bindMapBtn = ()=>{
//   const btn = document.getElementById('btnSelectOnMap');
//   if (!btn) return;
//   btn.addEventListener('click', async ()=>{
//     openModal();
//     await ensureMapReady();
//     const c = getCountry();
//     if (c) setMapCountry(c);
//   }, { once:false });
// };
// if (document.readyState !== 'loading') __bindMapBtn();
// else document.addEventListener('DOMContentLoaded', __bindMapBtn);

/* ------------------------------
   ì´ˆê¸°í™”
------------------------------ */
window.addEventListener('DOMContentLoaded', async ()=>{
  try{
    await loadCountries();
  }catch(_){}
  try{
    fillCbmByType(typeCombo.getValue() || '20FT');
  }catch(_){}
  try{
    openFirst();               // ì²« ë“œë¡­ë‹¤ìš´ ìë™ ì—´ê¸° (ì‹¤íŒ¨í•´ë„ í˜ì´ì§€ëŠ” ê³„ì†)
  }catch(_){}
  try{
    updateCargoTypeOptions();  // í™”ë¬¼íƒ€ì… ì´ˆê¸°í™”
  }catch(_){}
});



/** ========= ì¡°íšŒ ë²„íŠ¼ â†’ API í˜¸ì¶œ ========= */

// === ì¡°íšŒ ë²„íŠ¼ í‘œì‹œ í† ê¸€ ===
const actionRowCenter = document.querySelector('.action-row.center');

function readyForA(){
  const country = countryCombo.getValue();
  const region  = regionCombo.getValue();
  const type    = (typeCombo.getValue() || '20FT');
  const cargo   = document.getElementById('cargoTypeSelect')?.value || '';
  const cbmSel  = document.getElementById('cbmSelect');
  const needsCbm= String(type).toUpperCase()==='CONSOLE';
  const cbmOk   = needsCbm ? !!cbmSel?.value : true;
  const hasA    = !!companyComboA.getValue();
  return !!country && !!region && !!cargo && cbmOk && hasA;
}

function readyForB(){
  const country = countryCombo.getValue();
  const region  = regionCombo.getValue();
  const type    = (typeCombo.getValue() || '20FT');
  const cargo   = document.getElementById('cargoTypeSelect')?.value || '';
  const cbmSel  = document.getElementById('cbmSelect');
  const needsCbm= String(type).toUpperCase()==='CONSOLE';
  const cbmOk   = needsCbm ? !!cbmSel?.value : true;
  const hasB    = !!companyComboB.getValue();
  return !!country && !!region && !!cargo && cbmOk && hasB;
}

function toggleFetchVisibilityAB(){
  const a = document.getElementById('btnFetchA');
  const b = document.getElementById('btnFetchB');
  if (a) a.disabled = !readyForA();
  if (b) b.disabled = !readyForB();
}


['countryCombo','regionCombo','companyComboA','poeComboA','companyComboB','poeComboB','typeCombo','cargoTypeSelect','cbmSelect'].forEach(id=>{
  const root = document.getElementById(id);
  if (!root) return;
  root.addEventListener('change', toggleFetchVisibilityAB);
  root.addEventListener('input',  toggleFetchVisibilityAB);
});
window.addEventListener('DOMContentLoaded', toggleFetchVisibilityAB);

  
function toggleFetchVisibility() {
  if (!actionRowCenter) return;
  actionRowCenter.classList.toggle('show', allReady());
}

  
// ì½¤ë³´/ì…€ë ‰íŠ¸ê°€ ë°”ë€” ë•Œë§ˆë‹¤ ì²´í¬
['countryCombo','regionCombo','companyCombo','poeCombo','typeCombo'].forEach(id=>{
  const root = document.getElementById(id);
  if (!root) return;
  root.addEventListener('change', toggleFetchVisibility);
});
document.getElementById('cbmSelect')?.addEventListener('change', toggleFetchVisibility);
document.getElementById('cargoTypeSelect')?.addEventListener('change', toggleFetchVisibility);


// ì§€ë„ì—ì„œ ì§€ì—­ì„ ì„¤ì •í•˜ëŠ” ê²½ìš°ë„ ë°˜ì˜
window.addEventListener('DOMContentLoaded', ()=>{
  toggleFetchVisibility(); // ì´ˆê¸° 1íšŒ
});

// ì¡°íšŒ ì„±ê³µ ì‹œ í‘œ ì˜ì—­ì€ ê¸°ì¡´ ì½”ë“œëŒ€ë¡œ .show ì¶”ê°€ë¨

async function fetchSide(side){
  const left  = (side==='A');
  const wrapId  = left ? 'tableWrapA' : 'tableWrapB';
  const company = left ? companyComboA.getValue() : companyComboB.getValue();
  const poe     = left ? poeComboA.getValue()     : poeComboB.getValue();

  const country = countryCombo.getValue();
  const region  = regionCombo.getValue();
  const type    = (typeCombo.getValue() || '20FT');           // ì»¨í…Œì´ë„ˆ íƒ€ì…
  const cargo   = document.getElementById('cargoTypeSelect')?.value || ''; // í™”ë¬¼íƒ€ì…

  // ğŸ” ìœ íš¨ì„± (ìš”êµ¬ì‚¬í•­: í™”ë¬¼íƒ€ì… ë°˜ë“œì‹œ ì„ íƒ)
  if (!country) return alert('êµ­ê°€ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
  if (!region)  return alert('ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš”.');
  if (!company) return alert(`${left?'A':'B'} ì—…ì²´ë¥¼ ì„ íƒí•˜ì„¸ìš”.`);
  if (!cargo)   return alert('í™”ë¬¼íƒ€ì…ì„ ì„ íƒí•˜ì„¸ìš”.');

  // CONSOLEì¼ ë•Œë§Œ CBM í•„ìˆ˜ë¼ë©´:
  const cbmSel  = document.getElementById('cbmSelect');
  const needsCbm = String(type).toUpperCase()==='CONSOLE';
  const cbm     = cbmSel?.value ? Number(cbmSel.value) : undefined;
  if (needsCbm && !cbmSel?.value) return alert('CONSOLEì€ CBMì„ ì„ íƒí•˜ì„¸ìš”.');

  try{
    const roles = [];
    if (cargo) roles.push(cargo.toUpperCase()); // APIê°€ rolesë¡œ í™”ë¬¼íƒ€ì… ë°›ëŠ” êµ¬ì¡°ë¼ê³  ê°€ì •

    const params = new URLSearchParams();
    params.set('type', type);
    params.set('company', company);
    if (region) params.set('region', region);
    if (roles.length) params.set('roles', roles.join(','));
    if (needsCbm && !isNaN(cbm)) params.set('cbm', String(cbm));

    const url = `${BASE}/api/costs/${encodeURIComponent(country)}?${params.toString()}`;
    const res = await fetch(url);
    const j   = await res.json();

    __numberFormats = j?.numberFormats || {};
    renderTableTo(wrapId, j, type, Boolean(region));

    document.getElementById('resultSection')?.classList.add('show'); // í‘œ ì„¹ì…˜ ë…¸ì¶œ
  }catch(e){
    companyComboA.setItems([]); companyComboA.input.disabled = true;
    companyComboB.setItems([]); companyComboB.input.disabled = true;
  }
}

// A/B ê°ê° ë³„ë„ ì¡°íšŒ
document.getElementById('btnFetchA')?.addEventListener('click', ()=>fetchSide('A'));
document.getElementById('btnFetchB')?.addEventListener('click', ()=>fetchSide('B'));



  // === ì¨ë¨¸ë¦¬ í´ë¦­ ì‹œ í•´ë‹¹ ë“œë¡­ë‹¤ìš´ ì¬ì˜¤í”ˆ ===
// 1ë‹¨ê³„ ì¨ë¨¸ë¦¬ í´ë¦­ â†’ 1ë‹¨ê³„ ë“œë¡­ë‹¤ìš´ ì—´ê¸°
summary?.addEventListener('click', (e)=>{
  if (!(e.target instanceof HTMLElement)) return;
  if (!e.target.classList.contains('summary-hot')) return; // â† í…ìŠ¤íŠ¸ë§Œ ë°˜ì‘
  openFirst();
  document.getElementById('resultSection')?.classList.remove('show');
  document.querySelector('.action-row.center')?.classList.remove('revealed');
});

// 2ë‹¨ê³„ ì¨ë¨¸ë¦¬ í´ë¦­ â†’ 2ë‹¨ê³„ ë“œë¡­ë‹¤ìš´ ì—´ê¸°
nextSummary?.addEventListener('click', (e)=>{
  if (!(e.target instanceof HTMLElement)) return;
  if (!e.target.classList.contains('summary-hot')) return;
  dropdownMenu?.classList.remove('show');
  isDropdownVisible = false;
  openSecond();
  document.getElementById('resultSection')?.classList.remove('show');
  document.querySelector('.action-row.center')?.classList.remove('revealed');
});

// 3ë‹¨ê³„ ì¨ë¨¸ë¦¬ í´ë¦­ â†’ 3ë‹¨ê³„ ë“œë¡­ë‹¤ìš´ ì—´ê¸°
thirdSummary?.addEventListener('click', (e)=>{
  if (!(e.target instanceof HTMLElement)) return;
  if (!e.target.classList.contains('summary-hot')) return;
  openThird();
  document.getElementById('resultSection')?.classList.remove('show');
  document.querySelector('.action-row.center')?.classList.remove('revealed');
});


  
/** ========= ê²°ê³¼ í‘œ ë Œë”ë§ ìœ í‹¸ ========= */

// Notion ìˆ«ì í¬ë§· ë©”íƒ€ ì €ì¥ìš© (ë°±ì—”ë“œ /api/costs ì‘ë‹µì— í¬í•¨ë¨)
let __numberFormats = {};

function esc(s){ return String(s==null?'':s)
  .replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

function formatAmount(n, columnKey){
  if (n==null || n==='' || isNaN(Number(n))) return '';
  const v = Number(n);
  const fmt = __numberFormats?.[columnKey] || '';
  // ì•„ì£¼ ë‹¨ìˆœ ë§¤í•‘ â€” í•„ìš” ì‹œ í™•ëŒ€ ê°€ëŠ¥
  if (/dollar|usd/i.test(fmt)) return '$' + v.toLocaleString('en-US');
  if (/won|krw/i.test(fmt))    return 'â‚©' + v.toLocaleString('ko-KR');
  if (/euro|eur/i.test(fmt))   return 'â‚¬' + v.toLocaleString('de-DE');
  return v.toLocaleString(); // ê¸°ë³¸
}

/**
 * renderTable(data, type, isRegionFiltered)
 * - data.rows: [{ item, region, extra, "20FT", "40HC", "CONSOLE", ... }]
 * - type: í˜„ì¬ ì„ íƒ íƒ€ì…(20FT/40HC/CONSOLE)
 * - isRegionFiltered: region íŒŒë¼ë¯¸í„°ë¥¼ ë„£ì–´ ë‹¨ì¼ ì§€ì—­ìœ¼ë¡œ ì¡°íšŒí–ˆëŠ”ì§€ ì—¬ë¶€
 */
function renderTable(data, type, isRegionFiltered){
  const wrap = document.getElementById('tableWrap');
  if (!wrap){ return; }

  const rows = Array.isArray(data?.rows) ? data.rows : [];
  if (!rows.length){
    wrap.innerHTML = '<div class="muted">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }

  // í—¤ë” êµ¬ì„±
  let thead = '<tr><th>í•­ëª©</th>';
  if (!isRegionFiltered) thead += '<th>ì§€ì—­</th>';
  thead += `<th class="type-col">${esc(type)}</th><th>ë¹„ê³ </th></tr>`;

  // ë°”ë”” êµ¬ì„±
  let tbody = '';
  for (const r of rows){
    const amt = r?.[type];
    const amtText = formatAmount(amt, type) || '-';
    tbody += '<tr>';
    tbody += `<td>${esc(r.item || '')}</td>`;
    if (!isRegionFiltered) tbody += `<td>${esc(r.region || '')}</td>`;
    tbody += `<td class="amt">${amtText}</td>`;
    // extraëŠ” ë°±ì—”ë“œì—ì„œ ì•ˆì „í•œ HTML(ë§í¬/ì¤„ë°”ê¿ˆ) í˜•íƒœë¡œ ë‚´ë ¤ì¤„ ìˆ˜ ìˆìŒ
    tbody += `<td>${r.extra || ''}</td>`;
    tbody += '</tr>';
  }

  // ë Œë”
  wrap.innerHTML = `
    <table class="result-table">
      <thead>${thead}</thead>
      <tbody>${tbody}</tbody>
    </table>
  `;
}
function renderTableTo(wrapId, data, type, isRegionFiltered){
  const wrap = document.getElementById(wrapId);
  if (!wrap) return;
  const rows = Array.isArray(data?.rows) ? data.rows : [];
  if (!rows.length){
    wrap.innerHTML = '<div class="muted">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }
  let thead = '<tr><th>í•­ëª©</th>';
  if (!isRegionFiltered) thead += '<th>ì§€ì—­</th>';
  thead += `<th class="type-col">${esc(type)}</th><th>ë¹„ê³ </th></tr>`;
  let tbody = '';
  for (const r of rows){
    const amt = r?.[type];
    const amtText = formatAmount(amt, type) || '-';
    tbody += '<tr>';
    tbody += `<td>${esc(r.item || '')}</td>`;
    if (!isRegionFiltered) tbody += `<td>${esc(r.region || '')}</td>`;
    tbody += `<td class="amt">${amtText}</td>`;
    tbody += `<td>${r.extra || ''}</td>`;
    tbody += '</tr>';
  }
  wrap.innerHTML = `
    <table class="result-table">
      <thead>${thead}</thead>
      <tbody>${tbody}</tbody>
    </table>
  `;
  console.log(wrapId, 'rows=', rows.length, data);

}

</script>



</body>
</html>
