<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>도착지 비용 계산</title>

  <!-- 폰트 (기존과 동일 계열) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- 메인 스타일 -->
  <link rel="stylesheet" href="./app.css" />
</head>
<body>

  <!-- 상단 헤더 (간단 버전) -->
<header class="site-header">
  <div class="container header-inner">
    <div class="logo">
      <img src="https://arrrbang.github.io/pumex/image/pumexlogonew.png" alt="PUMEX Logo">
    </div>
      <div class="site-title">도착지 비용 계산</div>
  </div>
</header>

  <!-- 메인 앱 셸 -->
  <main class="app-shell">
    <div class="app-main container">

      <!-- 왼쪽: 지도 영역 -->
      <section class="left-pane">
        <!-- Leaflet 지도용 컨테이너 (JS 붙일 때 그대로 사용) -->
        <div id="mpkMap" class="map-canvas" aria-label="지도 영역">
          <div class="map-placeholder">지도(Leaflet)가 여기에 표시됩니다.</div>
        </div>
      </section>

      <!-- 오른쪽: 폼(드롭다운/콤보박스) -->
      <section class="right-pane">

        <!-- 1차: 국가/지역 -->
        <div class="dropdown-container">
          <label class="dropdown-label" for="countryCombo">[1] 국가/지역 선택</label>
        
          <div class="combo-line">
            <div class="combo" id="countryCombo">
              <input type="text" placeholder="국가 선택" autocomplete="off">
              <div class="list"></div>
            </div>
          </div>
        
          <div class="combo-line">
            <div class="combo" id="regionCombo">
              <input type="text" placeholder="배송 지역 선택" autocomplete="off" disabled>
              <div class="list"></div>
            </div>
          </div>
        </div>

        <!-- 2차 선택: 업체/POE -->
        <div class="dropdown-container">
          <label class="dropdown-label" for="companyCombo">[2] 파트너/POE/화물타입 선택</label>
        
          <div class="combo-line">
            <div class="combo" id="companyCombo">
              <input type="text" placeholder="파트너 선택" autocomplete="off" disabled>
              <div class="list"></div>
            </div>
          </div>
        
          <div class="combo-line">
            <div class="combo" id="poeCombo">
              <input type="text" placeholder="POE 선택" autocomplete="off" disabled>
              <div class="list"></div>
            </div>
          </div>
          
          <div class="combo-line">
            <div class="combo" id="cargoTypeCombo">
              <input type="text" placeholder="화물 타입 선택" autocomplete="off" disabled />
              <div class="list"></div>
            </div>
          </div>
          
        </div>
    
        <!-- 3차 선택 -->
        <div class="dropdown-container">
          <label class="dropdown-label" for="cargoTypeSelect">[3] 컨테이너 타입/CBM 선택</label>
        
          <div class="combo-line">
            <div class="combo" id="typeCombo">
              <input type="text" placeholder="20FT / 40HC / CONSOLE" autocomplete="off" disabled>
              <div class="list"></div>
            </div>
          </div>
        
          <div class="combo-line">
            <select id="cbmSelect" class="dropdown-select" required>
              <option value="" disabled selected hidden>CBM 선택</option>
            </select>
          </div>
        </div>



        <!-- 조회 버튼 -->
      <div class="action-row center show revealed">
        <button id="btnFetch" class="primary-btn" type="button">조회</button>
      </div>
      </section>
    </div>
  </main>
  
  <!-- ✅ 접힘 상태에서 보여줄 요약 바 (처음엔 숨김) -->
  <section id="collapsedSummary" class="collapsed-summary" hidden>
    <div class="container">
      <div class="chips">
        <button class="chip" data-key="country">
          <span class="k">국가</span><span class="v" id="sumCountry">-</span>
        </button>
        <button class="chip" data-key="region">
          <span class="k">지역</span><span class="v" id="sumRegion">-</span>
        </button>
        <button class="chip" data-key="cbm">
          <span class="k">CBM/컨테이너</span><span class="v" id="sumCbmType">-</span>
        </button>
        <button class="chip" data-key="company">
          <span class="k">파트너</span><span class="v" id="sumCompany">-</span>
        </button>
      </div>
    </div>
  </section>
  
  <!-- ✅ 결과 표 (항상 app-shell 바깥) -->
  <section id="resultSection" class="result-section">
    <div class="result-container container">
      <div id="tableWrap" class="table-wrap"></div>
    </div>
  </section>
  
<script>
/* ============================================================================
   0) 전역 상수 / 공통 유틸
   - CDN 경로, API BASE, 이스케이프/토스트/거리계산 등
   ========================================================================== */
const SHELL_STATES = Object.freeze({
  OPEN: 'OPEN',
  COLLAPSING: 'COLLAPSING',
  COLLAPSED: 'COLLAPSED',
  EXPANDING: 'EXPANDING',
});

let __shellState = SHELL_STATES.OPEN;     // 시작은 열린 상태
let __summaryClickLocked = false;         // 요약바 클릭 잠금
let __justCollapsedAt = 0;                // 마지막 접힘 시각(ms)
let __allowExpand = false;
  
const BASE = 'https://notion-api-hub.vercel.app';

const LCSS = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.css";
const LJS  = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js";
const GCSS = "https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css";
const GJS  = "https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js";

function loadCssOnce(href){
  return new Promise((res, rej)=>{
    if (document.querySelector(`link[href="${href}"]`)) return res();
    const l = document.createElement('link');
    l.rel='stylesheet'; l.href=href; l.onload=res; l.onerror=rej; document.head.appendChild(l);
  });
}
function loadJsOnce(src){
  return new Promise((res, rej)=>{
    if (document.querySelector(`script[src="${src}"]`)) return res();
    const s = document.createElement('script');
    s.src=src; s.onload=res; s.onerror=rej; document.head.appendChild(s);
  });
}

function esc(s){
  return String(s==null?'':s).replace(/[&<>"']/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
}
function toast(msg){
  try{
    const d=document.createElement('div');
    d.textContent=msg;
    d.style.cssText="position:fixed;left:50%;top:32vh;transform:translate(-50%,-50%);background:rgba(0,0,0,.82);color:#fff;padding:10px 14px;border-radius:10px;z-index:9999;font-size:14px;box-shadow:0 10px 24px rgba(0,0,0,.35)";
    document.body.appendChild(d);
    setTimeout(()=>d.remove(),1500);
  }catch(_){}
}
function haversineKm(aLat,aLng,bLat,bLng){
  const R=6371, dLat=(bLat-aLat)*Math.PI/180, dLng=(bLng-aLng)*Math.PI/180;
  const A=Math.sin(dLat/2)**2+Math.cos(aLat*Math.PI/180)*Math.cos(bLat*Math.PI/180)*Math.sin(dLng/2)**2;
  return 2*R*Math.asin(Math.sqrt(A));
}
function findNearest(lat,lng,pts){
  if(!pts?.length) return null;
  let best=null,bd=Infinity;
  for(const p of pts){
    const d=haversineKm(lat,lng,p.lat,p.lng);
    if(d<bd){best=p;bd=d;}
  }
  return {point:best,distanceKm:bd};
}

  
/* ============================================================================
   1) 커스텀 콤보/셀렉트 접근자
   - getComboAPI: 페이지에 이미 커스텀 콤보가 있으면 우선 사용
   - getValue_soft: 콤보/인풋/셀렉트 통합 읽기
   - setSelectOptions: select용 옵션 세팅(필요 시)
   ========================================================================== */
function getComboAPI(id){
  const root = document.getElementById(id);
  const input = root?.querySelector('input');
  const list  = root?.querySelector('.list');

  // 기존 커스텀 콤보 객체가 있으면 우선 사용
  if (window[id] && typeof window[id].setItems === 'function') {
    return {
      setItems: (arr)=>window[id].setItems(arr),
      setValue: (v)=>window[id].setValue?.(v),
      getValue: ()=>window[id].getValue?.(),
      enable:   (on)=>{ if (input) input.disabled = !on; }
    };
  }

  // 폴백: 간단 콤보(이 페이지 단독으로도 동작하도록)
  return {
    setItems: (arr)=>{
      if (!list || !input) return;
      list.innerHTML = (arr||[]).map(v=>`<div class="item" data-v="${v}">${v}</div>`).join('');
      list.querySelectorAll('.item').forEach(it=>{
        it.addEventListener('click', ()=>{
          input.value = it.getAttribute('data-v') || '';
          list.style.display = 'none';
          input.dispatchEvent(new Event('change',{bubbles:true}));
        });
      });
      input.addEventListener('focus', ()=>{ list.style.display='block'; });
      input.addEventListener('input', ()=>{ list.style.display='block'; });
      document.addEventListener('pointerdown',(e)=>{ if (!root.contains(e.target)) list.style.display='none'; });
    },
    setValue: (v)=>{ if(input){ input.value = v; input.dispatchEvent(new Event('change',{bubbles:true})); } },
    getValue: ()=> input?.value?.trim() || '',
    enable:   (on)=>{ if (input) input.disabled = !on; }
  };
}
function setSelectOptions(selectId, values){
  const sel = document.getElementById(selectId);
  if (!sel) return;
  sel.innerHTML = [
    `<option value="" disabled selected hidden>화물 타입 선택</option>`,
    ...values.map(v=>`<option value="${v}">${v}</option>`)
  ].join('');
}
function getValue_soft(id){
  const combo = getComboAPI(id);
  const val1 = combo.getValue?.();
  if (val1) return val1;
  const sel = document.getElementById(id);
  if (sel && 'value' in sel) return sel.value;
  const inp = document.querySelector(`#${id} input`);
  return inp?.value?.trim() || '';
}

/* ============================================================================
   2) 좌측 Leaflet 지도 (상시 노출)
   - initAlwaysOnMap: Leaflet/Geocoder 로드 + 지도 초기화
   - setMapCountry: map.json의 국가 포인트 마커 세팅
   - zoomToRegion: 지역명으로 지도 줌(정확/부분 일치)
   ========================================================================== */
let map, markerLayer, geocoder, mapInited=false, mapData=null, tmpSearch=null;
let __countryPoints = [];
const pinReg    = '#2563eb';
const pinSearch = '#ef4444';

function makeSvgPinIcon(color){
  const svg = `<svg class="pin-svg" viewBox="0 0 24 24" aria-hidden="true"><path fill="${color}" d="M12 2C8.134 2 5 5.134 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.866-3.134-7-7-7zm0 9.5a2.5 2.5 0 1 1 0-5a2.5 2.5 0 0 1 0 5z"/></svg>`;
  return L.divIcon({ className:"", html:`<div class="pin-wrap">${svg}</div>`, iconSize:[26,26], iconAnchor:[13,26] });
}
function normalizeCountryKey(raw){ return String(raw||'').trim(); }

async function initAlwaysOnMap(){
  if (mapInited) return;
  await loadCssOnce(LCSS); await loadJsOnce(LJS);
  await loadCssOnce(GCSS); await loadJsOnce(GJS);

  const worldBounds = L.latLngBounds([[-85,-180],[85,180]]);
  map = L.map('mpkMap', { center:[20,0], zoom:2, worldCopyJump:false, maxBounds:worldBounds, maxBoundsViscosity:1.0 });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OSM', noWrap:true, bounds:worldBounds }).addTo(map);
  markerLayer = L.layerGroup().addTo(map);

  // 지오코더
  geocoder = L.Control.geocoder({ defaultMarkGeocode:false })
    .on('markgeocode', (e)=>{
      const c = e.geocode.center;
      if (tmpSearch) { map.removeLayer(tmpSearch); tmpSearch=null; }
      tmpSearch = L.marker(c, {icon: makeSvgPinIcon(pinSearch)}).addTo(map);
      map.setView(c, 9);

      // 최근접 등록 지역 자동 선택
      const hit = findNearest(c.lat, c.lng, __countryPoints);
      if (hit?.point){
        setRegion(hit.point.name);
        toast(`가장 가까운 등록 지역: ${hit.point.name} (~${hit.distanceKm.toFixed(1)}km)`);
      }
    }).addTo(map);

  // 국가별 포인트 데이터 로드
  try{
    const r = await fetch('./map.json', {cache:'no-store'});
    mapData = await r.json();
  }catch(e){
    console.warn('map.json 로드 실패:', e);
    mapData = {};
  }

  mapInited = true;
  setTimeout(()=> map.invalidateSize(), 100);
}
function setMapCountry(country){
  if (!mapInited) return;
  markerLayer.clearLayers();
  __countryPoints = [];
  if (!mapData) return;
  const key = normalizeCountryKey(country);
  const pts = mapData[key];
  if (!pts || !pts.length){ toast(`해당 국가 데이터가 없습니다: ${country}`); return; }

  const bounds = [];
  pts.forEach(p=>{
    const m = L.marker([p.lat, p.lng], { icon: makeSvgPinIcon(pinReg) }).addTo(markerLayer);
    m.on('click', ()=>{ setRegion(p.name); toast(`지역 선택: ${p.name}`); });
    __countryPoints.push({ ...p, marker:m });
    bounds.push([p.lat, p.lng]);
  });
  if (bounds.length) map.fitBounds(bounds, { padding:[20,20] });
}
function zoomToRegion(regionName, {fallbackZoom=10} = {}){
  if (!map || !regionName) return;
  const name = String(regionName).trim();
  if (!name) return;

  // 1) 현재 국가 마커 목록에서 정확 일치
  let hit = __countryPoints?.find(p => {
    const a = (p.name || '').replace(/,/g,'').trim().toLowerCase();
    const b = name.replace(/,/g,'').trim().toLowerCase();
    return a === b;
  });
  // 2) 부분 일치
  if (!hit && Array.isArray(__countryPoints)) {
    const b = name.replace(/,/g,'').trim().toLowerCase();
    hit = __countryPoints.find(p => (p.name||'').toLowerCase().includes(b));
  }
  // 3) map.json 원본에서 탐색
  if (!hit) {
    const country = getValue_soft('countryCombo');
    const key = normalizeCountryKey(country);
    const pts = mapData?.[key] || [];
    const b = name.replace(/,/g,'').trim().toLowerCase();
    hit = pts.find(p => (p.name||'').replace(/,/g,'').trim().toLowerCase() === b)
        || pts.find(p => (p.name||'').toLowerCase().includes(b));
  }
  if (hit && Number.isFinite(hit.lat) && Number.isFinite(hit.lng)) {
    map.setView([hit.lat, hit.lng], fallbackZoom, { animate:true });
    try { hit.marker?.openPopup?.(); } catch(_){}
  } else {
    console.warn('zoomToRegion: 지역을 찾지 못했습니다 →', regionName);
  }
}

/* 국가/지역 값 접근자 + 지역 세터 (지도 줌 포함) */
function getCountry(){ const el = document.querySelector('#countryCombo input'); return el?.value?.trim() || ''; }
function getRegion(){  const el = document.querySelector('#regionCombo input');  return el?.value?.trim() || ''; }
function setRegion(v){
  const combo = document.querySelector('#regionCombo input');
  if (combo){
    combo.value = v;
    combo.dispatchEvent(new Event('input',{bubbles:true}));
    combo.dispatchEvent(new Event('change',{bubbles:true}));
  }
  zoomToRegion(v, { fallbackZoom: 10 });
}

/* ============================================================================
   3) 고정 옵션 / 초기 데이터 로딩
   - 컨테이너 타입: 20FT/40HC/CONSOLE
   - CBM: 1~60
   - 국가 목록
   ========================================================================== */
function setTypeComboFixed(){
  const typeAPI = getComboAPI('typeCombo');
  typeAPI.setItems(['20FT','40HC','CONSOLE']);
  typeAPI.enable(true); // 기본값 자동 선택 없음
}
function setCBMRange(){
  const values = Array.from({length:60}, (_,i)=> i + 1);
  const sel = document.getElementById('cbmSelect');
  if (sel){
    sel.innerHTML = [
      `<option value="" disabled selected hidden>CBM 선택</option>`,
      ...values.map(v => `<option value="${v}">${v}</option>`)
    ].join('');
  }
}
async function loadCountries(){
  const countryAPI = getComboAPI('countryCombo');
  try{
    const r = await fetch(`${BASE}/api/debug/config`, {cache:'no-store'});
    const j = await r.json();
    const countries = j.countries || Object.keys(j.dbStructure||{}) || [];
    countryAPI.setItems(countries);
    countryAPI.enable(true);
  }catch(e){
    countryAPI.setItems([]); countryAPI.enable(true);
    console.warn('loadCountries 실패:', e);
  }
}

/* ============================================================================
   4) Notion 연동: 지역/업체/POE/화물타입 로더
   - 지역: /api/regions/:country
   - 업체: /api/companies/by-region?country=&region=&mode=options
   -  POE: /api/poe/by-company (폴백: /api/poe/by-region)
   - 화물타입: /api/cargo-types/by-partner?country=&company=&region= (폴백: /api/costs 집계)
   ========================================================================== */
async function loadRegions(){
  const country = getValue_soft('countryCombo');
  const regionAPI = getComboAPI('regionCombo');
  const companyAPI= getComboAPI('companyCombo');
  const poeAPI    = getComboAPI('poeCombo');

  // 하위 의존 콤보 초기화/비활성
  regionAPI.setItems([]); regionAPI.enable(false);
  companyAPI.setItems([]); companyAPI.enable(false);
  poeAPI.setItems([]);     poeAPI.enable(false);
  if(!country) return;

  try{
    const r = await fetch(`${BASE}/api/regions/${encodeURIComponent(country)}`, {cache:'no-store'});
    const j = await r.json();
    const regions = j.regions || [];
    regionAPI.setItems(regions);
    regionAPI.enable(true);
  }catch(e){
    console.warn('loadRegions 실패:', e);
    regionAPI.setItems([]); regionAPI.enable(false);
  }
}
async function loadCompanies(){
  const country   = getValue_soft('countryCombo');
  const region    = getValue_soft('regionCombo');
  const companyAPI= getComboAPI('companyCombo');
  const poeAPI    = getComboAPI('poeCombo');

  companyAPI.setItems([]); companyAPI.enable(false);
  poeAPI.setItems([]);     poeAPI.enable(false);
  if(!country || !region) return;

  try{
    const url = `${BASE}/api/companies/by-region?country=${encodeURIComponent(country)}&region=${encodeURIComponent(region)}&mode=options`;
    const r = await fetch(url, {cache:'no-store'});
    const j = await r.json();
    const companies = (j.companies || []).filter(Boolean);
    companyAPI.setItems(companies);
    companyAPI.enable(companies.length>0);
  }catch(e){
    console.warn('loadCompanies 실패:', e);
    companyAPI.setItems([]); companyAPI.enable(false);
  }
}
async function loadPOEs(){
  const country   = getValue_soft('countryCombo');
  const region    = getValue_soft('regionCombo');
  const company   = getValue_soft('companyCombo');
  const poeAPI    = getComboAPI('poeCombo');

  poeAPI.setItems([]); poeAPI.enable(false);
  if(!country || !region || !company) return;

  try{
    // 권장: by-company
    let url = `${BASE}/api/poe/by-company?country=${encodeURIComponent(country)}&region=${encodeURIComponent(region)}&company=${encodeURIComponent(company)}&mode=options`;
    let res = await fetch(url, {cache:'no-store'});
    if (!res.ok) throw new Error('by-company not ok');
    let j = await res.json();
    let poes = (j.poes || j.POE || j.options || []).filter(Boolean);

    // 폴백: by-region
    if (!poes.length){
      url = `${BASE}/api/poe/by-region?country=${encodeURIComponent(country)}&region=${encodeURIComponent(region)}&mode=options`;
      res = await fetch(url, {cache:'no-store'});
      j = await res.json();
      poes = (j.poes || j.POE || j.options || []).filter(Boolean);
    }

    poeAPI.setItems(poes);
    poeAPI.enable(poes.length>0);
  }catch(e){
    console.warn('loadPOEs 실패:', e);
    poeAPI.setItems([]); poeAPI.enable(false);
  }
}

/* 화물타입: 파트너 기준 + 폴백 집계 */
function setCargoTypeComboItems(items){
  const api = getComboAPI('cargoTypeCombo');
  api.setItems(items || []);
  api.setValue?.('');                  // 이전 선택 제거(자동선택 금지)
  api.enable(!!(items && items.length));
}
async function loadCargoTypes_forPartner(){
  const country = getValue_soft('countryCombo');
  const region  = getValue_soft('regionCombo');
  const partner = getValue_soft('companyCombo');

  if (!country || !partner){ setCargoTypeComboItems([]); return; }

  const fetchJson = async (url) => {
    const res = await fetch(url, { cache:'no-store' });
    if (!res.ok) return null;
    return res.json();
  };
  let list = [];

  try{
    // 1) by-partner (region 포함)
    let url = `${BASE}/api/cargo-types/by-partner?country=${encodeURIComponent(country)}&company=${encodeURIComponent(partner)}${region ? `&region=${encodeURIComponent(region)}` : ''}&mode=options`;
    let j = await fetchJson(url);
    if (j) list = (j.types || j.options || []).filter(Boolean);

    // 2) 폴백: /api/costs 에서 해당 파트너 행들만 조회하여 "화물타입"을 집계
    if (!list.length){
      url = `${BASE}/api/costs/${encodeURIComponent(country)}?company=${encodeURIComponent(partner)}${region ? `&region=${encodeURIComponent(region)}` : ''}&mode=data`;
      j = await fetchJson(url);
      const rows = j?.rows || j?.data || j?.items || j?.results || [];
      const bucket = new Set();
      for (const row of rows){
        const ms = row?.properties?.["화물타입"]?.multi_select || [];
        ms.forEach(it => it?.name && bucket.add(it.name));
        if (Array.isArray(row?.roles))      row.roles.forEach(x => x && bucket.add(String(x)));
        if (Array.isArray(row?.cargoTypes)) row.cargoTypes.forEach(x => x && bucket.add(String(x)));
        if (row?.cargoType)                 bucket.add(String(row.cargoType));
      }
      list = [...bucket].sort((a,b)=> a.localeCompare(b,'ko'));
    }

    setCargoTypeComboItems(list);
  }catch(e){
    console.warn('loadCargoTypes_forPartner error:', e);
    setCargoTypeComboItems([]);
  }
}

/* ============================================================================
   5) 결과 렌더링 (표)
   - /api/costs 응답 기반 표 생성
   ========================================================================== */
let __numberFormats = {};  // Notion 숫자 포맷 메타 (백엔드에서 내려줌)

function formatAmount(n, columnKey){
  if (n==null || n==='' || isNaN(Number(n))) return '';
  const v = Number(n);
  const fmt = __numberFormats?.[columnKey] || '';
  if (/dollar|usd/i.test(fmt)) return '$' + v.toLocaleString('en-US');
  if (/won|krw/i.test(fmt))    return '₩' + v.toLocaleString('ko-KR');
  if (/euro|eur/i.test(fmt))   return '€' + v.toLocaleString('de-DE');
  return v.toLocaleString();
}
function renderTable(data, type, isRegionFiltered){
  const wrap = document.getElementById('tableWrap');
  if (!wrap) return;

  const rows = Array.isArray(data?.rows) ? data.rows : [];
  if (!rows.length){
    wrap.innerHTML = '<div class="muted">표시할 데이터가 없습니다.</div>';
    return;
  }

  // 헤더
  let thead = '<tr><th>항목</th>';
  if (!isRegionFiltered) thead += '<th>지역</th>';
  thead += `<th class="type-col">${esc(type)}</th><th>비고</th></tr>`;

  // 바디
  let tbody = '';
  for (const r of rows){
    const amt = r?.[type];
    const amtText = formatAmount(amt, type) || '-';
    tbody += '<tr>';
    tbody += `<td>${esc(r.item || '')}</td>`;
    if (!isRegionFiltered) tbody += `<td>${esc(r.region || '')}</td>`;
    tbody += `<td class="amt">${amtText}</td>`;
    tbody += `<td>${r.extra || ''}</td>`;
    tbody += '</tr>';
  }

  wrap.innerHTML = `
    <table class="result-table">
      <thead>${thead}</thead>
      <tbody>${tbody}</tbody>
    </table>
  `;
}

/* ============================================================================
   6) 조회 후 접힘 기능 및 요약 생성
   ========================================================================== */

function collapseShell(){
  return new Promise((resolve)=>{
    const shell = document.querySelector('.app-shell');
    if (!shell) return resolve();

    if (__shellState === SHELL_STATES.COLLAPSED || __shellState === SHELL_STATES.COLLAPSING) {
      return resolve();
    }

    __shellState = SHELL_STATES.COLLAPSING;

    shell.classList.remove('is-collapsed','is-expanding');
    shell.style.display = 'block';
    const h = shell.scrollHeight;
    shell.style.maxHeight = h + 'px';

    requestAnimationFrame(()=>{
      shell.classList.add('is-collapsing');
      shell.style.maxHeight = '0px';
    });

    const onEnd = (e)=>{
      if (e.propertyName !== 'max-height') return;
      shell.removeEventListener('transitionend', onEnd);
      shell.classList.remove('is-collapsing');
      shell.classList.add('is-collapsed');
      shell.style.maxHeight = '';
     shell.style.display = 'none';   // ✅ 접힌 직후, 완전 잠금
      __shellState = SHELL_STATES.COLLAPSED;
      __justCollapsedAt = performance.now();
      resolve();
    };
    shell.addEventListener('transitionend', onEnd);
  });
}

function expandShell(){
  return new Promise((resolve)=>{
    const shell = document.querySelector('.app-shell');
    if (!shell) return resolve();

  // ✅ 요약 클릭으로 허용된 상황 + 실제 접힌 상태에서만 열기
     if (!__allowExpand || __shellState !== SHELL_STATES.COLLAPSED) {
      return resolve();
    }

    __shellState = SHELL_STATES.EXPANDING;

    shell.classList.remove('is-collapsed');
    shell.style.display = 'block';
    shell.style.maxHeight = '0px';

    requestAnimationFrame(()=>{
      shell.classList.add('is-expanding');
      const h = shell.scrollHeight;
      shell.style.maxHeight = h + 'px';
    });

    const onEnd = (e)=>{
      if (e.propertyName !== 'max-height') return;
      shell.removeEventListener('transitionend', onEnd);
      shell.classList.remove('is-expanding');
      shell.style.maxHeight = '';
      __shellState = SHELL_STATES.OPEN;
      __allowExpand = false; // ✅ 한 번 열면 다시 잠금
      resolve();
    };
    shell.addEventListener('transitionend', onEnd);
  });
}
  
async function fillAndShowSummary({country, region, cbm, type, company}){
  // 요약 텍스트 채우기
  document.getElementById('sumCountry').textContent = country || '-';
  document.getElementById('sumRegion').textContent  = region  || '(전체)';
  const cbmTxt = type ? (cbm ? `${cbm} CBM / ${type}` : `${type}`) : (cbm ? `${cbm} CBM` : '-');
  document.getElementById('sumCbmType').textContent = cbmTxt;
  document.getElementById('sumCompany').textContent = company || '-';

  // 1) 먼저 완전히 접힘을 보장 (끝날 때까지 대기)
  await collapseShell();

  // 2) 요약 바 표시 (같은 클릭 전파 방지)
  const bar = document.getElementById('collapsedSummary');
  if (bar){
    __summaryClickLocked = true;         // 잠깐 잠금
    requestAnimationFrame(()=>{
      bar.hidden = false;
      bar.classList.add('reveal');
      bar.style.pointerEvents = 'none';

      // 결과로 스크롤
      document.getElementById('resultSection')?.scrollIntoView({behavior:'smooth', block:'start'});

      setTimeout(()=>{
        bar.classList.remove('reveal');
        bar.style.pointerEvents = 'auto';
        __summaryClickLocked = false;    // 잠금 해제
      }, 320); // CSS 애니메이션과 맞춤
    });
  }
}



async function openAppShellFromSummary(){
  const bar = document.getElementById('collapsedSummary');
  if (bar) bar.hidden = true; // 요약 먼저 숨김

  await expandShell();        // app-shell 부드럽게 펼치기

  document.querySelector('.app-shell')?.scrollIntoView({behavior:'smooth', block:'start'});
}

  
/* ============================================================================
   7) 이벤트 바인딩
   - 국가 변경 → 지역 로드 + 지도 갱신 + 화물타입 리셋
   - 지역 변경 → 업체 로드 + 지도 줌 + 화물타입 리셋
   - 업체 변경 → POE 로드 + 화물타입 로드(핵심)
   - 조회 버튼 → /api/costs 조회 + 테이블 렌더 + 결과 섹션 표시
   ========================================================================== */
function wireEvents(){
  const ccEl   = document.querySelector('#countryCombo input') || document.getElementById('countryCombo');
  const rcEl   = document.querySelector('#regionCombo input')  || document.getElementById('regionCombo');
  const compEl = document.querySelector('#companyCombo input') || document.getElementById('companyCombo');

  // 국가 변경
  ccEl?.addEventListener('change', async ()=>{
    await loadRegions();
    setCargoTypeComboItems([]); // 파트너 선택 전 → 비활성
    const c = getCountry();
    if (c) setMapCountry(c);
  });

  // 지역 변경
  rcEl?.addEventListener('change', async ()=>{
    await loadCompanies();
    setCargoTypeComboItems([]); // 파트너 선택 전 → 비활성
    const region = getRegion();
    if (region) zoomToRegion(region, { fallbackZoom: 10 });
  });

  // 업체(파트너) 변경
  compEl?.addEventListener('change', async ()=>{
    await loadPOEs();
    loadCargoTypes_forPartner(); // ← 여기서 실제 화물타입 옵션 채움
  });

  // 조회 버튼
  document.getElementById('btnFetch')?.addEventListener('click', async (ev)=>{
    ev.preventDefault();                // 폼 기본동작 방지(안전)
    const btn = ev.currentTarget;
    if (btn.disabled) return;           // 중복 클릭 방지
    btn.disabled = true;
  
    try{
      const country = getValue_soft('countryCombo');
      const region  = getValue_soft('regionCombo');
      const company = getValue_soft('companyCombo');
      const type    = getValue_soft('typeCombo') || '20FT';
      const cbmSel  = document.getElementById('cbmSelect');
      const cbm     = cbmSel?.value ? Number(cbmSel.value) : undefined;
      const cargo   = getValue_soft('cargoTypeCombo');
  
      if (!country){ alert('국가를 선택하세요.'); return; }
      if (!company){ alert('업체를 선택하세요.'); return; }
  
      const roles = cargo ? [cargo.toUpperCase()] : [];
      const params = new URLSearchParams();
      params.set('type', type);
      params.set('company', company);
      if (region) params.set('region', region);
      if (roles.length) params.set('roles', roles.join(','));
      if (!isNaN(cbm)) params.set('cbm', String(cbm));
  
      const url = `${BASE}/api/costs/${encodeURIComponent(country)}?${params.toString()}`;
      const res = await fetch(url, { cache:'no-store' });
      const j   = await res.json();
  
      __numberFormats = j?.numberFormats || {};
      renderTable(j, type, Boolean(region));
      document.getElementById('resultSection')?.classList.add('show');
      document.querySelector('.action-row.center')?.classList.add('show','revealed');
  
      // ✅ 접고 요약 노출
      await fillAndShowSummary({ country, region, cbm, type, company });
    }catch(e){
      console.error(e);
      alert('조회 중 오류가 발생했습니다.');
    }finally{
      btn.disabled = false;
    }
  });
}

/* ============================================================================
   7) 초기화 (단 한 번)
   - 지도 초기화
   - 고정 옵션 세팅(type/CBM)
   - 국가 목록 로딩
   - 바인딩
   - 초기 값 있었다면 지도/화물타입 선반영
   ========================================================================== */
window.addEventListener('DOMContentLoaded', async ()=>{
  // 지도
  try{ await initAlwaysOnMap(); }catch(_){}

  // 고정 옵션
  setTypeComboFixed();   // 20FT / 40HC / CONSOLE
  setCBMRange();         // 1 ~ 60 (placeholder 유지)

  // 국가 로딩 + 바인딩
  await loadCountries();
  wireEvents();

  // 초기 국가가 있으면 지도 반영
  const initialCountry = getCountry();
  if (initialCountry) setMapCountry(initialCountry);

  // 초기 파트너가 있으면 화물타입 선로딩
  loadCargoTypes_forPartner();
  
  // 요약 바 클릭 → 다시 펼치기
  const sumEl = document.getElementById('collapsedSummary');
  if (sumEl) {
    sumEl.addEventListener('click', (e)=>{
      // 방금 접힌 직후 같은 클릭이 전파되는 경우 차단
      if (__summaryClickLocked) return;
      if (performance.now() - __justCollapsedAt < 450) {
        e.preventDefault();
        e.stopPropagation();
        return;
      }
      // ✅ 오직 요약 클릭에서만 확실히 열기
      __allowExpand = true;         // ✅ 이때만 펼침 허용
      expandShell().then(()=>{
        sumEl.hidden = true; // 요약 숨김
        document.querySelector('.app-shell')?.scrollIntoView({behavior:'smooth', block:'start'});
      });
    });
  }
});
</script>

</body>
</html>
