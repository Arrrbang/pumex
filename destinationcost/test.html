<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>도착지 비용 계산</title>

  <!-- 폰트: 로그인 페이지와 동일 -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="./newstyles.css" />
</head>
<body>
  <div class="page-bg" aria-hidden="true"></div>

  <!-- 상단 바 -->
  <header class="site-header">
    <div class="container header-inner">
      <a class="brand" href="#">
        <img src="https://arrrbang.github.io/pumex/image/pumexlogonew.png" alt="PUMEX Logo" class="brand__logo" />
      </a>
      <a class="header__title" href="#">도착지 비용 계산</a>
      <nav class="header__nav" aria-label="상단 링크"> // 이동할 링크 추가
      </nav>
    </div>
  </header>

  <!-- 메인 -->
<main class="container section">
  <!-- SVC: 단일 메가 컨테이너 -->
  <section class="svc-card" aria-label="도착지 비용 계산">

    <!-- 상단 배너(피그마 이미지) -->
    <div class="svc__banner">
      <img src="./Slide 16_9 - 1.svg" alt="" class="svc__banner-img" />
    </div>

    <!-- 바디: 좌(흰 영역 = 지도) / 우(폼 전체) -->
<div class="v104_119"><!-- 메인 래퍼 (피그마) -->
  <!-- 회색 큰 카드 -->
  <div class="v104_121">

    <!-- LEFT: 흰 박스(지도 영역) -->
    <div class="v104_122">
      <!-- 지도 헤더 -->
      <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid #e5e7eb">
        <strong style="color:#111827">지도</strong>
        <button id="btnSelectOnMap" type="button" style="border:2px solid #14532D;background:#fff;color:#14532D;border-radius:999px;padding:8px 14px;font-weight:700;cursor:pointer">
          지도에서 선택
        </button>
      </div>
      <!-- 상시 지도 캔버스 -->
      <div id="mapAlways" style="height:520px;background:#e6efe8;border-top:1px solid #eef2f7"></div>
      <div style="padding:8px 12px;color:#6b7280;font-size:12px">
        국가 선택 시 해당 국가 마커 표시 & 수도 기준 줌(추후 단계별 기능 추가)
      </div>
    </div>

    <!-- RIGHT-1: 1) 국가 / 지역 선택 (v106_5 영역 안에 실제 컨트롤 삽입) -->
    <div class="v106_5">
      <div class="v104_123">
        <div style="position:absolute;inset:0;padding:8px 10px">
          <label style="font-weight:700;color:#111827;display:block;margin-bottom:6px">국가</label>
          <div class="combo" id="countryCombo">
            <input type="text" placeholder="국가 입력/선택 (예: 미국, 중국)" autocomplete="off" style="width:100%;padding:10px 12px;border:2px solid #1F9461;border-radius:10px;background:#fff;">
            <div class="list"></div>
          </div>
        </div>
      </div>

      <div class="v104_127">
        <div style="position:absolute;inset:0;padding:8px 10px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
            <label style="font-weight:700;color:#111827">지역</label>
            <button id="btnSelectOnMap2" type="button" class="map-button-inline" style="border:2px solid #1F9461;background:#fff;color:#1F9461;border-radius:8px;padding:6px 10px;font-weight:700;cursor:pointer">지도에서 선택</button>
          </div>
          <div class="combo" id="regionCombo">
            <input type="text" placeholder="지역 입력/선택 (예: A지역, B지역)" autocomplete="off" disabled
                   style="width:100%;padding:10px 12px;border:2px solid #1F9461;border-radius:10px;background:#fff;">
            <div class="list"></div>
          </div>
        </div>
      </div>

      <span class="v104_131" style="position:absolute;top:0;left:0">1) 국가 / 지역 선택</span>
    </div>

    <!-- RIGHT-2: 2) 화물/컨테이너/CBM (v106_7) -->
    <div class="v106_7">
      <!-- 컨테이너 -->
      <div class="v104_149">
        <div style="position:absolute;inset:0;padding:8px 10px">
          <label style="font-weight:700;color:#111827;display:block;margin-bottom:6px">컨테이너 타입</label>
          <div class="combo" id="typeCombo">
            <input type="text" placeholder="20FT / 40HC / CONSOLE" value="20FT" autocomplete="off"
                   style="width:100%;padding:10px 12px;border:2px solid #1F9461;border-radius:10px;background:#fff;">
            <div class="list"></div>
          </div>
        </div>
      </div>
      <!-- 화물 타입 -->
      <div class="v104_145">
        <div style="position:absolute;inset:0;padding:8px 10px">
          <label style="font-weight:700;color:#111827;display:block;margin-bottom:6px">화물 타입</label>
          <select id="cargoTypeSelect" style="width:100%;padding:10px 12px;border:2px solid #1F9461;border-radius:10px;background:#fff;">
            <option value="">화물타입 선택</option>
          </select>
        </div>
      </div>
      <!-- CBM -->
      <div class="v104_153">
        <div style="position:absolute;inset:0;padding:8px 10px">
          <label style="font-weight:700;color:#111827;display:block;margin-bottom:6px">CBM 선택</label>
          <select id="cbmSelect" style="width:100%;padding:10px 12px;border:2px solid #1F9461;border-radius:10px;background:#fff;">
            <option value="">CBM 선택</option>
          </select>
        </div>
      </div>

      <span class="v104_143" style="position:absolute;top:0;left:0">3) 화물/컨테이너/CBM</span>
    </div>

    <!-- RIGHT-3: 3) 파트너/POE (v106_6) -->
    <div class="v106_6">
      <!-- 파트너 -->
      <div class="v104_135">
        <div style="position:absolute;inset:0;padding:8px 10px">
          <label style="font-weight:700;color:#111827;display:block;margin-bottom:6px">파트너</label>
          <div class="combo" id="companyCombo">
            <input type="text" placeholder="파트너 입력/선택" autocomplete="off" disabled
                   style="width:100%;padding:10px 12px;border:2px solid #1F9461;border-radius:10px;background:#fff;">
            <div class="list"></div>
          </div>
        </div>
      </div>
      <!-- POE -->
      <div class="v104_139">
        <div style="position:absolute;inset:0;padding:8px 10px">
          <label style="font-weight:700;color:#111827;display:block;margin-bottom:6px">POE</label>
          <div class="combo" id="poeCombo">
            <input type="text" placeholder="POE 입력/선택 (예: DAMMAM, RIYADH DRY PORT)" autocomplete="off" disabled
                   style="width:100%;padding:10px 12px;border:2px solid #1F9461;border-radius:10px;background:#fff;">
            <div class="list"></div>
          </div>
        </div>
      </div>

      <span class="v104_133" style="position:absolute;top:0;left:0">2) 파트너 / POE</span>
    </div>

    <!-- RIGHT-4: 조회 버튼 (v105_2) -->
    <div class="v105_2">
      <button id="btnFetch" type="button" style="all:unset;display:block;width:100%;height:100%;cursor:pointer;text-align:center;color:#fff;font-weight:800;line-height:40px">
        조회
      </button>
    </div>

    <!-- (선택) 가격 비교/단일업체 조회 버튼도 살리고 싶으면 v106_8 / v106_11에 버튼으로 교체 가능 -->
  </div>
</div>

    <!-- FOOT: 결과(같은 카드 안 하단) -->
    <footer class="svc__foot">
      <section id="resultSection" class="result-section">
        <div class="result-container">
          <div id="tableWrap" class="table-wrap"></div>
        </div>
      </section>
    </footer>
  </section>
</main>
  
<script>
const BASE='https://notion-api-hub.vercel.app';
const $=(s,r=document)=>r.querySelector(s);

/* ————— 간단 콤보 ————— */
function makeCombo(el, items=[]){
  const input = el.querySelector('input'); const list = el.querySelector('.list');
  let data=[...items]; let selected=null;
  function render(f=''){ const q=(f||'').toLowerCase().trim();
    list.innerHTML=''; (q?data.filter(x=>String(x).toLowerCase().includes(q)):data)
      .forEach(v=>{ const d=document.createElement('div'); d.className='item'+(selected===v?' is-selected':''); d.textContent=v;
        d.onclick=(e)=>{ e.stopPropagation(); selected=v; input.value=v; el.classList.remove('open'); el.dispatchEvent(new CustomEvent('change',{detail:v})); };
        list.appendChild(d); });
  }
  function setItems(arr){ data=[...new Set((arr||[]).filter(Boolean))]; input.disabled=!data.length; if(document.activeElement!==input) input.value=''; selected=null; render(input.value); }
  function getValue(){ return selected || input.value.trim(); }
  function setValue(v){ selected=v||null; input.value=v??''; render(input.value); el.dispatchEvent(new CustomEvent('change',{detail:v})); }
  input.addEventListener('focus',()=>{ el.classList.add('open'); render(input.value); });
  input.addEventListener('input', ()=>{ el.classList.add('open'); render(input.value); });
  document.addEventListener('pointerdown',(e)=>{ if(!el.contains(e.target)) el.classList.remove('open'); },{passive:true});
  setItems(items); return { setItems, getValue, setValue, root:el, input, list };
}

/* ————— 요소 참조 ————— */
const countryCombo=makeCombo(document.getElementById('countryCombo'));
const regionCombo =makeCombo(document.getElementById('regionCombo'));
const companyCombo=makeCombo(document.getElementById('companyCombo'));
const typeCombo   =makeCombo(document.getElementById('typeCombo'), ['20FT','40HC','CONSOLE']);
const poeCombo    =makeCombo(document.getElementById('poeCombo'));
const cbmSelect   = document.getElementById('cbmSelect');

/* ————— Notion 연동 ————— */
async function loadCountries(){
  try{
    const r=await fetch(`${BASE}/api/debug/config`); const j=await r.json();
    const countries=j.countries || Object.keys(j.dbStructure||{}) || [];
    countryCombo.setItems(countries);
  }catch(e){ countryCombo.setItems([]); }
}
countryCombo.root.addEventListener('change', async ()=>{
  const country=countryCombo.getValue();
  regionCombo.setItems([]); companyCombo.setItems([]); poeCombo.setItems([]);
  regionCombo.input.disabled=true; companyCombo.input.disabled=true; poeCombo.input.disabled=true;
  if(!country) return;
  try{
    const r=await fetch(`${BASE}/api/regions/${encodeURIComponent(country)}`); const j=await r.json();
    const regions=j.regions||[]; regionCombo.setItems(regions); regionCombo.input.disabled = regions.length===0;
  }catch(e){ regionCombo.setItems([]); regionCombo.input.disabled=true; }
  updateCargoTypeOptions();
});
regionCombo.root.addEventListener('change', async ()=>{
  const c=countryCombo.getValue(); const r=regionCombo.getValue();
  companyCombo.setItems([]); companyCombo.input.disabled=true; poeCombo.setItems([]); poeCombo.input.disabled=true;
  if(!c||!r) return;
  try{
    const url=`${BASE}/api/companies/by-region?country=${encodeURIComponent(c)}&region=${encodeURIComponent(r)}&mode=options`;
    const res=await fetch(url); const j=await res.json();
    const companies=(j.companies||[]).filter(Boolean);
    companyCombo.setItems(companies); companyCombo.input.disabled=companies.length===0;
  }catch(e){ companyCombo.setItems([]); companyCombo.input.disabled=true; }
  updateCargoTypeOptions();
});
companyCombo.root.addEventListener('change', async ()=>{
  const c=countryCombo.getValue(); const r=regionCombo.getValue(); const comp=companyCombo.getValue();
  poeCombo.setItems([]); poeCombo.input.disabled=true; if(!c||!r||!comp) return;
  try{
    const url=`${BASE}/api/poe/by-company?country=${encodeURIComponent(c)}&region=${encodeURIComponent(r)}&company=${encodeURIComponent(comp)}&mode=data`;
    const res=await fetch(url); const j=await res.json();
    const poes=(j.poes||[]).filter(Boolean); poeCombo.setItems(poes); poeCombo.input.disabled=poes.length===0;
  }catch(e){ poeCombo.setItems([]); poeCombo.input.disabled=true; }
  updateCargoTypeOptions();
});

/* ————— 타입/CBM ————— */
function setCargoTypeOptions(values){
  const el=document.getElementById('cargoTypeSelect'); if(!el) return;
  el.innerHTML=['<option value="">화물타입 선택</option>'].concat((values||[]).map(v=>`<option value="${String(v)}">${String(v)}</option>`)).join('');
}
function updateCargoTypeOptions(){ setCargoTypeOptions(['DIPLOMAT','NON-DIPLOMAT']); }
function setOptions(selectEl, values, ph='CBM 선택'){
  selectEl.innerHTML=['<option value="">'+ph+'</option>'].concat(values.map(v=>`<option value="${String(v)}">${String(v)}</option>`)).join('');
}
function fillCbmByType(type){
  if(!cbmSelect) return;
  const T=(type||'').toUpperCase();
  let values=[]; if(!T){ setOptions(cbmSelect,[], 'CBM 선택'); return; }
  if(T==='CONSOLE'){ values=Array.from({length:30},(_,i)=>i+1); } else { values=[5,10,15,20,25,30,35,40]; }
  setOptions(cbmSelect, values);
}
typeCombo.root.addEventListener('change', ()=> fillCbmByType(typeCombo.getValue()) );

/* ————— 상시 지도: 표시만 ————— */
const LCSS="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css";
const LJS ="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js";
function loadCssOnce(href){ return new Promise((res,rej)=>{ if(document.querySelector(`link[href="${href}"]`)) return res(); const l=document.createElement('link'); l.rel='stylesheet'; l.href=href; l.onload=res; l.onerror=rej; document.head.appendChild(l); }); }
function loadJsOnce (src ){ return new Promise((res,rej)=>{ if(document.querySelector(`script[src="${src}"]`)) return res(); const s=document.createElement('script'); s.src=src; s.onload=res; s.onerror=rej; document.head.appendChild(s); }); }
let baseMap, baseInited=false;
async function ensureBaseMap(){ await loadCssOnce(LCSS); await loadJsOnce(LJS);
  if(baseInited){ setTimeout(()=> baseMap.invalidateSize(),50); return; }
  const world=L.latLngBounds([[-85,-180],[85,180]]);
  baseMap=L.map('mapAlways',{center:[20,0],zoom:2,worldCopyJump:false,maxBounds:world,maxBoundsViscosity:1.0});
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OSM',noWrap:true,bounds:world}).addTo(baseMap);
  baseInited=true;
}

/* ————— 초기화 ————— */
window.addEventListener('DOMContentLoaded', async ()=>{
  try{ await ensureBaseMap(); }catch(_){}
  try{ await loadCountries(); }catch(_){}
  try{ fillCbmByType(typeCombo.getValue()||'20FT'); }catch(_){}
  try{ updateCargoTypeOptions(); }catch(_){}
});
</script>


</body>
</html>
