<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>도착지 비용 계산</title>

  <!-- 폰트 (기존과 동일 계열) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- 메인 스타일 -->
  <link rel="stylesheet" href="./app.css" />
</head>
<body>

  <!-- 상단 헤더 (간단 버전) -->
<header class="site-header">
  <div class="container header-inner">
    <a class="brand" href="#">
      <img src="https://arrrbang.github.io/pumex/image/pumexlogonew.png" alt="PUMEX Logo" class="brand__logo" />
    </a>
    <a class="header__title" href="#">도착지 비용 계산</a>
    <nav class="header__nav" aria-label="상단 링크"></nav>
  </div>
</header>

  <!-- 메인 앱 셸 -->
  <main class="app-shell">
    <div class="app-main container">

      <!-- 왼쪽: 지도 영역 -->
      <section class="left-pane">
        <!-- Leaflet 지도용 컨테이너 (JS 붙일 때 그대로 사용) -->
        <div id="mpkMap" class="map-canvas" aria-label="지도 영역">
          <div class="map-placeholder">지도(Leaflet)가 여기에 표시됩니다.</div>
        </div>
      </section>

      <!-- 오른쪽: 폼(드롭다운/콤보박스) -->
      <section class="right-pane">

        <!-- 1차: 국가/지역 -->
        <div class="dropdown-container">
          <label class="dropdown-label" for="countryCombo">[1] 국가/지역 선택</label>
        
          <div class="combo-line">
            <div class="combo" id="countryCombo">
              <input type="text" placeholder="국가 선택" autocomplete="off">
              <div class="list"></div>
            </div>
          </div>
        
          <div class="combo-line">
            <div class="combo" id="regionCombo">
              <input type="text" placeholder="배송 지역 선택" autocomplete="off" disabled>
              <div class="list"></div>
            </div>
          </div>
        </div>

        <!-- 2차 선택: 업체/POE -->
        <div class="dropdown-container">
          <label class="dropdown-label" for="companyCombo">[2] 파트너/POE/화물타입 선택</label>
        
          <div class="combo-line">
            <div class="combo" id="companyCombo">
              <input type="text" placeholder="파트너 선택" autocomplete="off" disabled>
              <div class="list"></div>
            </div>
          </div>
        
          <div class="combo-line">
            <div class="combo" id="poeCombo">
              <input type="text" placeholder="POE 선택" autocomplete="off" disabled>
              <div class="list"></div>
            </div>
          </div>
          
          <div class="combo-line">
            <div class="combo" id="cargoTypeCombo">
              <input type="text" placeholder="화물 타입 선택" autocomplete="off" disabled />
              <div class="list"></div>
            </div>
          </div>
          
        </div>
    
        <!-- 3차 선택 -->
        <div class="dropdown-container">
          <label class="dropdown-label" for="cargoTypeSelect">[3] 컨테이너 타입/CBM 선택</label>
        
          <div class="combo-line">
            <div class="combo" id="typeCombo">
              <input type="text" placeholder="20FT / 40HC / CONSOLE" autocomplete="off" disabled>
              <div class="list"></div>
            </div>
          </div>
        
          <div class="combo-line">
            <select id="cbmSelect" class="dropdown-select" required>
              <option value="" disabled selected hidden>CBM 선택</option>
            </select>
          </div>
        </div>



        <!-- 조회 버튼 -->
        <div class="action-row center">
          <button id="btnFetch" class="primary-btn" type="button">조회</button>
        </div>
      </section>
    </div>
    <section id="resultSection" class="result-section">
      <div class="result-container">
        <div id="tableWrap" class="table-wrap"></div>
      </div>
    </section>
  </main>

  <script>
/** ======================= 상시 노출 지도 (좌측 #mpkMap) ======================= */
/* Leaflet & Geocoder 동적 로더 */
function loadCssOnce(href){ return new Promise((res, rej)=>{ if(document.querySelector(`link[href="${href}"]`)) return res(); const l=document.createElement('link'); l.rel='stylesheet'; l.href=href; l.onload=res; l.onerror=rej; document.head.appendChild(l); }); }
function loadJsOnce(src){  return new Promise((res, rej)=>{ if(document.querySelector(`script[src="${src}"]`)) return res(); const s=document.createElement('script'); s.src=src; s.onload=res; s.onerror=rej; document.head.appendChild(s); }); }

const LCSS = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.css";
const LJS  = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js";
const GCSS = "https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css";
const GJS  = "https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js";

/* 콤보 편의 함수(이미 페이지에 makeCombo가 있다면 생략 가능) */
function getCountry(){ const el = document.querySelector('#countryCombo input'); return el?.value?.trim() || ''; }
function getRegion(){  const el = document.querySelector('#regionCombo input');  return el?.value?.trim() || ''; }
function setRegion(v){
  const combo = document.querySelector('#regionCombo input');
  if (combo){ combo.value = v; combo.dispatchEvent(new Event('input',{bubbles:true})); combo.dispatchEvent(new Event('change',{bubbles:true})); }
  zoomToRegion(v, { fallbackZoom: 10 });
}

/* 간단 토스트 */
function toast(msg){ try{ const d=document.createElement('div'); d.textContent=msg; d.style.cssText="position:fixed;left:50%;top:32vh;transform:translate(-50%,-50%);background:rgba(0,0,0,.82);color:#fff;padding:10px 14px;border-radius:10px;z-index:9999;font-size:14px;box-shadow:0 10px 24px rgba(0,0,0,.35)"; document.body.appendChild(d); setTimeout(()=>d.remove(),1500);}catch(_){} }

/* 거리 계산 & 최근접 찾기 */
function haversineKm(aLat,aLng,bLat,bLng){ const R=6371, dLat=(bLat-aLat)*Math.PI/180, dLng=(bLng-aLng)*Math.PI/180; const A=Math.sin(dLat/2)**2+Math.cos(aLat*Math.PI/180)*Math.cos(bLat*Math.PI/180)*Math.sin(dLng/2)**2; return 2*R*Math.asin(Math.sqrt(A)); }
function findNearest(lat,lng,pts){ if(!pts?.length) return null; let best=null,bd=Infinity; for(const p of pts){ const d=haversineKm(lat,lng,p.lat,p.lng); if(d<bd){best=p;bd=d;} } return {point:best,distanceKm:bd}; }

/* 지도 상태 */
let map, markerLayer, geocoder, mapInited=false, mapData=null, tmpSearch=null;
const pinReg    = '#2563eb';
const pinSearch = '#ef4444';

/* 커스텀 핀 */
function makeSvgPinIcon(color) {
  const svg = `<svg class="pin-svg" viewBox="0 0 24 24" aria-hidden="true"><path fill="${color}" d="M12 2C8.134 2 5 5.134 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.866-3.134-7-7-7zm0 9.5a2.5 2.5 0 1 1 0-5a2.5 2.5 0 0 1 0 5z"/></svg>`;
  return L.divIcon({ className: "", html:`<div class="pin-wrap">${svg}</div>`, iconSize:[26,26], iconAnchor:[13,26] });
}

/* 국가 키 보정(필요 시 별칭 매핑 추가) */
function normalizeCountryKey(raw){ return String(raw||'').trim(); }

/* ===== 핵심: 좌측 #mpkMap에 지도 초기화 ===== */
async function initAlwaysOnMap(){
  if (mapInited) return;
  await loadCssOnce(LCSS); await loadJsOnce(LJS);
  await loadCssOnce(GCSS); await loadJsOnce(GJS);

  const worldBounds = L.latLngBounds([[-85,-180],[85,180]]);
  map = L.map('mpkMap', { center:[20,0], zoom:2, worldCopyJump:false, maxBounds:worldBounds, maxBoundsViscosity:1.0 });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OSM', noWrap:true, bounds:worldBounds }).addTo(map);
  markerLayer = L.layerGroup().addTo(map);

  /* 검색 박스(지오코더) */
  geocoder = L.Control.geocoder({ defaultMarkGeocode:false })
    .on('markgeocode', (e)=>{
      const c = e.geocode.center;
      if (tmpSearch) { map.removeLayer(tmpSearch); tmpSearch=null; }
      tmpSearch = L.marker(c, {icon: makeSvgPinIcon(pinSearch)}).addTo(map);
      map.setView(c, 9);

      // 최근접 등록 지역 자동 선택
      const hit = findNearest(c.lat, c.lng, __countryPoints);
      if (hit?.point){
        setRegion(hit.point.name);
        toast(`가장 가까운 등록 지역: ${hit.point.name} (~${hit.distanceKm.toFixed(1)}km)`);
      }
    }).addTo(map);

  /* 국가별 포인트 데이터 로드 (index(70)과 동일 경로 규칙) */
  try{
    const r = await fetch('./map.json', {cache:'no-store'});
    mapData = await r.json();
  }catch(e){
    console.warn('map.json 로드 실패:', e);
    mapData = {};
  }

  mapInited = true;
  setTimeout(()=> map.invalidateSize(), 100);
}

/* 선택 국가의 마커 세팅 (index(70)에서 사용하던 로직을 상시 지도용으로) */
let __countryPoints = [];
function setMapCountry(country){
  if (!mapInited) return;
  markerLayer.clearLayers();
  __countryPoints = [];
  if (!mapData) return;

  const key = normalizeCountryKey(country);
  const pts = mapData[key];
  if (!pts || !pts.length){ toast(`해당 국가 데이터가 없습니다: ${country}`); return; }

  const bounds = [];
  pts.forEach(p=>{
    const m = L.marker([p.lat, p.lng], { icon: makeSvgPinIcon(pinReg) }).addTo(markerLayer);
    m.on('click', ()=>{ setRegion(p.name); toast(`지역 선택: ${p.name}`); });
    __countryPoints.push({ ...p, marker:m });
    bounds.push([p.lat, p.lng]);
  });
  if (bounds.length) map.fitBounds(bounds, { padding:[20,20] });
}

// ===== 바인딩: 페이지 로드시 지도 항상 보이기 + 국가 바뀌면 마커 갱신 =====
window.addEventListener('DOMContentLoaded', async ()=>{
  try{ await initAlwaysOnMap(); }catch(_){}
  // 나라 바뀌면 지도 갱신 (input에 리스너!)
  const cc = document.querySelector('#countryCombo input') || document.querySelector('#countryCombo');
  if (cc){
    cc.addEventListener('change', ()=>{
      const c = getCountry();
      if (c) setMapCountry(c);
    });
  }
  // 이미 국가가 입력돼 있다면 즉시 반영
  const initial = getCountry();
  if (initial) setMapCountry(initial);
});


/* ===================== Notion 연동 드롭다운 로딩 (모달 無 버전) ===================== */
/* 환경: 왼쪽 지도(#mpkMap)는 항상 표시 / 오른쪽 콤보/셀렉트는 기존 ID 재사용 */

/* 0) 기본 설정 */
const BASE = 'https://notion-api-hub.vercel.app';

/* 1) 유틸: 콤보/셀렉트 안전 접근자 (커스텀 콤보가 있으면 우선 사용) */
function getComboAPI(id){
  const root = document.getElementById(id);
  const input = root?.querySelector('input');
  const list  = root?.querySelector('.list');

  // 기존 커스텀 콤보 객체가 있다면 우선 사용
  if (window[id] && typeof window[id].setItems === 'function') {
    return {
      setItems: (arr)=>window[id].setItems(arr),
      setValue: (v)=>window[id].setValue?.(v),
      getValue: ()=>window[id].getValue?.(),
      enable:   (on)=>{ if (input) input.disabled = !on; }
    };
  }

  // 폴백: 간단 콤보
  return {
    setItems: (arr)=>{
      if (!list || !input) return;
      list.innerHTML = (arr||[]).map(v=>`<div class="item" data-v="${v}">${v}</div>`).join('');
      list.querySelectorAll('.item').forEach(it=>{
        it.addEventListener('click', ()=>{
          input.value = it.getAttribute('data-v') || '';
          list.style.display = 'none';
          input.dispatchEvent(new Event('change',{bubbles:true}));
        });
      });
      input.addEventListener('focus', ()=>{ list.style.display='block'; });
      input.addEventListener('input', ()=>{ list.style.display='block'; });
      document.addEventListener('pointerdown',(e)=>{ if (!root.contains(e.target)) list.style.display='none'; });
    },
    setValue: (v)=>{ if(input){ input.value = v; input.dispatchEvent(new Event('change',{bubbles:true})); } },
    getValue: ()=> input?.value?.trim() || '',
    enable:   (on)=>{ if (input) input.disabled = !on; }
  };
}


function setSelectOptions(selectId, values){
  const sel = document.getElementById(selectId);
  if (!sel) return;
    sel.innerHTML = [
      `<option value="" disabled selected hidden>화물 타입 선택</option>`,
      ...values.map(v=>`<option value="${v}">${v}</option>`)
    ].join('');
}

function getValue_soft(id){ // 콤보/인풋/셀렉트 모두 커버
  const combo = getComboAPI(id);
  const val1 = combo.getValue?.();
  if (val1) return val1;
  const sel = document.getElementById(id);
  if (sel && 'value' in sel) return sel.value;
  const inp = document.querySelector(`#${id} input`);
  return inp?.value?.trim() || '';
}

/* 2) 고정 데이터: typeCombo = [20FT, 40HC, CONSOLE] */
function setTypeComboFixed(){
  const typeAPI = getComboAPI('typeCombo');
  typeAPI.setItems(['20FT','40HC','CONSOLE']);
  typeAPI.enable(true);
}


/* 3) CBM: 1 ~ 60 생성 */
function setCBMRange(){
  const values = Array.from({length:60}, (_,i)=> i + 1);
  const sel = document.getElementById('cbmSelect');
  if (sel){
    sel.innerHTML = [
      `<option value="" disabled selected hidden>CBM 선택</option>`,
      ...values.map(v => `<option value="${v}">${v}</option>`)
    ].join('');
  }
}

/* 4) 국가 목록 로드 */
async function loadCountries(){
  const countryAPI = getComboAPI('countryCombo');
  try{
    const r = await fetch(`${BASE}/api/debug/config`, {cache:'no-store'});
    const j = await r.json();
    const countries = j.countries || Object.keys(j.dbStructure||{}) || [];
    countryAPI.setItems(countries);
    countryAPI.enable(true);
  }catch(e){
    countryAPI.setItems([]); countryAPI.enable(true);
    console.warn('loadCountries 실패:', e);
  }
}

/* 5) 지역/업체/POE 로딩 체인 (index (70)의 흐름 유지, 단 모달 제거) */
/* 지역 로딩: /api/regions/{country} */
async function loadRegions(){
  const country = getValue_soft('countryCombo');
  const regionAPI = getComboAPI('regionCombo');
  const companyAPI= getComboAPI('companyCombo');
  const poeAPI    = getComboAPI('poeCombo');

  regionAPI.setItems([]); regionAPI.enable(false);
  companyAPI.setItems([]); companyAPI.enable(false);
  poeAPI.setItems([]);     poeAPI.enable(false);
  if(!country) return;

  try{
    const r = await fetch(`${BASE}/api/regions/${encodeURIComponent(country)}`, {cache:'no-store'});
    const j = await r.json();
    const regions = j.regions || [];
    regionAPI.setItems(regions);
    regionAPI.enable(true);
  }catch(e){
    console.warn('loadRegions 실패:', e);
    regionAPI.setItems([]); regionAPI.enable(false);
  }
}

/* 업체 로딩: /api/companies/by-region?country=&region=&mode=options */
async function loadCompanies(){
  const country   = getValue_soft('countryCombo');
  const region    = getValue_soft('regionCombo');
  const companyAPI= getComboAPI('companyCombo');
  const poeAPI    = getComboAPI('poeCombo');

  companyAPI.setItems([]); companyAPI.enable(false);
  poeAPI.setItems([]);     poeAPI.enable(false);
  if(!country || !region) return;

  try{
    const url = `${BASE}/api/companies/by-region?country=${encodeURIComponent(country)}&region=${encodeURIComponent(region)}&mode=options`;
    const r = await fetch(url, {cache:'no-store'});
    const j = await r.json();
    const companies = (j.companies || []).filter(Boolean);
    companyAPI.setItems(companies);
    companyAPI.enable(companies.length>0);
  }catch(e){
    console.warn('loadCompanies 실패:', e);
    companyAPI.setItems([]); companyAPI.enable(false);
  }
}

/* POE 로딩 (권장: by-company, 폴백: by-region) */
async function loadPOEs(){
  const country   = getValue_soft('countryCombo');
  const region    = getValue_soft('regionCombo');
  const company   = getValue_soft('companyCombo');
  const poeAPI    = getComboAPI('poeCombo');

  poeAPI.setItems([]); poeAPI.enable(false);
  if(!country || !region || !company) return;

  try{
    // 권장 엔드포인트
    let url = `${BASE}/api/poe/by-company?country=${encodeURIComponent(country)}&region=${encodeURIComponent(region)}&company=${encodeURIComponent(company)}&mode=options`;
    let res = await fetch(url, {cache:'no-store'});
    if (!res.ok) throw new Error('by-company not ok');
    let j = await res.json();
    let poes = (j.poes || j.POE || j.options || []).filter(Boolean);

    // 폴백: by-region
    if (!poes.length){
      url = `${BASE}/api/poe/by-region?country=${encodeURIComponent(country)}&region=${encodeURIComponent(region)}&mode=options`;
      res = await fetch(url, {cache:'no-store'});
      j = await res.json();
      poes = (j.poes || j.POE || j.options || []).filter(Boolean);
    }

    poeAPI.setItems(poes);
    poeAPI.enable(poes.length>0);
  }catch(e){
    console.warn('loadPOEs 실패:', e);
    poeAPI.setItems([]); poeAPI.enable(false);
  }
}

/* 6) 화물타입(DIPLOMAT/NON-DIPLOMAT) — index (70) 기본 분기 그대로 */

function setCargoTypeComboItems(items){
  const api = getComboAPI('cargoTypeCombo');   // ← 커스텀 콤보(ID: cargoTypeCombo) 기준
  api.setItems(items || []);
  api.setValue?.('');                          // 이전 선택값 제거 (자동선택 금지)
  api.enable(!!(items && items.length));       // 목록이 있을 때만 활성화
}

// 파트너 기준 화물타입 로드: by-partner (region 포함) → (폴백) /api/costs 집계
async function loadCargoTypes_forPartner(){
  const country = (window.countryCombo?.getValue?.() || document.querySelector('#countryCombo input')?.value || '').trim();
  const region  = (window.regionCombo ?.getValue?.() || document.querySelector('#regionCombo  input')?.value || '').trim();
  const partner = (window.companyCombo?.getValue?.() || document.querySelector('#companyCombo input')?.value || '').trim();

  if (!country || !partner){
    setCargoTypeComboItems([]); // 비우고 비활성화
    return;
  }

  const fetchJson = async (url) => {
    const res = await fetch(url, { cache:'no-store' });
    if (!res.ok) return null;
    return res.json();
  };

  let list = [];

  try{
    // 1) ✅ 백엔드에 구현된 by-partner 라우트 먼저 시도
    //    (/api/cargo-types/by-partner?country=&partner=&region=)
    let url = `${BASE}/api/cargo-types/by-partner?country=${encodeURIComponent(country)}&company=${encodeURIComponent(partner)}${region ? `&region=${encodeURIComponent(region)}` : ''}&mode=options`;
    let j = await fetchJson(url);
    if (j) list = (j.types || j.options || []).filter(Boolean);

    // 2) 폴백: /api/costs 에서 해당 파트너 행들만 조회하여 "화물타입"을 집계
    if (!list.length){
      url = `${BASE}/api/costs/${encodeURIComponent(country)}?company=${encodeURIComponent(partner)}${region ? `&region=${encodeURIComponent(region)}` : ''}&mode=data`;
      j = await fetchJson(url);
      const rows = j?.rows || j?.data || j?.items || j?.results || [];
      const bucket = new Set();
      for (const row of rows){
        const ms = row?.properties?.["화물타입"]?.multi_select || [];
        ms.forEach(it => it?.name && bucket.add(it.name));
        if (Array.isArray(row?.roles))      row.roles.forEach(x => x && bucket.add(String(x)));
        if (Array.isArray(row?.cargoTypes)) row.cargoTypes.forEach(x => x && bucket.add(String(x)));
        if (row?.cargoType)                 bucket.add(String(row.cargoType));
      }
      list = [...bucket].sort((a,b)=> a.localeCompare(b,'ko'));
    }

    setCargoTypeComboItems(list); // 목록이 1개 이상이면 자동 enable(true)
  }catch(e){
    console.warn('loadCargoTypes_forPartner error:', e);
    setCargoTypeComboItems([]);
  }
}




/* 7) 이벤트 연결 */
function wireEvents(){
  const ccEl   = document.querySelector('#countryCombo input') || document.querySelector('#countryCombo');
  const rcEl   = document.querySelector('#regionCombo input')  || document.querySelector('#regionCombo');
  const compEl = document.querySelector('#companyCombo input') || document.querySelector('#companyCombo');

  // 국가 변경 → 지역 로드 + 화물타입 리셋
  ccEl?.addEventListener('change', async ()=>{
    await loadRegions();
    setCargoTypeComboItems([]);   // ← 리셋 (파트너 선택 전이므로 비활성)
    // setCargoTypeSelectItems([]);
  });

  // 지역 변경 → 업체 로드 + 화물타입 리셋
  rcEl?.addEventListener('change', async ()=>{
    await loadCompanies();
    setCargoTypeComboItems([]);   // ← 리셋
    // setCargoTypeSelectItems([]);
    const region = (window.regionCombo?.getValue?.() || document.querySelector('#regionCombo input')?.value || '').trim();
    if (region) zoomToRegion(region, { fallbackZoom: 10 });
  });

  // ✅ 업체(파트너) 변경 → 화물타입 로드 (핵심)
  compEl?.addEventListener('change', async ()=>{
    await loadPOEs();                 // 기존 흐름 유지
    loadCargoTypes_forPartner();      // ← 여기서 실제 옵션 채움
  });
}


/* 8) 초기화 */
window.addEventListener('DOMContentLoaded', async ()=>{
  setTypeComboFixed();   // 20FT/40HC/CONSOLE (자동선택 없음)
  setCBMRange();         // 1~60 + placeholder 유지

  await loadCountries();
  wireEvents();

  // ✅ 초기에도 파트너 값이 들어있으면 한번 로드
  loadCargoTypes_forPartner();
});



/* 지역명으로 지도 포커싱 */
function zoomToRegion(regionName, {fallbackZoom=10} = {}){
  if (!map || !regionName) return;

  const name = String(regionName).trim();
  if (!name) return;

  // 1) 현재 국가 마커들 목록(__countryPoints)에서 먼저 찾기
  let hit = __countryPoints?.find(p => {
    const a = (p.name || '').replace(/,/g,'').trim().toLowerCase();
    const b = name.replace(/,/g,'').trim().toLowerCase();
    return a === b;
  });

  // 2) 못 찾으면 부분일치 시도
  if (!hit && Array.isArray(__countryPoints)) {
    const b = name.replace(/,/g,'').trim().toLowerCase();
    hit = __countryPoints.find(p => (p.name||'').toLowerCase().includes(b));
  }

  // 3) 그래도 못 찾으면 (현재 선택 국가의 map.json 원본)에서 탐색
  if (!hit) {
    const country = (window.countryCombo?.getValue?.() || document.querySelector('#countryCombo input')?.value || '').trim();
    const key = normalizeCountryKey(country);
    const pts = mapData?.[key] || [];
    const b = name.replace(/,/g,'').trim().toLowerCase();
    hit = pts.find(p => (p.name||'').replace(/,/g,'').trim().toLowerCase() === b)
       || pts.find(p => (p.name||'').toLowerCase().includes(b));
  }

  if (hit && Number.isFinite(hit.lat) && Number.isFinite(hit.lng)) {
    map.setView([hit.lat, hit.lng], fallbackZoom, { animate:true });
    // 선택된 마커가 이미 있으면 살짝 강조(선택 사항)
    try { hit.marker?.openPopup?.(); } catch(_){}
  } else {
    // 못 찾는 경우는 거의 없겠지만, 로깅만 남김
    console.warn('zoomToRegion: 지역을 찾지 못했습니다 →', regionName);
  }
}
    
document.getElementById('btnFetch')?.addEventListener('click', async () => {
  try{
    // 선택된 값 읽기
    const country = window.countryCombo?.getValue?.() || document.querySelector('#countryCombo input')?.value?.trim();
    const region  = window.regionCombo?.getValue?.()  || document.querySelector('#regionCombo input')?.value?.trim();
    const company = window.companyCombo?.getValue?.() || document.querySelector('#companyCombo input')?.value?.trim();
    const type    = window.typeCombo?.getValue?.()    || document.querySelector('#typeCombo input')?.value?.trim() || '20FT';
    const cbmSel  = document.getElementById('cbmSelect');
    const cbm     = cbmSel?.value ? Number(cbmSel.value) : undefined;
    const cargo   = document.getElementById('cargoTypeSelect')?.value?.trim();

    if (!country){ alert('국가를 선택하세요.'); return; }
    if (!company){ alert('업체를 선택하세요.'); return; }

    const roles = cargo ? [cargo.toUpperCase()] : [];
    const params = new URLSearchParams();
    params.set('type', type);
    params.set('company', company);
    if (region) params.set('region', region);
    if (roles.length) params.set('roles', roles.join(','));
    if (!isNaN(cbm)) params.set('cbm', String(cbm));

    const url = `${BASE}/api/costs/${encodeURIComponent(country)}?${params.toString()}`;
    const res = await fetch(url);
    const j   = await res.json();

    __numberFormats = j?.numberFormats || {};

    renderTable(j, type, Boolean(region));
    document.getElementById('resultSection')?.classList.add('show');    
  }catch(e){
    console.error(e);
    alert('조회 중 오류가 발생했습니다.');
  }
});

    
// Notion 숫자 포맷 메타 저장용 (백엔드 /api/costs 응답에 포함됨)
let __numberFormats = {};

function esc(s){ 
  return String(s==null?'':s).replace(/[&<>"']/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
}

function formatAmount(n, columnKey){
  if (n==null || n==='' || isNaN(Number(n))) return '';
  const v = Number(n);
  const fmt = __numberFormats?.[columnKey] || '';
  if (/dollar|usd/i.test(fmt)) return '$' + v.toLocaleString('en-US');
  if (/won|krw/i.test(fmt))    return '₩' + v.toLocaleString('ko-KR');
  if (/euro|eur/i.test(fmt))   return '€' + v.toLocaleString('de-DE');
  return v.toLocaleString();
}

function renderTable(data, type, isRegionFiltered){
  const wrap = document.getElementById('tableWrap');
  if (!wrap){ return; }

  const rows = Array.isArray(data?.rows) ? data.rows : [];
  if (!rows.length){
    wrap.innerHTML = '<div class="muted">표시할 데이터가 없습니다.</div>';
    return;
  }

  // 헤더 구성
  let thead = '<tr><th>항목</th>';
  if (!isRegionFiltered) thead += '<th>지역</th>';
  thead += `<th class="type-col">${esc(type)}</th><th>비고</th></tr>`;

  // 바디 구성
  let tbody = '';
  for (const r of rows){
    const amt = r?.[type];
    const amtText = formatAmount(amt, type) || '-';
    tbody += '<tr>';
    tbody += `<td>${esc(r.item || '')}</td>`;
    if (!isRegionFiltered) tbody += `<td>${esc(r.region || '')}</td>`;
    tbody += `<td class="amt">${amtText}</td>`;
    tbody += `<td>${r.extra || ''}</td>`;
    tbody += '</tr>';
  }

  wrap.innerHTML = `
    <table class="result-table">
      <thead>${thead}</thead>
      <tbody>${tbody}</tbody>
    </table>
  `;
}

    
</script>

</body>
</html>
