<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ë„ì°©ì§€ ë¹„ìš© ê³„ì‚°</title>

  <!-- í°íŠ¸ (ê¸°ì¡´ê³¼ ë™ì¼ ê³„ì—´) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- ë©”ì¸ ìŠ¤íƒ€ì¼ -->
  <link rel="stylesheet" href="./app.css" />
</head>
<body>

  <!-- ìƒë‹¨ í—¤ë” (ê°„ë‹¨ ë²„ì „) -->
<header class="site-header">
  <div class="container header-inner">
    <div class="logo">
      <img src="https://arrrbang.github.io/pumex/image/pumexlogonew.png" alt="PUMEX Logo">
    </div>
      <div class="site-title">ë„ì°©ì§€ ë¹„ìš© ê³„ì‚°</div>
  </div>
</header>

  <!-- ë©”ì¸ ì•± ì…¸ -->
  <main class="app-shell">
    <div class="app-main container">

      <!-- ì™¼ìª½: ì§€ë„ ì˜ì—­ -->
      <section class="left-pane">
        <!-- Leaflet ì§€ë„ìš© ì»¨í…Œì´ë„ˆ (JS ë¶™ì¼ ë•Œ ê·¸ëŒ€ë¡œ ì‚¬ìš©) -->
        <div id="mpkMap" class="map-canvas" aria-label="ì§€ë„ ì˜ì—­">
          <div class="map-placeholder">ì§€ë„(Leaflet)ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>
      </section>

      <!-- ì˜¤ë¥¸ìª½: í¼(ë“œë¡­ë‹¤ìš´/ì½¤ë³´ë°•ìŠ¤) -->
      <section class="right-pane">

        <!-- 1ì°¨: êµ­ê°€/ì§€ì—­ -->
        <div class="dropdown-container">
          <label class="dropdown-label" for="countryCombo">[1] êµ­ê°€/ì§€ì—­ ì„ íƒ</label>
        
          <div class="combo-line">
            <div class="combo" id="countryCombo">
              <input type="text" placeholder="êµ­ê°€ ì„ íƒ" autocomplete="off">
              <div class="list"></div>
            </div>
          </div>
        
          <div class="combo-line">
            <div class="combo" id="regionCombo">
              <input type="text" placeholder="ë°°ì†¡ ì§€ì—­ ì„ íƒ" autocomplete="off" disabled>
              <div class="list"></div>
            </div>
          </div>
        </div>

        <!-- 2ì°¨ ì„ íƒ: ì—…ì²´/POE -->
        <div class="dropdown-container">
          <label class="dropdown-label" for="companyCombo">[2] íŒŒíŠ¸ë„ˆ/POE/í™”ë¬¼íƒ€ì… ì„ íƒ</label>
        
          <div class="combo-line">
            <div class="combo" id="companyCombo">
              <input type="text" placeholder="íŒŒíŠ¸ë„ˆ ì„ íƒ" autocomplete="off" disabled>
              <div class="list"></div>
            </div>
          </div>
        
          <div class="combo-line">
            <div class="combo" id="poeCombo">
              <input type="text" placeholder="POE ì„ íƒ" autocomplete="off" disabled>
              <div class="list"></div>
            </div>
          </div>
          
          <div class="combo-line">
            <div class="combo" id="cargoTypeCombo">
              <input type="text" placeholder="í™”ë¬¼ íƒ€ì… ì„ íƒ" autocomplete="off" disabled />
              <div class="list"></div>
            </div>
          </div>
          
        </div>
    
        <!-- 3ì°¨ ì„ íƒ -->
        <div class="dropdown-container">
          <label class="dropdown-label" for="cargoTypeSelect">[3] ì»¨í…Œì´ë„ˆ íƒ€ì…/CBM ì„ íƒ</label>
        
          <div class="combo-line">
            <div class="combo" id="typeCombo">
              <input type="text" placeholder="20FT / 40HC / CONSOLE" autocomplete="off" disabled>
              <div class="list"></div>
            </div>
          </div>
        
          <div class="combo-line">
            <select id="cbmSelect" class="dropdown-select" required>
              <option value="" disabled selected hidden>CBM ì„ íƒ</option>
            </select>
          </div>
        </div>



        <!-- ì¡°íšŒ ë²„íŠ¼ -->
      <div class="action-row center show revealed">
        <button id="btnFetch" class="primary-btn" type="button">ì¡°íšŒ</button>
      </div>
      </section>
    </div>
  </main>
  
  <section id="collapsedPanel" hidden></section>
  <!-- âœ… ì ‘í˜ ìƒíƒœì—ì„œ ë³´ì—¬ì¤„ ìš”ì•½ ë°” (ì²˜ìŒì—” ìˆ¨ê¹€) -->
    <section id="collapsedSummary" class="collapsed-summary" hidden>
      <div class="container">
        <div class="chips">
          <button class="chip" data-key="country">
            <span class="k">êµ­ê°€</span><span class="v" id="sumCountry">-</span>
          </button>
          <button class="chip" data-key="region">
            <span class="k">ì§€ì—­</span><span class="v" id="sumRegion">-</span>
          </button>
          <button class="chip" data-key="cbm">
            <span class="k">CBM/ì»¨í…Œì´ë„ˆ</span><span class="v" id="sumCbmType">-</span>
          </button>
          <button class="chip" data-key="company">
            <span class="k">íŒŒíŠ¸ë„ˆ</span><span class="v" id="sumCompany">-</span>
          </button>
        </div>
      </div>
    </section>
      <section id="resultSection" class="result-section" hidden>
        <div class="result-container container">
          <div id="tableWrap" class="table-wrap"></div>
        </div>
      </section>
  </section>
  
  <!-- âœ… ê²°ê³¼ í‘œ (í•­ìƒ app-shell ë°”ê¹¥) -->

  
<script>
/* ============================================================================
   0) ì „ì—­ ìƒìˆ˜ / ê³µí†µ ìœ í‹¸
   - CDN ê²½ë¡œ, API BASE, ì´ìŠ¤ì¼€ì´í”„/í† ìŠ¤íŠ¸/ê±°ë¦¬ê³„ì‚° ë“±
   ========================================================================== */
const SHELL_STATES = Object.freeze({
  OPEN: 'OPEN',
  COLLAPSING: 'COLLAPSING',
  COLLAPSED: 'COLLAPSED',
  EXPANDING: 'EXPANDING',
});

let __shellState = SHELL_STATES.OPEN;     // ì‹œì‘ì€ ì—´ë¦° ìƒíƒœ
let __summaryClickLocked = false;         // ìš”ì•½ë°” í´ë¦­ ì ê¸ˆ
let __justCollapsedAt = 0;                // ë§ˆì§€ë§‰ ì ‘í˜ ì‹œê°(ms)
let __allowExpand = false;
let __defaultCurrency = '';   // â† ê¸°ë³¸ í†µí™”(í´ë°±) ì €ì¥
  
const BASE = 'https://notion-api-hub.vercel.app';

const LCSS = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.css";
const LJS  = "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js";
const GCSS = "https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css";
const GJS  = "https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js";

// âœ… íŠ¹ì • ì½¤ë³´ ë£¨íŠ¸(#id)ì— ë¡œë”© ìŠ¤í”¼ë„ˆ on/off
function setComboLoading(id, on){
  const root = document.getElementById(id);
  if (!root) return;
  root.classList.toggle('is-loading', !!on);
}

// (ì˜µì…˜) ê¸°ë³¸ <select>ì— ë¡œë”© ìŠ¤í”¼ë„ˆ í‘œì‹œí•˜ê³  ì‹¶ì„ ë•Œ ì‚¬ìš©
function setSelectLoading(selectId, on){
  const sel = document.getElementById(selectId);
  if (!sel) return;
  sel.classList.toggle('is-loading', !!on);
  // ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ìŠ¤í”¼ë„ˆ ì œê±°
  const next = sel.nextElementSibling;
  if (next && next.classList.contains('select-spinner')) next.remove();
  // onì´ë©´ ì¸ì ‘ ìš”ì†Œë¡œ ìŠ¤í”¼ë„ˆ ì—˜ë¦¬ë¨¼íŠ¸ ì¶”ê°€
  if (on){
    const sp = document.createElement('span');
    sp.className = 'select-spinner';
    sel.insertAdjacentElement('afterend', sp);
  }
}

function loadCssOnce(href){
  return new Promise((res, rej)=>{
    if (document.querySelector(`link[href="${href}"]`)) return res();
    const l = document.createElement('link');
    l.rel='stylesheet'; l.href=href; l.onload=res; l.onerror=rej; document.head.appendChild(l);
  });
}
function loadJsOnce(src){
  return new Promise((res, rej)=>{
    if (document.querySelector(`script[src="${src}"]`)) return res();
    const s = document.createElement('script');
    s.src=src; s.onload=res; s.onerror=rej; document.head.appendChild(s);
  });
}

function esc(s){
  return String(s==null?'':s).replace(/[&<>"']/g, m => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
}
function toast(msg){
  try{
    const d=document.createElement('div');
    d.textContent=msg;
    d.style.cssText="position:fixed;left:50%;top:32vh;transform:translate(-50%,-50%);background:rgba(0,0,0,.82);color:#fff;padding:10px 14px;border-radius:10px;z-index:9999;font-size:14px;box-shadow:0 10px 24px rgba(0,0,0,.35)";
    document.body.appendChild(d);
    setTimeout(()=>d.remove(),1500);
  }catch(_){}
}
function haversineKm(aLat,aLng,bLat,bLng){
  const R=6371, dLat=(bLat-aLat)*Math.PI/180, dLng=(bLng-aLng)*Math.PI/180;
  const A=Math.sin(dLat/2)**2+Math.cos(aLat*Math.PI/180)*Math.cos(bLat*Math.PI/180)*Math.sin(dLng/2)**2;
  return 2*R*Math.asin(Math.sqrt(A));
}
function findNearest(lat,lng,pts){
  if(!pts?.length) return null;
  let best=null,bd=Infinity;
  for(const p of pts){
    const d=haversineKm(lat,lng,p.lat,p.lng);
    if(d<bd){best=p;bd=d;}
  }
  return {point:best,distanceKm:bd};
}

  
/* ============================================================================
   1) ì»¤ìŠ¤í…€ ì½¤ë³´/ì…€ë ‰íŠ¸ ì ‘ê·¼ì
   - getComboAPI: í˜ì´ì§€ì— ì´ë¯¸ ì»¤ìŠ¤í…€ ì½¤ë³´ê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©
   - getValue_soft: ì½¤ë³´/ì¸í’‹/ì…€ë ‰íŠ¸ í†µí•© ì½ê¸°
   - setSelectOptions: selectìš© ì˜µì…˜ ì„¸íŒ…(í•„ìš” ì‹œ)
   ========================================================================== */
function getComboAPI(id){
  const root = document.getElementById(id);
  const input = root?.querySelector('input');
  const list  = root?.querySelector('.list');

  // ê¸°ì¡´ ì»¤ìŠ¤í…€ ì½¤ë³´ ê°ì²´ê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©
  if (window[id] && typeof window[id].setItems === 'function') {
    return {
      setItems: (arr)=>window[id].setItems(arr),
      setValue: (v)=>window[id].setValue?.(v),
      getValue: ()=>window[id].getValue?.(),
      enable:   (on)=>{ if (input) input.disabled = !on; }
    };
  }

  // í´ë°±: ê°„ë‹¨ ì½¤ë³´(ì´ í˜ì´ì§€ ë‹¨ë…ìœ¼ë¡œë„ ë™ì‘í•˜ë„ë¡)
  return {
    setItems: (arr)=>{
      if (!list || !input) return;
      list.innerHTML = (arr||[]).map(v=>`<div class="item" data-v="${v}">${v}</div>`).join('');
      list.querySelectorAll('.item').forEach(it=>{
        it.addEventListener('click', ()=>{
          input.value = it.getAttribute('data-v') || '';
          list.style.display = 'none';
          input.dispatchEvent(new Event('change',{bubbles:true}));
        });
      });
      input.addEventListener('focus', ()=>{ list.style.display='block'; });
      input.addEventListener('input', ()=>{ list.style.display='block'; });
      document.addEventListener('pointerdown',(e)=>{ if (!root.contains(e.target)) list.style.display='none'; });
    },
    setValue: (v)=>{ if(input){ input.value = v; input.dispatchEvent(new Event('change',{bubbles:true})); } },
    getValue: ()=> input?.value?.trim() || '',
    enable:   (on)=>{ if (input) input.disabled = !on; }
  };
}
function setSelectOptions(selectId, values){
  const sel = document.getElementById(selectId);
  if (!sel) return;
  sel.innerHTML = [
    `<option value="" disabled selected hidden>í™”ë¬¼ íƒ€ì… ì„ íƒ</option>`,
    ...values.map(v=>`<option value="${v}">${v}</option>`)
  ].join('');
}
function getValue_soft(id){
  const combo = getComboAPI(id);
  const val1 = combo.getValue?.();
  if (val1) return val1;
  const sel = document.getElementById(id);
  if (sel && 'value' in sel) return sel.value;
  const inp = document.querySelector(`#${id} input`);
  return inp?.value?.trim() || '';
}

/* ============================================================================
   2) ì¢Œì¸¡ Leaflet ì§€ë„ (ìƒì‹œ ë…¸ì¶œ)
   - initAlwaysOnMap: Leaflet/Geocoder ë¡œë“œ + ì§€ë„ ì´ˆê¸°í™”
   - setMapCountry: map.jsonì˜ êµ­ê°€ í¬ì¸íŠ¸ ë§ˆì»¤ ì„¸íŒ…
   - zoomToRegion: ì§€ì—­ëª…ìœ¼ë¡œ ì§€ë„ ì¤Œ(ì •í™•/ë¶€ë¶„ ì¼ì¹˜)
   ========================================================================== */
let map, markerLayer, geocoder, mapInited=false, mapData=null, tmpSearch=null;
let __countryPoints = [];
const pinReg    = '#2563eb';
const pinSearch = '#ef4444';

function makeSvgPinIcon(color){
  const svg = `<svg class="pin-svg" viewBox="0 0 24 24" aria-hidden="true"><path fill="${color}" d="M12 2C8.134 2 5 5.134 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.866-3.134-7-7-7zm0 9.5a2.5 2.5 0 1 1 0-5a2.5 2.5 0 0 1 0 5z"/></svg>`;
  return L.divIcon({ className:"", html:`<div class="pin-wrap">${svg}</div>`, iconSize:[26,26], iconAnchor:[13,26] });
}
function normalizeCountryKey(raw){ return String(raw||'').trim(); }

async function initAlwaysOnMap(){
  if (mapInited) return;
  await loadCssOnce(LCSS); await loadJsOnce(LJS);
  await loadCssOnce(GCSS); await loadJsOnce(GJS);

  const worldBounds = L.latLngBounds([[-85,-180],[85,180]]);
  map = L.map('mpkMap', { center:[20,0], zoom:2, worldCopyJump:false, maxBounds:worldBounds, maxBoundsViscosity:1.0 });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'&copy; OSM', noWrap:true, bounds:worldBounds }).addTo(map);
  markerLayer = L.layerGroup().addTo(map);

  // ì§€ì˜¤ì½”ë”
  geocoder = L.Control.geocoder({ defaultMarkGeocode:false })
    .on('markgeocode', (e)=>{
      const c = e.geocode.center;
      if (tmpSearch) { map.removeLayer(tmpSearch); tmpSearch=null; }
      tmpSearch = L.marker(c, {icon: makeSvgPinIcon(pinSearch)}).addTo(map);
      map.setView(c, 9);

      // ìµœê·¼ì ‘ ë“±ë¡ ì§€ì—­ ìë™ ì„ íƒ
      const hit = findNearest(c.lat, c.lng, __countryPoints);
      if (hit?.point){
        setRegion(hit.point.name);
        toast(`ê°€ì¥ ê°€ê¹Œìš´ ë“±ë¡ ì§€ì—­: ${hit.point.name} (~${hit.distanceKm.toFixed(1)}km)`);
      }
    }).addTo(map);

  // êµ­ê°€ë³„ í¬ì¸íŠ¸ ë°ì´í„° ë¡œë“œ
  try{
    const r = await fetch('./map.json', {cache:'no-store'});
    mapData = await r.json();
  }catch(e){
    console.warn('map.json ë¡œë“œ ì‹¤íŒ¨:', e);
    mapData = {};
  }

  mapInited = true;
  setTimeout(()=> map.invalidateSize(), 100);
}
function setMapCountry(country){
  if (!mapInited) return;
  markerLayer.clearLayers();
  __countryPoints = [];
  if (!mapData) return;
  const key = normalizeCountryKey(country);
  const pts = mapData[key];
  if (!pts || !pts.length){ toast(`í•´ë‹¹ êµ­ê°€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤: ${country}`); return; }

  const bounds = [];
  pts.forEach(p=>{
    const m = L.marker([p.lat, p.lng], { icon: makeSvgPinIcon(pinReg) }).addTo(markerLayer);
    m.on('click', ()=>{ setRegion(p.name); toast(`ì§€ì—­ ì„ íƒ: ${p.name}`); });
    __countryPoints.push({ ...p, marker:m });
    bounds.push([p.lat, p.lng]);
  });
  if (bounds.length) map.fitBounds(bounds, { padding:[20,20] });
}
function zoomToRegion(regionName, {fallbackZoom=10} = {}){
  if (!map || !regionName) return;
  const name = String(regionName).trim();
  if (!name) return;

  // 1) í˜„ì¬ êµ­ê°€ ë§ˆì»¤ ëª©ë¡ì—ì„œ ì •í™• ì¼ì¹˜
  let hit = __countryPoints?.find(p => {
    const a = (p.name || '').replace(/,/g,'').trim().toLowerCase();
    const b = name.replace(/,/g,'').trim().toLowerCase();
    return a === b;
  });
  // 2) ë¶€ë¶„ ì¼ì¹˜
  if (!hit && Array.isArray(__countryPoints)) {
    const b = name.replace(/,/g,'').trim().toLowerCase();
    hit = __countryPoints.find(p => (p.name||'').toLowerCase().includes(b));
  }
  // 3) map.json ì›ë³¸ì—ì„œ íƒìƒ‰
  if (!hit) {
    const country = getValue_soft('countryCombo');
    const key = normalizeCountryKey(country);
    const pts = mapData?.[key] || [];
    const b = name.replace(/,/g,'').trim().toLowerCase();
    hit = pts.find(p => (p.name||'').replace(/,/g,'').trim().toLowerCase() === b)
        || pts.find(p => (p.name||'').toLowerCase().includes(b));
  }
  if (hit && Number.isFinite(hit.lat) && Number.isFinite(hit.lng)) {
    map.setView([hit.lat, hit.lng], fallbackZoom, { animate:true });
    try { hit.marker?.openPopup?.(); } catch(_){}
  } else {
    console.warn('zoomToRegion: ì§€ì—­ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤ â†’', regionName);
  }
}

/* êµ­ê°€/ì§€ì—­ ê°’ ì ‘ê·¼ì + ì§€ì—­ ì„¸í„° (ì§€ë„ ì¤Œ í¬í•¨) */
function getCountry(){ const el = document.querySelector('#countryCombo input'); return el?.value?.trim() || ''; }
function getRegion(){  const el = document.querySelector('#regionCombo input');  return el?.value?.trim() || ''; }
function setRegion(v){
  const combo = document.querySelector('#regionCombo input');
  if (combo){
    combo.value = v;
    combo.dispatchEvent(new Event('input',{bubbles:true}));
    combo.dispatchEvent(new Event('change',{bubbles:true}));
  }
  zoomToRegion(v, { fallbackZoom: 10 });
}

/* ============================================================================
   3) ê³ ì • ì˜µì…˜ / ì´ˆê¸° ë°ì´í„° ë¡œë”©
   - ì»¨í…Œì´ë„ˆ íƒ€ì…: 20FT/40HC/CONSOLE
   - CBM: 1~60
   - êµ­ê°€ ëª©ë¡
   ========================================================================== */
function setTypeComboFixed(){
  const typeAPI = getComboAPI('typeCombo');
  typeAPI.setItems(['20FT','40HC','CONSOLE']);
  typeAPI.enable(true); // ê¸°ë³¸ê°’ ìë™ ì„ íƒ ì—†ìŒ
}
function setCBMRange(){
  const values = Array.from({length:60}, (_,i)=> i + 1);
  const sel = document.getElementById('cbmSelect');
  if (sel){
    sel.innerHTML = [
      `<option value="" disabled selected hidden>CBM ì„ íƒ</option>`,
      ...values.map(v => `<option value="${v}">${v}</option>`)
    ].join('');
  }
}
async function loadCountries(){
  const countryAPI = getComboAPI('countryCombo');
  setComboLoading('countryCombo', true); // ğŸ”„ on
  try{
    const r = await fetch(`${BASE}/api/debug/config`, {cache:'no-store'});
    const j = await r.json();
    const countries = j.countries || Object.keys(j.dbStructure||{}) || [];
    countryAPI.setItems(countries);
    countryAPI.enable(true);
  }catch(e){
    countryAPI.setItems([]); countryAPI.enable(true);
    console.warn('loadCountries ì‹¤íŒ¨:', e);
  }finally{
    setComboLoading('countryCombo', false); // ğŸ”„ off
  }
}


/* ============================================================================
   4) Notion ì—°ë™: ì§€ì—­/ì—…ì²´/POE/í™”ë¬¼íƒ€ì… ë¡œë”
   - ì§€ì—­: /api/regions/:country
   - ì—…ì²´: /api/companies/by-region?country=&region=&mode=options
   -  POE: /api/poe/by-company (í´ë°±: /api/poe/by-region)
   - í™”ë¬¼íƒ€ì…: /api/cargo-types/by-partner?country=&company=&region= (í´ë°±: /api/costs ì§‘ê³„)
   ========================================================================== */
async function loadRegions(){
  const country = getValue_soft('countryCombo');
  const regionAPI = getComboAPI('regionCombo');
  const companyAPI= getComboAPI('companyCombo');
  const poeAPI    = getComboAPI('poeCombo');

  regionAPI.setItems([]); regionAPI.enable(false);
  companyAPI.setItems([]); companyAPI.enable(false);
  poeAPI.setItems([]);     poeAPI.enable(false);
  if(!country) return;

  setComboLoading('regionCombo', true); // ğŸ”„ on
  try{
    const r = await fetch(`${BASE}/api/regions/${encodeURIComponent(country)}`, {cache:'no-store'});
    const j = await r.json();
    const regions = j.regions || [];
    regionAPI.setItems(regions);
    regionAPI.enable(true);
  }catch(e){
    console.warn('loadRegions ì‹¤íŒ¨:', e);
    regionAPI.setItems([]); regionAPI.enable(false);
  }finally{
    setComboLoading('regionCombo', false); // ğŸ”„ off
  }
}

async function loadCompanies(){
  const country   = getValue_soft('countryCombo');
  const region    = getValue_soft('regionCombo');
  const companyAPI= getComboAPI('companyCombo');
  const poeAPI    = getComboAPI('poeCombo');

  companyAPI.setItems([]); companyAPI.enable(false);
  poeAPI.setItems([]);     poeAPI.enable(false);
  if(!country || !region) return;

  setComboLoading('companyCombo', true); // ğŸ”„ on
  try{
    const url = `${BASE}/api/companies/by-region?country=${encodeURIComponent(country)}&region=${encodeURIComponent(region)}&mode=options`;
    const r = await fetch(url, {cache:'no-store'});
    const j = await r.json();
    const companies = (j.companies || []).filter(Boolean);
    companyAPI.setItems(companies);
    companyAPI.enable(companies.length>0);
  }catch(e){
    console.warn('loadCompanies ì‹¤íŒ¨:', e);
    companyAPI.setItems([]); companyAPI.enable(false);
  }finally{
    setComboLoading('companyCombo', false); // ğŸ”„ off
  }
}

async function loadPOEs(){
  const country   = getValue_soft('countryCombo');
  const region    = getValue_soft('regionCombo');
  const company   = getValue_soft('companyCombo');
  const poeAPI    = getComboAPI('poeCombo');

  // ì„ íƒê°’ë§Œ ì§€ìš°ê³ (ì›í•˜ì‹œëŠ” í˜„ì¬ ì •ì±…) ë¹„í™œì„±í™”ëŠ” í•˜ì§€ ì•ŠìŒ
  poeAPI.setValue?.('');
  if(!country || !region || !company) return;

  setComboLoading('poeCombo', true); // ğŸ”„ on
  try{
    let url = `${BASE}/api/poe/by-company?country=${encodeURIComponent(country)}&region=${encodeURIComponent(region)}&company=${encodeURIComponent(company)}&mode=options`;
    let res = await fetch(url, {cache:'no-store'});
    if (!res.ok) throw new Error('by-company not ok');
    let j = await res.json();
    let poes = (j.poes || j.POE || j.options || []).filter(Boolean);

    if (!poes.length){
      url = `${BASE}/api/poe/by-region?country=${encodeURIComponent(country)}&region=${encodeURIComponent(region)}&mode=options`;
      res = await fetch(url, {cache:'no-store'});
      j = await res.json();
      poes = (j.poes || j.POE || j.options || []).filter(Boolean);
    }

    poeAPI.setItems(poes);
    poeAPI.enable(poes.length>0);
  }catch(e){
    console.warn('loadPOEs ì‹¤íŒ¨:', e);
    poeAPI.setItems([]); // ìœ ì§€ ì›í•˜ë©´ ì‚­ì œ ê°€ëŠ¥
    // poeAPI.enable(false); // ë¹„í™œì„±í™”ë¥¼ ì›ì¹˜ ì•Šìœ¼ë©´ ì£¼ì„ ìœ ì§€
  }finally{
    setComboLoading('poeCombo', false); // ğŸ”„ off
  }
}


/* í™”ë¬¼íƒ€ì…: íŒŒíŠ¸ë„ˆ ê¸°ì¤€ + í´ë°± ì§‘ê³„ */
function setCargoTypeComboItems(items){
  const api = getComboAPI('cargoTypeCombo');
  api.setItems(items || []);
  api.setValue?.('');                  // ì´ì „ ì„ íƒ ì œê±°(ìë™ì„ íƒ ê¸ˆì§€)
  api.enable(!!(items && items.length));
}
async function loadCargoTypes_forPartner(){
  const country = getValue_soft('countryCombo');
  const region  = getValue_soft('regionCombo');
  const partner = getValue_soft('companyCombo');

  // ì„ íƒê°’ë§Œ ì´ˆê¸°í™”, ì•„ì´í…œ/í™œì„± ìƒíƒœëŠ” ìœ ì§€
  const cargoAPI = getComboAPI('cargoTypeCombo');
  cargoAPI.setValue?.('');
  if (!country || !partner){ setCargoTypeComboItems([]); return; }

  const fetchJson = async (url) => {
    const res = await fetch(url, { cache:'no-store' });
    if (!res.ok) return null;
    return res.json();
  };

  setComboLoading('cargoTypeCombo', true); // ğŸ”„ on
  let list = [];
  try{
    let url = `${BASE}/api/cargo-types/by-partner?country=${encodeURIComponent(country)}&company=${encodeURIComponent(partner)}${region ? `&region=${encodeURIComponent(region)}` : ''}&mode=options`;
    let j = await fetchJson(url);
    if (j) list = (j.types || j.options || []).filter(Boolean);

    if (!list.length){
      url = `${BASE}/api/costs/${encodeURIComponent(country)}?company=${encodeURIComponent(partner)}${region ? `&region=${encodeURIComponent(region)}` : ''}&mode=data`;
      j = await fetchJson(url);
      const rows = j?.rows || j?.data || j?.items || j?.results || [];
      const bucket = new Set();
      for (const row of rows){
        const ms = row?.properties?.["í™”ë¬¼íƒ€ì…"]?.multi_select || [];
        ms.forEach(it => it?.name && bucket.add(it.name));
        if (Array.isArray(row?.roles))      row.roles.forEach(x => x && bucket.add(String(x)));
        if (Array.isArray(row?.cargoTypes)) row.cargoTypes.forEach(x => x && bucket.add(String(x)));
        if (row?.cargoType)                 bucket.add(String(row.cargoType));
      }
      list = [...bucket].sort((a,b)=> a.localeCompare(b,'ko'));
    }
    setCargoTypeComboItems(list); // ë‚´ë¶€ì—ì„œ enable ì²˜ë¦¬
  }catch(e){
    console.warn('loadCargoTypes_forPartner error:', e);
    setCargoTypeComboItems([]);
  }finally{
    setComboLoading('cargoTypeCombo', false); // ğŸ”„ off
  }
}


/* ============================================================================
   5) ê²°ê³¼ ë Œë”ë§ (í‘œ)
   - /api/costs ì‘ë‹µ ê¸°ë°˜ í‘œ ìƒì„±
   ========================================================================== */
let __numberFormats = {};  // Notion ìˆ«ì í¬ë§· ë©”íƒ€ (ë°±ì—”ë“œì—ì„œ ë‚´ë ¤ì¤Œ)

function getFmt(columnKey){
  const k = String(columnKey || '');
  // ê¸°ë³¸/ëŒ€ë¬¸ì/ì†Œë¬¸ì í‚¤ ëª¨ë‘ íƒìƒ‰
  return (__numberFormats?.[k])
      || (__numberFormats?.[k.toUpperCase()])
      || (__numberFormats?.[k.toLowerCase()])
      || '';
}

function formatAmount(n, columnKey){
  if (n==null || n==='' || isNaN(Number(n))) return '';
  const v = Number(n);
  const fmt = getFmt(columnKey);

  // 1) Notion í¬ë§· ìš°ì„ 
  if (/dollar|usd/i.test(fmt)) return '$' + v.toLocaleString('en-US');
  if (/won|krw/i.test(fmt))    return 'â‚©' + v.toLocaleString('ko-KR');
  if (/euro|eur/i.test(fmt))   return 'â‚¬' + v.toLocaleString('de-DE');

  // 2) í´ë°±: ê¸°ë³¸ í†µí™”(__defaultCurrency) ì‚¬ìš© (íŠ¹íˆ CONSOLE í•©ê³„ì— ëŒ€ë¹„)
  if (__defaultCurrency){
    const code = String(__defaultCurrency).toUpperCase();
    if (code === 'USD') return '$' + v.toLocaleString('en-US');
    if (code === 'KRW') return 'â‚©' + v.toLocaleString('ko-KR');
    if (code === 'EUR') return 'â‚¬' + v.toLocaleString('de-DE');
    // ì•Œ ìˆ˜ ì—†ëŠ” í†µí™”ì½”ë“œë©´ ì½”ë“œ í‘œì‹œ
    return v.toLocaleString() + ' ' + code;
  }

  // 3) ìµœì¢… í´ë°±: ê·¸ëƒ¥ ìˆ«ì í¬ë§·
  return v.toLocaleString();
}

function renderTable(data, type, isRegionFiltered){
  const wrap = document.getElementById('tableWrap');
  if (!wrap) return;

  const rows = Array.isArray(data?.rows) ? data.rows : [];
  if (!rows.length){
    wrap.innerHTML = '<div class="muted">í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
    return;
  }

  // í—¤ë”
  let thead = '<tr><th>í•­ëª©</th>';
  if (!isRegionFiltered) thead += '<th>ì§€ì—­</th>';
  thead += `<th class="type-col">${esc(type)}</th><th>ë¹„ê³ </th></tr>`;

  // ë°”ë””
  let tbody = '';
  for (const r of rows){
    const amt = r?.[type];
    const amtText = formatAmount(amt, type) || '-';
    tbody += '<tr>';
    tbody += `<td>${esc(r.item || '')}</td>`;
    if (!isRegionFiltered) tbody += `<td>${esc(r.region || '')}</td>`;
    tbody += `<td class="amt">${amtText}</td>`;
    tbody += `<td>${r.extra || ''}</td>`;
    tbody += '</tr>';
  }

  wrap.innerHTML = `
    <table class="result-table">
      <thead>${thead}</thead>
      <tbody>${tbody}</tbody>
    </table>
  `;
}

/* ============================================================================
   6) ì¡°íšŒ í›„ ì ‘í˜ ê¸°ëŠ¥ ë° ìš”ì•½ ìƒì„±
   ========================================================================== */

function collapseShell(){
  return new Promise((resolve)=>{
    const shell = document.querySelector('.app-shell');
    if (!shell) return resolve();

    if (__shellState === SHELL_STATES.COLLAPSED || __shellState === SHELL_STATES.COLLAPSING) {
      return resolve();
    }

    __shellState = SHELL_STATES.COLLAPSING;

    shell.classList.remove('is-collapsed','is-expanding');
    shell.style.display = 'block';
    const h = shell.scrollHeight;
    shell.style.maxHeight = h + 'px';

    requestAnimationFrame(()=>{
      shell.classList.add('is-collapsing');
      shell.style.maxHeight = '0px';
    });

    const onEnd = (e)=>{
      if (e.propertyName !== 'max-height') return;
      shell.removeEventListener('transitionend', onEnd);
      shell.classList.remove('is-collapsing');
      shell.classList.add('is-collapsed');
      shell.style.maxHeight = '';
     shell.style.display = 'none';   // âœ… ì ‘íŒ ì§í›„, ì™„ì „ ì ê¸ˆ
      __shellState = SHELL_STATES.COLLAPSED;
      __justCollapsedAt = performance.now();
      resolve();
    };
    shell.addEventListener('transitionend', onEnd);
  });
}

function expandShell(){
  return new Promise((resolve)=>{
    const shell = document.querySelector('.app-shell');
    if (!shell) return resolve();

  // âœ… ìš”ì•½ í´ë¦­ìœ¼ë¡œ í—ˆìš©ëœ ìƒí™© + ì‹¤ì œ ì ‘íŒ ìƒíƒœì—ì„œë§Œ ì—´ê¸°
     if (!__allowExpand || __shellState !== SHELL_STATES.COLLAPSED) {
      return resolve();
    }

    __shellState = SHELL_STATES.EXPANDING;

    shell.classList.remove('is-collapsed');
    shell.style.display = 'block';
    shell.style.maxHeight = '0px';

    requestAnimationFrame(()=>{
      shell.classList.add('is-expanding');
      const h = shell.scrollHeight;
      shell.style.maxHeight = h + 'px';
    });

    const onEnd = (e)=>{
      if (e.propertyName !== 'max-height') return;
      shell.removeEventListener('transitionend', onEnd);
      shell.classList.remove('is-expanding');
      shell.style.maxHeight = '';
      __shellState = SHELL_STATES.OPEN;
      __allowExpand = false; // âœ… í•œ ë²ˆ ì—´ë©´ ë‹¤ì‹œ ì ê¸ˆ
      resolve();
    };
    shell.addEventListener('transitionend', onEnd);
  });
}
  
async function fillAndShowSummary({country, region, cbm, type, company}){
  // ìš”ì•½ í…ìŠ¤íŠ¸ ì±„ìš°ê¸°
  document.getElementById('sumCountry').textContent = country || '-';
  document.getElementById('sumRegion').textContent  = region  || '(ì „ì²´)';
  const cbmTxt = type ? (cbm ? `${cbm} CBM / ${type}` : `${type}`) : (cbm ? `${cbm} CBM` : '-');
  document.getElementById('sumCbmType').textContent = cbmTxt;
  document.getElementById('sumCompany').textContent = company || '-';

  // 1) ë¨¼ì € ì™„ì „íˆ ì ‘í˜ì„ ë³´ì¥ (ëë‚  ë•Œê¹Œì§€ ëŒ€ê¸°)
  await collapseShell();

  // 2) ìš”ì•½ ë°” í‘œì‹œ (ê°™ì€ í´ë¦­ ì „íŒŒ ë°©ì§€)
  const bar = document.getElementById('collapsedSummary');
  if (bar){
    __summaryClickLocked = true;         // ì ê¹ ì ê¸ˆ
    requestAnimationFrame(()=>{
      bar.hidden = false;
      bar.classList.add('reveal');
      bar.style.pointerEvents = 'none';

      // ê²°ê³¼ë¡œ ìŠ¤í¬ë¡¤
      document.getElementById('resultSection')?.scrollIntoView({behavior:'smooth', block:'start'});

      setTimeout(()=>{
        bar.classList.remove('reveal');
        bar.style.pointerEvents = 'auto';
        __summaryClickLocked = false;    // ì ê¸ˆ í•´ì œ
      }, 320); // CSS ì• ë‹ˆë©”ì´ì…˜ê³¼ ë§ì¶¤
    });
  }
}



async function openAppShellFromSummary(){
  const bar = document.getElementById('collapsedSummary');
  if (bar) bar.hidden = true; // ìš”ì•½ ë¨¼ì € ìˆ¨ê¹€

  await expandShell();        // app-shell ë¶€ë“œëŸ½ê²Œ í¼ì¹˜ê¸°

  document.querySelector('.app-shell')?.scrollIntoView({behavior:'smooth', block:'start'});
}

  
/* ============================================================================
   7) ì´ë²¤íŠ¸ ë°”ì¸ë”©
   - êµ­ê°€ ë³€ê²½ â†’ ì§€ì—­ ë¡œë“œ + ì§€ë„ ê°±ì‹  + í™”ë¬¼íƒ€ì… ë¦¬ì…‹
   - ì§€ì—­ ë³€ê²½ â†’ ì—…ì²´ ë¡œë“œ + ì§€ë„ ì¤Œ + í™”ë¬¼íƒ€ì… ë¦¬ì…‹
   - ì—…ì²´ ë³€ê²½ â†’ POE ë¡œë“œ + í™”ë¬¼íƒ€ì… ë¡œë“œ(í•µì‹¬)
   - ì¡°íšŒ ë²„íŠ¼ â†’ /api/costs ì¡°íšŒ + í…Œì´ë¸” ë Œë” + ê²°ê³¼ ì„¹ì…˜ í‘œì‹œ
   ========================================================================== */
function wireEvents(){
  const ccEl   = document.querySelector('#countryCombo input') || document.getElementById('countryCombo');
  const rcEl   = document.querySelector('#regionCombo input')  || document.getElementById('regionCombo');
  const compEl = document.querySelector('#companyCombo input') || document.getElementById('companyCombo');

  // êµ­ê°€ ë³€ê²½
  ccEl?.addEventListener('change', async ()=>{
    await loadRegions();
    setCargoTypeComboItems([]); // íŒŒíŠ¸ë„ˆ ì„ íƒ ì „ â†’ ë¹„í™œì„±
    const c = getCountry();
    if (c) setMapCountry(c);
  });

    // ì§€ì—­ ë³€ê²½
    rcEl?.addEventListener('change', async ()=>{
    // 1) í•˜ìœ„ ì½¤ë³´ë“¤ "ë¨¼ì €" ì´ˆê¸°í™” + ë¹„í™œì„±í™” + ê°’ ë¹„ìš°ê¸°
    const companyAPI = getComboAPI('companyCombo');
    const poeAPI     = getComboAPI('poeCombo');
    const cargoAPI   = getComboAPI('cargoTypeCombo');

    companyAPI.setItems([]); companyAPI.setValue?.(''); companyAPI.enable(false);
    poeAPI.setItems([]);     poeAPI.setValue?.('');     poeAPI.enable(false);
    cargoAPI.setItems([]);   cargoAPI.setValue?.('');   cargoAPI.enable(false);

    // 2) ì§€ì—­ ê¸°ë°˜ìœ¼ë¡œ ì—…ì²´ ì¬ë¡œë”© (ì—¬ê¸°ì„œ companies ìˆìœ¼ë©´ enable(true) ë¨)
    await loadCompanies();

    // 3) ì§€ë„ ì¤Œ ì²˜ë¦¬
    const region = getRegion();
    if (region) zoomToRegion(region, { fallbackZoom: 10 });
    });


    // ì—…ì²´(íŒŒíŠ¸ë„ˆ) ë³€ê²½
    compEl?.addEventListener('change', async ()=>{
    const poeAPI   = getComboAPI('poeCombo');
    const cargoAPI = getComboAPI('cargoTypeCombo');

    // âœ… ì„ íƒê°’ë§Œ ì´ˆê¸°í™”(ì•„ì´í…œ/í™œì„± ìƒíƒœëŠ” ìœ ì§€)
    poeAPI.setValue?.('');
    cargoAPI.setValue?.('');

    // ìƒˆ íŒŒíŠ¸ë„ˆ ê¸°ì¤€ìœ¼ë¡œ ëª©ë¡ ê°±ì‹  (ì ê¹ ë¡œë”©ë  ìˆ˜ ìˆìŒ)
    await loadPOEs();                 // ëë‚˜ë©´ ì•„ì´í…œ ì¬ì„¸íŒ… + enable(ì¡°ê±´ë¶€)
    await loadCargoTypes_forPartner();
    });


  // ì¡°íšŒ ë²„íŠ¼
  document.getElementById('btnFetch')?.addEventListener('click', async (ev)=>{
    ev.preventDefault();                // í¼ ê¸°ë³¸ë™ì‘ ë°©ì§€(ì•ˆì „)
    const btn = ev.currentTarget;
    if (btn.disabled) return;           // ì¤‘ë³µ í´ë¦­ ë°©ì§€
    btn.disabled = true;
  
    try{
      const country = getValue_soft('countryCombo');
      const region  = getValue_soft('regionCombo');
      const company = getValue_soft('companyCombo');
      const type    = getValue_soft('typeCombo') || '20FT';
      const cbmSel  = document.getElementById('cbmSelect');
      const cbm     = cbmSel?.value ? Number(cbmSel.value) : undefined;
      const cargo   = getValue_soft('cargoTypeCombo');
  
      if (!country){ alert('êµ­ê°€ë¥¼ ì„ íƒí•˜ì„¸ìš”.'); return; }
      if (!company){ alert('ì—…ì²´ë¥¼ ì„ íƒí•˜ì„¸ìš”.'); return; }
  
      const roles = cargo ? [cargo.toUpperCase()] : [];
      const params = new URLSearchParams();
      params.set('type', type);
      params.set('company', company);
      if (region) params.set('region', region);
      if (roles.length) params.set('roles', roles.join(','));
      if (!isNaN(cbm)) params.set('cbm', String(cbm));
  
      const url = `${BASE}/api/costs/${encodeURIComponent(country)}?${params.toString()}`;
      const res = await fetch(url, { cache:'no-store' });
      const j   = await res.json();
      
      // ìš°ì„  ì‘ë‹µì˜ numberFormats ë³´ê´€
      __numberFormats = j?.numberFormats || {};
      
      // ì„ íƒí•œ íƒ€ì…(20FT/40HC/CONSOLE)ì— íŠ¹í™”ëœ í†µí™”ì½”ë“œ ìš°ì„  ì¶”ì¶œ
      const typeCurrency =
        (j?.currencyByType?.[type])
        || (j?.meta?.currencyByType?.[type])
        || (j?.columns?.[type]?.currency || j?.columns?.[type]?.currencyCode)
        || (j?.headers?.[type]?.currency || j?.headers?.[type]?.currencyCode)
        || '';
      
      // ì „ì—­ ê¸°ë³¸ í†µí™”: ì‘ë‹µ ì „ì—­ â†’ íƒ€ì…ë³„ â†’ ë©”íƒ€ ìˆœìœ¼ë¡œ ì±„íƒ
      __defaultCurrency = (
        j?.currency
        || j?.currencyCode
        || typeCurrency
        || j?.meta?.currency
        || j?.meta?.currencyCode
        || ''
      ).toString();
      
      // ê·¸ë˜ë„ ë¹„ì–´ ìˆìœ¼ë©´, í¬ë§· í…ìŠ¤íŠ¸ë¥¼ ìŠ¤ìº”í•´ì„œ ì¶”ë¡ (USD/KRW/EUR)
      if (!__defaultCurrency){
        const probe = [
          getFmt(type),           // í˜„ì¬ ì„ íƒ íƒ€ì…ì˜ í¬ë§·
          getFmt('20FT'),
          getFmt('40HC'),
          getFmt('CONSOLE')
        ].join(' ');
        if (/usd|dollar/i.test(probe)) __defaultCurrency = 'USD';
        else if (/krw|won/i.test(probe)) __defaultCurrency = 'KRW';
        else if (/eur|euro/i.test(probe)) __defaultCurrency = 'EUR';
      }

      renderTable(j, type, Boolean(region));
      showResultSection(true);
      document.getElementById('resultSection')?.classList.add('show');
      document.querySelector('.action-row.center')?.classList.add('show','revealed');
  
      // âœ… ì ‘ê³  ìš”ì•½ ë…¸ì¶œ
      await fillAndShowSummary({ country, region, cbm, type, company });
    }catch(e){
      console.error(e);
      alert('ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }finally{
      btn.disabled = false;
    }
  });
}

/* ============================================================================
   7) ì´ˆê¸°í™” (ë‹¨ í•œ ë²ˆ)
   - ì§€ë„ ì´ˆê¸°í™”
   - ê³ ì • ì˜µì…˜ ì„¸íŒ…(type/CBM)
   - êµ­ê°€ ëª©ë¡ ë¡œë”©
   - ë°”ì¸ë”©
   - ì´ˆê¸° ê°’ ìˆì—ˆë‹¤ë©´ ì§€ë„/í™”ë¬¼íƒ€ì… ì„ ë°˜ì˜
   ========================================================================== */
window.addEventListener('DOMContentLoaded', async ()=>{
  // ì§€ë„
  try{ await initAlwaysOnMap(); }catch(_){}

  // ê³ ì • ì˜µì…˜
  setTypeComboFixed();   // 20FT / 40HC / CONSOLE
  setCBMRange();         // 1 ~ 60 (placeholder ìœ ì§€)

  // êµ­ê°€ ë¡œë”© + ë°”ì¸ë”©
  await loadCountries();
  wireEvents();

  // ì´ˆê¸° êµ­ê°€ê°€ ìˆìœ¼ë©´ ì§€ë„ ë°˜ì˜
  const initialCountry = getCountry();
  if (initialCountry) setMapCountry(initialCountry);

  // ì´ˆê¸° íŒŒíŠ¸ë„ˆê°€ ìˆìœ¼ë©´ í™”ë¬¼íƒ€ì… ì„ ë¡œë”©
  loadCargoTypes_forPartner();
  
  // ìš”ì•½ ë°” í´ë¦­ â†’ ë‹¤ì‹œ í¼ì¹˜ê¸°
  const sumEl = document.getElementById('collapsedSummary');
  if (sumEl) {
    sumEl.addEventListener('click', (e)=>{
      // ë°©ê¸ˆ ì ‘íŒ ì§í›„ ê°™ì€ í´ë¦­ì´ ì „íŒŒë˜ëŠ” ê²½ìš° ì°¨ë‹¨
      if (__summaryClickLocked) return;
      if (performance.now() - __justCollapsedAt < 450) {
        e.preventDefault();
        e.stopPropagation();
        return;
      }
      // âœ… ì˜¤ì§ ìš”ì•½ í´ë¦­ì—ì„œë§Œ í™•ì‹¤íˆ ì—´ê¸°
      __allowExpand = true;         // âœ… ì´ë•Œë§Œ í¼ì¹¨ í—ˆìš©
      showResultSection(false);
      expandShell().then(()=>{
        sumEl.hidden = true; // ìš”ì•½ ìˆ¨ê¹€
        document.querySelector('.app-shell')?.scrollIntoView({behavior:'smooth', block:'start'});
      });
    });
  }
});

function showResultSection(show){
  const sec = document.getElementById('resultSection');
  if(!sec) return;
  if(show){
    sec.hidden = false;
    sec.classList.add('show');
  }else{
    sec.classList.remove('show');
    sec.hidden = true;
  }
}

function showCollapsedPanel(show){
  const panel = document.getElementById('collapsedPanel');
  panel.hidden = !show;
}

</script>

</body>
</html>
