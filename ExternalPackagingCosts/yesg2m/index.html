<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>YESG2M ê°€ê²© ì¡°íšŒ</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../../common/header/header.css">
  <link rel="stylesheet" href="../main.css">
</head>
<body>
<div id="header-placeholder"></div>

<div class="main-layout">

  <div class="notice">
      <h3 style="margin-top:0; font-weight:800;">í™•ì¸ì‚¬í•­</h3>
      <div class="notice-list" id="notice-list-container">
          <div style="color:#999; font-size:0.9rem;">ì¡°íšŒ í›„ í™•ì¸ì‚¬í•­ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
      </div>
  </div>

  <div class="vertical-divider"></div>

  <div class="main-wrap">
      <h1 class="main-title">YESG2M í¬ì¥ ë¹„ìš© ê³„ì‚°</h1>
      <div class="title-cost-divider"></div>
      <div class="controls">
          <div class="field">
              <label for="Shipping-Address">í¬ì¥ì§€ ì£¼ì†Œ</label>
              <input type="text" id="Shipping-Address" placeholder="ë„ë¡œëª… ì£¼ì†Œ í˜¹ì€ ì¸ë³´ì´ìŠ¤ìƒ ì£¼ì†Œ ë¶™ì—¬ë„£ê¸°">
          </div>
          <div class="field">
              <label for="Packed-CBM">í¬ì¥ CBM</label>
              <div class="combo" id="Packed-CBM">
                  <input type="text" id="Packed-CBM-input" placeholder="CBMì…ë ¥" auotocomplete="off">
              </div>
          </div>
            <button class="btn" id="btnFetch">ì¡°íšŒ</button>
      </div>


      <div class="result-container">
        <div class="sub-title-divider">ê¸°ë³¸ ë°œìƒ ë¹„ìš©</div>
        <div class="cost-title">ë°©ë¬¸ ê²¬ì ë¹„
          <span id="survey-fee" class="cost-value">-</span>
        </div>

        <div class="cost-title">í¬ì¥ ì‘ì—…ë¹„
          <span id="packing-fee" class="cost-value">-</span>
        </div>

        <div class="cost-title">ì§€ì—­ ì¶œì¥ë¹„
          <span id="travel-fee" class="cost-value">-</span>
        </div>

        <div class="cost-title">EV+ì…”í‹€ ì‘ì—…ë¹„
          <span id="ev-shuttle-stair-fee" class="cost-value">-</span>
        </div>
        
        <div class="sub-title-divider">ë³„ë„ ì¶”ê°€ ë¹„ìš©</div>

        <div class="cost-title">WOODEN CRATE
          <span id="wooden-crate-fee" class="cost-value">-</span>
        </div>

        <div class="cost-title">ì°½ê³  ë³´ê´€ë£Œ
          <span id="storage-fee" class="cost-value">-</span>
        </div>

        <div class="cost-title">ë³´ê´€í™”ë¬¼ ìƒ/í•˜ì°¨ ë¹„ìš©
          <span id="loading-unloading-fee" class="cost-value">-</span>
        </div>
      </div>
    </div>
  </div>

<!--â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€í•´ë” htmlë¡œë“œ ë° css ë¡œë“œ ì‹œì‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-->
<script>
  fetch("https://arrrbang.github.io/pumex/common/header/header.html")
    .then(res => res.text())
    .then(html => {
      document.getElementById("header-placeholder").innerHTML = html;

      // ğŸ”¥ í—¤ë”ê°€ DOMì— ì‚½ì…ëœ ì‹œì ì—ì„œ header.js ì‹¤í–‰
      const s = document.createElement("script");
      s.src = "https://arrrbang.github.io/pumex/common/header/header.js";
      document.body.appendChild(s);
    });
</script>
<script src="../../common/js/login.js"></script>
<!--â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ë³¸ í˜ì´ì§€ script ì‹œì‘ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-->
<script>
    const API_BASE = "https://notion-api-hub.vercel.app"; 

    function formatMoney(num) {
        if (num === undefined || num === null) return "-";
        return num.toLocaleString('ko-KR') + " ì›";
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // [NEW] í™•ì¸ì‚¬í•­ ë Œë”ë§ (ë…¸ì…˜ í…ìŠ¤íŠ¸ íŒŒì‹±)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderNotices(notices) {
        const container = document.getElementById('notice-list-container');
        container.innerHTML = ''; 

        if (!notices || notices.length === 0) {
            container.innerHTML = '<div style="color:#999;">í‘œì‹œí•  í™•ì¸ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        notices.forEach(notice => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'notice-item';

            // ì œëª© í—¤ë”
            const headerBtn = document.createElement('button');
            headerBtn.className = 'notice-header';
            headerBtn.innerHTML = `<span class="toggle-icon">â–¶</span> ${notice.title}`;

            // ë‚´ìš© ì»¨í…Œì´ë„ˆ
            const contentDiv = document.createElement('div');
            contentDiv.className = 'notice-content';

            if (notice.content) {
                // 1. ì¤„ë°”ê¿ˆ(\n)ìœ¼ë¡œ ë¶„ë¦¬
                const lines = notice.content.split('\n').filter(line => line.trim() !== '');
                
                // 2. ê° ì¤„ ë¶„ì„ ( [ìˆ«ì] ë¡œ ì‹œì‘í•˜ëŠ”ì§€ í™•ì¸ )
                const formattedHtml = lines.map(line => {
                    const trimmed = line.trim();
                    // ì •ê·œì‹: ëŒ€ê´„í˜¸+ìˆ«ì+ëŒ€ê´„í˜¸ ë¡œ ì‹œì‘í•˜ëŠ”ì§€ ì²´í¬ (ì˜ˆ: [1], [10] ë“±)
                    // match[1] = "[1]", match[2] = ë‚˜ë¨¸ì§€ í…ìŠ¤íŠ¸
                    const match = trimmed.match(/^(\[\d+\])\s*(.*)/);

                    if (match) {
                        // [n] í˜•ì‹ì¸ ê²½ìš° -> ë¶„ë¦¬í•´ì„œ ë Œë”ë§
                        return `
                            <div class="notice-line">
                                <span class="notice-num">${match[1]}</span>
                                <span class="notice-text">${match[2]}</span>
                            </div>
                        `;
                    } else {
                        // [n] í˜•ì‹ì´ ì—†ëŠ” ì¼ë°˜ í…ìŠ¤íŠ¸ì¸ ê²½ìš° -> ì „ì²´ë¥¼ í…ìŠ¤íŠ¸ë¡œ
                        return `
                            <div class="notice-line">
                                <span class="notice-text">${trimmed}</span>
                            </div>
                        `;
                    }
                }).join('');
                
                contentDiv.innerHTML = formattedHtml;
            } else {
                contentDiv.innerHTML = '<div class="notice-line"><span class="notice-text">ë‚´ìš© ì—†ìŒ</span></div>';
            }

            // í† ê¸€ ì´ë²¤íŠ¸
            headerBtn.addEventListener('click', () => {
                const isOpen = contentDiv.classList.contains('open');
                if (isOpen) {
                    contentDiv.classList.remove('open');
                    headerBtn.classList.remove('active');
                } else {
                    contentDiv.classList.add('open');
                    headerBtn.classList.add('active');
                }
            });

            itemDiv.appendChild(headerBtn);
            itemDiv.appendChild(contentDiv);
            container.appendChild(itemDiv);
        });
    }

    const btnFetch = document.getElementById('btnFetch');
    btnFetch.addEventListener('click', async () => {
        const address = document.getElementById('Shipping-Address').value.trim();
        const cbm = document.getElementById('Packed-CBM-input').value;

        if (!address) return alert("ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        if (!cbm) return alert("CBMì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        btnFetch.disabled = true; 
        btnFetch.textContent = "ë¡œë”© ì¤‘...";
        
        // ê²°ê³¼ê°’ ì´ˆê¸°í™”
        const ids = ['survey-fee','packing-fee','travel-fee','ev-shuttle-stair-fee','wooden-crate-fee','storage-fee','loading-unloading-fee'];
        ids.forEach(id => {
            const el = document.getElementById(id);
            if(el) { el.innerText = "ë¡œë”© ì¤‘..."; el.classList.add('empty'); }
        });
        document.getElementById('notice-list-container').innerHTML = '<div style="color:#999;">ë¡œë”© ì¤‘...</div>';

        try {
            const response = await fetch(`${API_BASE}/api/yesg2m/calculate`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ address, cbm })
            });
            const result = await response.json();

            if (result.ok) {
                const d = result.data;
                document.getElementById('survey-fee').innerText = formatMoney(d.surveyFee);
                document.getElementById('packing-fee').innerText = formatMoney(d.packingFee);
                document.getElementById('travel-fee').innerText = formatMoney(d.travelFee);
                document.getElementById('ev-shuttle-stair-fee').innerText = formatMoney(d.shuttleFee);
                document.getElementById('wooden-crate-fee').innerText = formatMoney(d.woodenCrateFee);
                document.getElementById('storage-fee').innerText = formatMoney(d.storageFee);
                document.getElementById('loading-unloading-fee').innerText = formatMoney(d.loadingUnloadingFee);
                
                ids.forEach(id => document.getElementById(id).classList.remove('empty'));
                renderNotices(d.notices);
            } else {
                alert("ì˜¤ë¥˜: " + result.error);
                resetDisplay();
            }
        } catch (e) {
            console.error(e);
            alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜");
            resetDisplay();
        } finally {
            btnFetch.disabled = false;
            btnFetch.textContent = "ì¡°íšŒ";
        }
    });

    function resetDisplay() {
        const ids = ['survey-fee','packing-fee','travel-fee','ev-shuttle-stair-fee','wooden-crate-fee','storage-fee','loading-unloading-fee'];
        ids.forEach(id => document.getElementById(id).innerText = "-");
        document.getElementById('notice-list-container').innerHTML = '<div style="color:#999;">ì¡°íšŒ í›„ í™•ì¸ì‚¬í•­ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>';
    }
</script>
</body>
</html>
